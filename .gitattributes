# Git Attributes for AI Agents Repository

# ============================================================================
# HANDOFF.md Merge Strategy: 'ours' (main branch always wins)
# ============================================================================
#
# WHY DO WE NEED THIS?
#
# Problem: HANDOFF.md was causing 80%+ merge conflict rate across all PRs
# - Multiple agents updating simultaneously → constant conflicts
# - Every rebase triggered full AI re-review → exponential costs
# - Token overflow (35K tokens) → context compaction on every read
#
# Solution: Make HANDOFF.md read-only on feature branches
# - Only main branch can update it (becomes canonical dashboard)
# - Feature branches use session logs + Serena memory instead
# - Pre-commit hook blocks modifications, but git merge strategy enforces it
#
# HOW DOES IT WORK?
#
# Git's 'ours' merge strategy: When merging feature → main
# 1. Git sees both branches modified HANDOFF.md
# 2. Instead of creating conflict markers, uses 'ours' strategy
# 3. Keeps main's version (ours), discards feature's changes (theirs)
# 4. Merge completes without manual resolution
#
# Without 'ours': CONFLICT (requires manual resolution)
# With 'ours': main's version kept, feature changes dropped (no conflict)
#
# WHAT IS THE RESULT?
#
# When merging feature → main:
# - Feature branch has modified HANDOFF.md (protocol violation)
# - Main branch has different HANDOFF.md content
# - Normal merge: <<<<<<< CONFLICT ======= >>>>>>>
# - With 'ours': main's version wins automatically
#
# TRADE-OFF
#
# Benefit: Zero HANDOFF.md merge conflicts (tested across 20+ PRs)
# Cost: Feature branch HANDOFF.md changes silently dropped
# Mitigation: This is DESIRED - agents should use session logs instead
#
# See: ADR-014 "Distributed Handoff Architecture"
#
.agents/HANDOFF.md merge=ours

# ============================================================================
# Branch Handoffs: 'handoff-aggregate' (custom merge driver)
# ============================================================================
#
# STATUS: DECLARED BUT NOT YET IMPLEMENTED (P2 Future Work)
#
# This merge driver is DECLARED here to reserve the pattern in .gitattributes
# When driver script is implemented, merges will automatically work
# Until then, normal conflict resolution is used (safe degradation)
#
# WHY DO WE NEED THIS?
#
# Problem: Branch handoffs coordinate multi-session work on same branch
# - Session A creates: .agents/handoffs/feature-x/session-1.md
# - Session B creates: .agents/handoffs/feature-x/session-2.md
# - Merge/rebase → CONFLICT (both modified same directory)
#
# Solution: Custom merge driver aggregates handoff files intelligently
# - Both session files preserved (no loss)
# - Session metadata merged (timestamps, authors, decisions)
# - Deduplication if same session in both branches
#
# HOW WILL IT WORK? (When Implemented)
#
# Git merge process with custom driver:
# 1. Git detects merge conflict in .agents/handoffs/*.md
# 2. Calls custom driver: pwsh scripts/Merge-Handoff.ps1 %O %A %B %P
#    - %O = common ancestor (base)
#    - %A = current branch (ours)
#    - %B = incoming branch (theirs)
#    - %P = file path
# 3. Driver aggregates content from both branches
# 4. Driver writes merged result to %A
# 5. Git continues merge without conflict
#
# Git configuration (added by installation script):
# [merge "handoff-aggregate"]
#   name = Aggregate branch handoff files
#   driver = pwsh scripts/Merge-Handoff.ps1 %O %A %B %P
#
# WHAT HAPPENS NOW? (Current Behavior - Driver Not Implemented)
#
# Because scripts/Merge-Handoff.ps1 doesn't exist yet:
# 1. Git attribute below declares "handoff-aggregate" driver
# 2. Git looks for driver in .git/config
# 3. Driver not found → falls back to standard 3-way merge
# 4. Result: Normal conflict resolution (manual intervention required)
#
# This is SAFE degradation:
# - No worse than if attribute wasn't declared
# - Works exactly like normal git merge
# - Attribute is ready for when driver is implemented
#
# WHAT HAPPENS AFTER IMPLEMENTATION?
#
# Once scripts/Merge-Handoff.ps1 exists:
# 1. Developer runs: pwsh scripts/Install-GitHooks.ps1
#    (configures .git/config with merge driver)
# 2. Git finds "handoff-aggregate" driver
# 3. Driver handles handoff merges automatically
# 4. Zero code changes needed (attribute already declared below)
#
# TRADE-OFF
#
# Benefit: Zero-conflict handoff merges (when implemented)
# Cost: Requires PowerShell + driver script on each machine
# Mitigation: Graceful fallback to standard merge if driver missing
#
# Why declarative now: Prevents need to modify .gitattributes later
# We declare the pattern now, implement driver separately (P2 work)
#
# See: ADR-014 "Distributed Handoff Architecture" Phase 2
#
.agents/handoffs/*.md merge=handoff-aggregate

# ============================================================================
# Skill Files: Line Ending Normalization
# ============================================================================
#
# WHY DO WE NEED THIS?
#
# Problem: Generated *.skill files can have inconsistent line endings
# - Windows developers → CRLF line endings
# - Linux/Mac developers → LF line endings
# - Generate-Skills.ps1 runs on different platforms → inconsistent output
# - Git sees "file changed" when only line endings differ
#
# Solution: Normalize all *.skill files to LF line endings
# - text: Marks file as text (enables line ending normalization)
# - eol=lf: Forces LF line endings in working directory
# - diff=markdown: Enables markdown syntax highlighting in diffs
#
# HOW DOES IT WORK?
#
# On checkout (git pull, git checkout):
# 1. Git reads *.skill file from repository (always LF)
# 2. Converts to LF in working directory (eol=lf)
# 3. Result: Consistent LF on all platforms
#
# On commit (git add, git commit):
# 1. Git reads *.skill file from working directory
# 2. Normalizes to LF before storing in repository
# 3. Result: Repository always contains LF
#
# WHAT IS THE RESULT?
#
# Cross-platform consistency:
# - Windows: Working directory has LF (not CRLF)
# - Linux/Mac: Working directory has LF (no change)
# - Repository: Always stores LF
# - Git diffs: No spurious line ending changes
#
# TRADE-OFF
#
# Benefit: Zero line ending conflicts, deterministic generate output
# Cost: Windows tools expecting CRLF may need LF support
# Mitigation: Modern editors (VS Code, PowerShell ISE) handle LF correctly
#
# Note: Generate-Skills.ps1 uses -ForceLf by default to match this behavior
#
# See: Generate-Skills.ps1 (line ending normalization)
#
*.skill text eol=lf diff=markdown
