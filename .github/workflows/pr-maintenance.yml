name: PR Maintenance

on:
  schedule:
    - cron: '0 * * * *'  # Hourly at minute 0 (UTC)
  workflow_dispatch:     # Manual trigger
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        type: boolean
        default: true
      max_prs:
        description: 'Max PRs to process'
        type: number
        default: 20

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: pr-maintenance
  cancel-in-progress: false

env:
  PR_PROTECTED_BRANCHES: "main,master,develop"
  PR_BOT_AUTHORS: "Copilot,coderabbitai[bot],gemini-code-assist[bot],cursor[bot]"
  PR_ACK_REACTION: "eyes"
  PR_MAX_PRS: ${{ inputs.max_prs || 20 }}

jobs:
  pr-maintenance:
    # ADR-014: Use ARM runners for 37.5% cost reduction
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
        with:
          fetch-depth: 0

      - name: Validate environment
        shell: pwsh
        run: |
          Import-Module ./.github/scripts/PRMaintenanceModule.psm1
          $result = Test-WorkflowEnvironment
          $result.SummaryMarkdown | Out-File $env:GITHUB_STEP_SUMMARY -Append

      - name: Check API rate limit
        id: ratelimit
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        shell: pwsh
        run: |
          Import-Module ./.github/scripts/PRMaintenanceModule.psm1
          $result = Test-WorkflowRateLimit
          $result.SummaryMarkdown | Out-File $env:GITHUB_STEP_SUMMARY -Append
          "core_remaining=$($result.CoreRemaining)" | Out-File $env:GITHUB_OUTPUT -Append
          if (-not $result.Success) { exit 1 }

      - name: Run PR maintenance
        id: maintenance
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        shell: pwsh
        run: |
          $inputValue = '${{ inputs.dry_run }}'
          $dryRun = if ($inputValue -eq 'false') { $false } else { $true }
          $params = @{ MaxPRs = [int]'${{ env.PR_MAX_PRS }}'; LogPath = '.agents/logs/pr-maintenance.log' }
          if ($dryRun) { $params['DryRun'] = $true }
          ./scripts/Invoke-PRMaintenance.ps1 @params

      - name: Parse results and post summary
        id: results
        if: always()
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        shell: pwsh
        run: |
          Import-Module ./.github/scripts/PRMaintenanceModule.psm1
          $results = Get-MaintenanceResults -LogPath '.agents/logs/pr-maintenance.log'
          $coreRemaining = (gh api rate_limit --jq '.resources.core.remaining')
          $runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          $inputValue = '${{ inputs.dry_run }}'
          $dryRun = $inputValue -ne 'false'
          $summary = New-MaintenanceSummary -Results $results -DryRun $dryRun -CoreRemaining $coreRemaining -RunUrl $runUrl
          $summary | Out-File $env:GITHUB_STEP_SUMMARY -Append
          "processed=$($results.Processed)" | Out-File $env:GITHUB_OUTPUT -Append
          "has_blocked=$($results.HasBlocked.ToString().ToLower())" | Out-File $env:GITHUB_OUTPUT -Append
          if ($results.HasBlocked) { $results.BlockedPRs -join "`n" | Out-File blocked-prs.txt }

      - name: Create alert issue for blocked PRs
        if: steps.results.outputs.has_blocked == 'true'
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        shell: pwsh
        run: |
          Import-Module ./.github/scripts/PRMaintenanceModule.psm1
          $blockedPRs = Get-Content blocked-prs.txt
          $runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          $body = New-BlockedPRsAlertBody -BlockedPRs $blockedPRs -RunUrl $runUrl
          ./.claude/skills/github/scripts/issue/New-Issue.ps1 -Title "[PR Maintenance] Blocked PRs Require Human Action" -Body $body -Labels "automation,needs-triage"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 # v4
        with:
          name: pr-maintenance-logs
          path: .agents/logs/pr-maintenance*.log
          retention-days: 30

      - name: Notify on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        shell: pwsh
        run: |
          Import-Module ./.github/scripts/PRMaintenanceModule.psm1
          $runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          $body = New-WorkflowFailureAlertBody -RunUrl $runUrl -TriggerEvent '${{ github.event_name }}'
          ./.claude/skills/github/scripts/issue/New-Issue.ps1 -Title "[ALERT] PR Maintenance Workflow Failed" -Body $body -Labels "automation,P1"
