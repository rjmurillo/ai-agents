name: PR Maintenance

on:
  schedule:
    - cron: '0 * * * *'  # Hourly at minute 0 (UTC)
  workflow_dispatch:     # Manual trigger
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        type: boolean
        default: true
      max_prs:
        description: 'Max PRs to process'
        type: number
        default: 20

permissions:
  # contents: write - Required for git operations (conflict resolution, branch updates)
  # pull-requests: write - Required for posting comments and reactions
  # issues: write - Required for creating alert issues on failures
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: pr-maintenance
  cancel-in-progress: false  # Queue runs, don't cancel

env:
  PR_PROTECTED_BRANCHES: "main,master,develop"
  PR_BOT_AUTHORS: "Copilot,coderabbitai[bot],gemini-code-assist[bot],cursor[bot]"
  PR_ACK_REACTION: "eyes"
  PR_MAX_PRS: ${{ inputs.max_prs || 20 }}

jobs:
  pr-maintenance:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Validate environment
        run: |
          echo "### Environment Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PWSH_VERSION=$(pwsh --version | grep -oP '\d+\.\d+')
          echo "- PowerShell: $PWSH_VERSION" >> $GITHUB_STEP_SUMMARY

          GH_VERSION=$(gh --version | head -1 | grep -oP '\d+\.\d+\.\d+')
          echo "- gh CLI: $GH_VERSION" >> $GITHUB_STEP_SUMMARY

          GIT_VERSION=$(git --version | grep -oP '\d+\.\d+')
          echo "- git: $GIT_VERSION" >> $GITHUB_STEP_SUMMARY

      - name: Check API rate limit
        id: ratelimit
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        shell: pwsh
        run: |
          # ADR-006: Use PowerShell for rate limit check (thin workflow pattern)
          # Reuse Test-RateLimitSafe logic from main script
          $rateLimitJson = gh api rate_limit 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Failed to fetch rate limits: $rateLimitJson"
            exit 1
          }

          $rateLimit = $rateLimitJson | ConvertFrom-Json
          $thresholds = @{
            'core' = 100
            'search' = 15
            'code_search' = 5
            'graphql' = 100
          }

          # Build summary table
          "### API Rate Limit Status" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "| Resource | Remaining | Threshold | Status |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "|----------|-----------|-----------|--------|" | Out-File -Append $env:GITHUB_STEP_SUMMARY

          $failed = $false
          foreach ($resource in $thresholds.Keys) {
            $remaining = $rateLimit.resources.$resource.remaining
            $threshold = $thresholds[$resource]
            $status = if ($remaining -lt $threshold) { $failed = $true; "❌ TOO LOW" } else { "✅ OK" }
            "| $resource | $remaining | $threshold | $status |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          }

          "core_remaining=$($rateLimit.resources.core.remaining)" | Out-File -Append $env:GITHUB_OUTPUT

          if ($failed) {
            Write-Error "One or more API rate limits too low"
            exit 1
          }


      - name: Run PR maintenance
        id: maintenance
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        shell: pwsh
        run: |
          # For scheduled runs, inputs.dry_run is empty - default to true for safety (ADR-015)
          $inputValue = '${{ inputs.dry_run }}'
          $dryRun = if ($inputValue -eq 'false') { $false } else { $true }
          $maxPRs = [int]'${{ env.PR_MAX_PRS }}'

          Write-Host "Running PR maintenance (DryRun: $dryRun, MaxPRs: $maxPRs)"

          $params = @{
            MaxPRs = $maxPRs
            LogPath = '.agents/logs/pr-maintenance.log'
          }

          if ($dryRun) {
            $params['DryRun'] = $true
          }

          ./scripts/Invoke-PRMaintenance.ps1 @params

      - name: Parse results
        id: results
        if: always()
        shell: pwsh
        run: |
          # Extract summary from log
          $log = Get-Content .agents/logs/pr-maintenance.log -Raw

          # Parse metrics
          if ($log -match 'PRs Processed: (\d+)') {
            $processed = $Matches[1]
            echo "processed=$processed" >> $env:GITHUB_OUTPUT
          }

          if ($log -match 'Comments Acknowledged: (\d+)') {
            $acknowledged = $Matches[1]
            echo "acknowledged=$acknowledged" >> $env:GITHUB_OUTPUT
          }

          if ($log -match 'Conflicts Resolved: (\d+)') {
            $resolved = $Matches[1]
            echo "resolved=$resolved" >> $env:GITHUB_OUTPUT
          }

          # Extract blocked PRs
          $blockedSection = $log -split 'Blocked PRs \(require human action\):' | Select-Object -Last 1
          $blockedList = $blockedSection -split '\n' |
            Where-Object { $_ -match 'PR #' } |
            ForEach-Object { $_.Trim() } |
            Out-String

          if ($blockedList) {
            # Save to file (multi-line output)
            $blockedList | Out-File -FilePath blocked-prs.txt
            echo "has_blocked=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "has_blocked=false" >> $env:GITHUB_OUTPUT
          }

      - name: Post summary
        if: always()
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        shell: pwsh
        run: |
          $summary = @"
          ## PR Maintenance Summary

          **Run Time**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
          **Dry Run**: ${{ inputs.dry_run }}

          | Metric | Value |
          |--------|-------|
          | PRs Processed | ${{ steps.results.outputs.processed || 'N/A' }} |
          | Comments Acknowledged | ${{ steps.results.outputs.acknowledged || '0' }} |
          | Conflicts Resolved | ${{ steps.results.outputs.resolved || '0' }} |

          "@

          if ('${{ steps.results.outputs.has_blocked }}' -eq 'true') {
            $blockedList = Get-Content blocked-prs.txt -Raw
            $summary += @"

          ### Blocked PRs (Require Human Action)

          ``````
          $blockedList
          ``````
          "@
          }

          $summary += @"

          ### Rate Limit After Run

          - Core API: $(gh api rate_limit --jq '.resources.core.remaining') remaining

          ---
          [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          "@

          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append

      - name: Create alert issue for blocked PRs
        if: steps.results.outputs.has_blocked == 'true'
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        shell: pwsh
        run: |
          $blockedList = Get-Content blocked-prs.txt -Raw
          
          $body = @"
          ## Blocked PRs

          The automated PR maintenance workflow encountered PRs that require human action:

          ``````
          $blockedList
          ``````

          **Action Required**: Review the listed PRs and address blocking issues.

          **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ---
          <sub>Powered by [PR Maintenance](https://github.com/rjmurillo/ai-agents) workflow</sub>
          "@
          
          ./.claude/skills/github/scripts/issue/New-Issue.ps1 `
            -Title "[PR Maintenance] Blocked PRs Require Human Action" `
            -Body $body `
            -Labels "automation,needs-triage"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 # v4
        with:
          name: pr-maintenance-logs
          path: .agents/logs/pr-maintenance*.log
          retention-days: 30  # Aligned with operational log retention (pester-tests, etc.)

      - name: Notify on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        shell: pwsh
        run: |
          $body = @"
          ## Workflow Failure

          The PR maintenance workflow failed during execution.

          **Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          **Trigger**: ${{ github.event_name }}
          **Time**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')

          **Action Required**: Investigate workflow logs and resolve the issue.

          ---
          <sub>Powered by [PR Maintenance](https://github.com/rjmurillo/ai-agents) workflow</sub>
          "@
          
          ./.claude/skills/github/scripts/issue/New-Issue.ps1 `
            -Title "[ALERT] PR Maintenance Workflow Failed" `
            -Body $body `
            -Labels "automation,P1"
