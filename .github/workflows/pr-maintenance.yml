name: PR Maintenance

on:
  schedule:
    - cron: '0 * * * *'  # Hourly at minute 0 (UTC)
  workflow_dispatch:     # Manual trigger
    inputs:
      max_prs:
        description: 'Max PRs to process'
        type: number
        default: 20
      process_conflicts:
        description: 'Auto-resolve merge conflicts'
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read  # Required for workflow status checks

concurrency:
  group: pr-maintenance
  cancel-in-progress: false

env:
  PR_MAX_PRS: ${{ inputs.max_prs || 20 }}

jobs:
  # Job 1: Discover PRs needing attention
  discover-prs:
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 10
    outputs:
      matrix: ${{ steps.discover.outputs.matrix }}
      has-prs: ${{ steps.discover.outputs.has-prs }}
      summary-json: ${{ steps.discover.outputs.summary }}

    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
        with:
          fetch-depth: 0

      - name: Check API rate limit
        id: ratelimit
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        shell: pwsh -NoProfile -Command "& '{0}'"
        run: |
          $limits = gh api rate_limit 2>&1 | ConvertFrom-Json
          $core = $limits.resources.core
          $graphql = $limits.resources.graphql
          Write-Host "Rate limits - Core: $($core.remaining)/$($core.limit), GraphQL: $($graphql.remaining)/$($graphql.limit)"

          if ($core.remaining -lt 100 -or $graphql.remaining -lt 50) {
            Write-Host "::error::Rate limit too low to proceed"
            exit 1
          }

          "core_remaining=$($core.remaining)" | Out-File $env:GITHUB_OUTPUT -Append

      - name: Discover PRs needing attention
        id: discover
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        shell: pwsh -NoProfile -Command "& '{0}'"
        run: |
          $result = ./scripts/Invoke-PRMaintenance.ps1 -MaxPRs ([int]'${{ env.PR_MAX_PRS }}') -OutputJson
          $parsed = $result | ConvertFrom-Json

          # Output for matrix - ALL PRs requiring action (for parallel processing)
          $actionPRs = @($parsed.prs)
          $matrixJson = @{ include = $actionPRs } | ConvertTo-Json -Compress -Depth 10
          "matrix=$matrixJson" | Out-File $env:GITHUB_OUTPUT -Append

          # Check if we have any PRs to process
          $hasPRs = $actionPRs.Count -gt 0
          "has-prs=$($hasPRs.ToString().ToLower())" | Out-File $env:GITHUB_OUTPUT -Append

          # Full summary for later steps
          "summary=$result" | Out-File $env:GITHUB_OUTPUT -Append

          Write-Host "Found $($parsed.summary.total) open PRs"
          Write-Host "Action Required: $($parsed.summary.actionRequired)"
          Write-Host "With Conflicts: $(@($actionPRs | Where-Object { $_.hasConflicts }).Count)"

      - name: Write step summary
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        shell: pwsh -NoProfile -Command "& '{0}'"
        run: |
          $json = '${{ steps.discover.outputs.summary }}'
          $parsed = $json | ConvertFrom-Json

          $summary = @"
          ## PR Discovery Summary

          | Metric | Count |
          |--------|-------|
          | Open PRs Scanned | $($parsed.summary.total) |
          | PRs Need Action | $($parsed.summary.actionRequired) |
          | Blocked (human) | $($parsed.summary.blocked) |
          | Derivative PRs | $($parsed.summary.derivatives) |

          "@

          if ($parsed.prs.Count -gt 0) {
            $summary += @"

          ### PRs Requiring Action

          | PR | Category | Reason | Has Conflicts |
          |----|----------|--------|---------------|
          "@
            foreach ($pr in $parsed.prs) {
              $conflictIcon = if ($pr.hasConflicts) { ':warning:' } else { ':white_check_mark:' }
              $summary += "| #$($pr.number) | $($pr.category) | $($pr.reason) | $conflictIcon |`n"
            }
          }

          $summary | Out-File $env:GITHUB_STEP_SUMMARY -Append

  # Job 2: Process PRs in parallel (matrix strategy)
  process-prs:
    needs: discover-prs
    if: needs.discover-prs.outputs.has-prs == 'true'
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 30
    strategy:
      matrix: ${{ fromJson(needs.discover-prs.outputs.matrix) }}
      fail-fast: false
      max-parallel: 3

    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "rjmurillo-bot"
          git config user.email "rjmurillo-bot@users.noreply.github.com"

      - name: Resolve conflicts for PR #${{ matrix.number }}
        if: matrix.hasConflicts == true && (inputs.process_conflicts != false)
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        shell: pwsh -NoProfile -Command "& '{0}'"
        run: |
          Write-Host "Resolving conflicts for PR #${{ matrix.number }}"
          Write-Host "Branch: ${{ matrix.headRefName }} -> ${{ matrix.baseRefName }}"

          $result = ./.claude/skills/merge-resolver/scripts/Resolve-PRConflicts.ps1 `
            -PRNumber ${{ matrix.number }} `
            -BranchName '${{ matrix.headRefName }}' `
            -TargetBranch '${{ matrix.baseRefName }}'

          $parsed = $result | ConvertFrom-Json
          if ($parsed.Success) {
            Write-Host "::notice::PR #${{ matrix.number }}: Conflicts resolved successfully"
          } else {
            Write-Host "::warning::PR #${{ matrix.number }}: $($parsed.Message)"
          }

  # Job 3: Post-processing summary
  summarize:
    needs: [discover-prs, process-prs]
    if: always()
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Final summary
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        shell: pwsh -NoProfile -Command "& '{0}'"
        run: |
          $json = '${{ needs.discover-prs.outputs.summary-json }}'
          if (-not $json) {
            Write-Host "No discovery results available"
            exit 0
          }

          $parsed = $json | ConvertFrom-Json
          $actionRequired = @($parsed.prs | Where-Object { $_.category -eq 'agent-controlled' })

          if ($actionRequired.Count -gt 0) {
            $prNumbers = ($actionRequired | ForEach-Object { "#$($_.number)" }) -join ", "
            Write-Host "::notice::Action required for PRs: $prNumbers"
            Write-Host "Run: /pr-review $(($actionRequired | ForEach-Object { $_.number }) -join ',')"

            $summary = @"

          ---
          ### Next Steps

          The following PRs require manual review via ``/pr-review``:

          | PR | Reason | Action |
          |----|--------|--------|
          "@
            foreach ($pr in $actionRequired) {
              $summary += "| #$($pr.number) | $($pr.reason) | ``/pr-review $($pr.number)`` |`n"
            }

            $summary | Out-File $env:GITHUB_STEP_SUMMARY -Append
          }
