# Validate Planning Artifacts
#
# Ensures cross-document consistency in planning artifacts.
# Validates:
# - Effort estimate consistency (20% threshold)
# - Condition-to-task traceability (no orphan conditions)
#
# Related: Issue rjmurillo/ai-agents#I2, #I4 (Cross-Document Consistency)
# CodeRabbit PR rjmurillo/ai-agents#43 findings

name: Validate Planning Artifacts

on:
  push:
    branches:
      - main
      - 'feat/**'
      - 'fix/**'
      - 'copilot/**'
    paths:
      - '.agents/planning/**'
      - 'build/scripts/Validate-PlanningArtifacts.ps1'
      - '.github/workflows/validate-planning-artifacts.yml'
  pull_request:
    branches:
      - main
    paths:
      - '.agents/planning/**'
      - 'build/scripts/Validate-PlanningArtifacts.ps1'
      - '.github/workflows/validate-planning-artifacts.yml'
  workflow_dispatch: # Allow manual triggering

jobs:
  validate-planning:
    name: Validate Planning Artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate planning artifact consistency
        shell: pwsh
        run: |
          Write-Host "Validating planning artifact consistency..."
          ./build/scripts/Validate-PlanningArtifacts.ps1 -FailOnError

      - name: Show violations on failure
        if: failure()
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "=== Planning Artifact Validation Failed ===" -ForegroundColor Red
          Write-Host ""
          Write-Host "Planning documents have consistency issues that must be resolved." -ForegroundColor Yellow
          Write-Host ""
          Write-Host "Common issues:" -ForegroundColor Cyan
          Write-Host "  - Estimate divergence: Task estimates differ >20% from source epic/PRD" -ForegroundColor White
          Write-Host "  - Orphan conditions: Specialist conditions not linked to tasks" -ForegroundColor White
          Write-Host ""
          Write-Host "To fix:" -ForegroundColor Cyan
          Write-Host "  1. Review the violations reported above" -ForegroundColor White
          Write-Host "  2. For estimate divergence: Add '## Estimate Reconciliation' section" -ForegroundColor White
          Write-Host "  3. For orphan conditions: Add 'Conditions' column to Work Breakdown table" -ForegroundColor White
          Write-Host "  4. See src/claude/planner.md and src/claude/task-generator.md for templates" -ForegroundColor White
          Write-Host ""
