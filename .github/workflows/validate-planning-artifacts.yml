# Validate Planning Artifacts
#
# Ensures cross-document consistency in planning artifacts.
# Validates:
# - Effort estimate consistency (20% threshold)
# - Condition-to-task traceability (no orphan conditions)
#
# Related: Issue rjmurillo/ai-agents#I2, #I4 (Cross-Document Consistency)
# CodeRabbit PR rjmurillo/ai-agents#43 findings

name: Validate Planning Artifacts

on:
  push:
    branches:
      - main
      - 'feat/**'
      - 'fix/**'
      - 'copilot/**'
    paths:
      - '.agents/planning/**'
      - 'build/scripts/validate_planning_artifacts.py'
      - '.github/workflows/validate-planning-artifacts.yml'
  pull_request:
    branches:
      - main
    paths:
      - '.agents/planning/**'
      - 'build/scripts/validate_planning_artifacts.py'
      - '.github/workflows/validate-planning-artifacts.yml'
  workflow_dispatch: # Allow manual triggering

jobs:
  validate-planning:
    name: Validate Planning Artifacts
    # ADR-025: ARM runner for cost optimization (37.5% savings vs x64)
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Validate planning artifact consistency
        run: |
          echo "Validating planning artifact consistency..."
          python3 build/scripts/validate_planning_artifacts.py --fail-on-error

      - name: Show violations on failure
        if: failure()
        run: |
          echo ""
          echo "=== Planning Artifact Validation Failed ==="
          echo ""
          echo "Planning documents have consistency issues that must be resolved."
          echo ""
          echo "Common issues:"
          echo "  - Estimate divergence: Task estimates differ >20% from source epic/PRD"
          echo "  - Orphan conditions: Specialist conditions not linked to tasks"
          echo ""
          echo "To fix:"
          echo "  1. Review the violations reported above"
          echo "  2. For estimate divergence: Add '## Estimate Reconciliation' section"
          echo "  3. For orphan conditions: Add 'Conditions' column to Work Breakdown table"
          echo "  4. See src/claude/milestone-planner.md and src/claude/task-decomposer.md for templates"
          echo ""
