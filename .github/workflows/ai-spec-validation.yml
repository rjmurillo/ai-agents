name: Spec-to-Implementation Validation

# AI-powered requirements traceability using GitHub Copilot CLI
# Verifies that PR changes implement requirements from linked specs
# Warns if requirements are not covered by the implementation

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**'
      - 'scripts/**'
      - 'build/**'

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: spec-validation-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  GH_TOKEN: ${{ secrets.BOT_PAT }}

jobs:
  validate-spec:
    name: Validate Spec Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 0

      - name: Extract Spec References
        id: spec-ref
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Look for spec references in PR body and title
          # Patterns: REQ-NNN, DESIGN-NNN, TASK-NNN, .agents/specs/..., #issue
          SPEC_REFS=""

          # Check for requirement IDs
          REQ_IDS=$(echo "$PR_BODY $PR_TITLE" | grep -oP '(REQ|DESIGN|TASK)-\d+' | sort -u | tr '\n' ' ' || true)
          if [ -n "$REQ_IDS" ]; then
            SPEC_REFS="$REQ_IDS"
          fi

          # Check for spec file paths
          SPEC_PATHS=$(echo "$PR_BODY" | grep -oP '\.agents/specs/\S+\.md' | sort -u | tr '\n' ' ' || true)
          if [ -n "$SPEC_PATHS" ]; then
            SPEC_REFS="$SPEC_REFS $SPEC_PATHS"
          fi

          # Check for linked issues
          ISSUE_REFS=$(echo "$PR_BODY" | grep -oP '(Closes|Fixes|Resolves|Implements)\s*#\d+' | grep -oP '\d+' | sort -u | tr '\n' ' ' || true)

          echo "spec_refs=$SPEC_REFS" >> $GITHUB_OUTPUT
          echo "issue_refs=$ISSUE_REFS" >> $GITHUB_OUTPUT

          if [ -z "$SPEC_REFS" ] && [ -z "$ISSUE_REFS" ]; then
            echo "No spec references found in PR"
            echo "has_specs=false" >> $GITHUB_OUTPUT
          else
            echo "Found spec references: $SPEC_REFS"
            echo "Found issue references: $ISSUE_REFS"
            echo "has_specs=true" >> $GITHUB_OUTPUT
          fi

      - name: Load Spec Content
        if: steps.spec-ref.outputs.has_specs == 'true'
        id: load-spec
        env:
          SPEC_REFS: ${{ steps.spec-ref.outputs.spec_refs }}
          ISSUE_REFS: ${{ steps.spec-ref.outputs.issue_refs }}
        run: |
          SPEC_CONTENT=""

          # Load from spec files
          for ref in $SPEC_REFS; do
            # If it's a path, load directly
            if [[ "$ref" == *.md ]]; then
              if [ -f "$ref" ]; then
                SPEC_CONTENT="$SPEC_CONTENT"$'\n\n'"## Spec: $ref"$'\n\n'"$(cat "$ref")"
              fi
            else
              # Search for spec file by ID
              SPEC_FILE=$(find .agents/specs -name "*${ref}*" -type f 2>/dev/null | head -1 || true)
              if [ -n "$SPEC_FILE" ] && [ -f "$SPEC_FILE" ]; then
                SPEC_CONTENT="$SPEC_CONTENT"$'\n\n'"## Spec: $SPEC_FILE"$'\n\n'"$(cat "$SPEC_FILE")"
              fi
            fi
          done

          # Load from linked issues
          for issue in $ISSUE_REFS; do
            ISSUE_BODY=$(gh issue view "$issue" --json title,body -q '.title + "\n\n" + .body' 2>/dev/null || true)
            if [ -n "$ISSUE_BODY" ]; then
              SPEC_CONTENT="$SPEC_CONTENT"$'\n\n'"## Issue #$issue"$'\n\n'"$ISSUE_BODY"
            fi
          done

          if [ -z "$SPEC_CONTENT" ]; then
            echo "Warning: Could not load any spec content"
            SPEC_CONTENT="No spec content found for references: $SPEC_REFS $ISSUE_REFS"
          fi

          # Save to file for later steps
          echo "$SPEC_CONTENT" > /tmp/spec-content.md
          echo "spec_file=/tmp/spec-content.md" >> $GITHUB_OUTPUT

      - name: Prepare Spec Context
        if: steps.spec-ref.outputs.has_specs == 'true'
        id: prepare-context
        run: |
          # Create spec context string for additional-context input
          if [ -f /tmp/spec-content.md ]; then
            SPEC_CONTENT=$(cat /tmp/spec-content.md)
            {
              echo "spec_context<<EOF_SPEC"
              echo "## Specification Content"
              echo ""
              echo "$SPEC_CONTENT"
              echo "EOF_SPEC"
            } >> $GITHUB_OUTPUT
          else
            echo "spec_context=No spec content loaded" >> $GITHUB_OUTPUT
          fi

      - name: üîó Requirements Traceability Check (Analyst Agent)
        if: steps.spec-ref.outputs.has_specs == 'true'
        id: trace
        uses: ./.github/actions/ai-review
        with:
          agent: analyst
          context-type: pr-diff
          pr-number: ${{ github.event.pull_request.number }}
          additional-context: ${{ steps.prepare-context.outputs.spec_context }}
          prompt-file: .github/prompts/spec-trace-requirements.md
          timeout-minutes: 3
          bot-pat: ${{ secrets.BOT_PAT }}
          copilot-token: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      - name: ‚úÖ Completeness Check (Critic Agent)
        if: steps.spec-ref.outputs.has_specs == 'true'
        id: completeness
        uses: ./.github/actions/ai-review
        with:
          agent: critic
          context-type: pr-diff
          pr-number: ${{ github.event.pull_request.number }}
          additional-context: ${{ steps.prepare-context.outputs.spec_context }}
          prompt-file: .github/prompts/spec-check-completeness.md
          timeout-minutes: 3
          bot-pat: ${{ secrets.BOT_PAT }}
          copilot-token: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      - name: Generate Validation Report
        id: report
        env:
          HAS_SPECS: ${{ steps.spec-ref.outputs.has_specs }}
          SPEC_REFS: ${{ steps.spec-ref.outputs.spec_refs }}
          ISSUE_REFS: ${{ steps.spec-ref.outputs.issue_refs }}
          TRACE_VERDICT: ${{ steps.trace.outputs.verdict }}
          TRACE_FINDINGS: ${{ steps.trace.outputs.findings }}
          COMPLETENESS_VERDICT: ${{ steps.completeness.outputs.verdict }}
          COMPLETENESS_FINDINGS: ${{ steps.completeness.outputs.findings }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          SERVER_URL: ${{ github.server_url }}
          RUN_ID: ${{ github.run_id }}
          EVENT_NAME: ${{ github.event_name }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          source .github/scripts/ai-review-common.sh

          REPORT_FILE="$AI_REVIEW_DIR/spec-validation-report.md"

          # Helper function to get verdict emoji
          get_verdict_emoji() {
            case "$1" in
              PASS) echo "‚úÖ" ;;
              WARN|PARTIAL) echo "‚ö†Ô∏è" ;;
              CRITICAL_FAIL|REJECTED|FAIL) echo "‚ùå" ;;
              *) echo "‚ùî" ;;
            esac
          }

          if [ "$HAS_SPECS" != "true" ]; then
            cat > "$REPORT_FILE" << EOF
          <!-- AI-SPEC-VALIDATION -->

          ## üìê Spec-to-Implementation Validation

          > [!WARNING]
          > ‚ö†Ô∏è **No spec references found**
          >
          > This PR does not reference any specifications (REQ-*, DESIGN-*, TASK-*, or linked issues).

          <details>
          <summary>üìñ How to add spec references</summary>

          Add spec references to your PR description to enable traceability:

          | Method | Example |
          |:-------|:--------|
          | Reference requirements | \`Implements REQ-001\` |
          | Link issues | \`Closes #123\` |
          | Reference spec files | \`.agents/specs/requirements/...\` |

          </details>

          ---

          <sub>ü§ñ Powered by [AI Spec Validator](https://github.com/$GITHUB_REPOSITORY) ¬∑ *Validation skipped - no specs found*</sub>
          EOF
          else
            # Determine final verdict
            FINAL_VERDICT="PASS"
            if [ "$TRACE_VERDICT" = "CRITICAL_FAIL" ] || [ "$TRACE_VERDICT" = "FAIL" ] || \
               [ "$COMPLETENESS_VERDICT" = "CRITICAL_FAIL" ] || [ "$COMPLETENESS_VERDICT" = "FAIL" ]; then
              FINAL_VERDICT="FAIL"
            elif [ "$TRACE_VERDICT" = "WARN" ] || [ "$COMPLETENESS_VERDICT" = "WARN" ]; then
              FINAL_VERDICT="PARTIAL"
            fi

            ALERT_TYPE=$(get_verdict_alert_type "$FINAL_VERDICT")
            FINAL_EMOJI=$(get_verdict_emoji "$FINAL_VERDICT")
            TRACE_EMOJI=$(get_verdict_emoji "$TRACE_VERDICT")
            COMPLETENESS_EMOJI=$(get_verdict_emoji "$COMPLETENESS_VERDICT")

            cat > "$REPORT_FILE" << EOF
          <!-- AI-SPEC-VALIDATION -->

          ## üìê Spec-to-Implementation Validation

          > [!$ALERT_TYPE]
          > $FINAL_EMOJI **Final Verdict: $FINAL_VERDICT**

          <details>
          <summary>üìñ What is Spec Validation?</summary>

          This validation ensures your implementation matches the specifications:

          - **üîó Requirements Traceability**: Verifies PR changes map to spec requirements
          - **‚úÖ Implementation Completeness**: Checks all requirements are addressed

          </details>

          ### üìä Validation Summary

          | Check | Verdict | Status |
          |:------|:--------|:------:|
          | üîó Requirements Traceability | \`$TRACE_VERDICT\` | $TRACE_EMOJI |
          | ‚úÖ Implementation Completeness | \`$COMPLETENESS_VERDICT\` | $COMPLETENESS_EMOJI |

          ### üìé Spec References

          | Type | References |
          |:-----|:-----------|
          | üìÑ **Specs** | ${SPEC_REFS:-*None*} |
          | üîó **Issues** | ${ISSUE_REFS:-*None*} |

          EOF

            # Add traceability results
            cat >> "$REPORT_FILE" << 'SECTION_EOF'

          <details>
          <summary>üîó Requirements Traceability Details</summary>

          SECTION_EOF
            echo "" >> "$REPORT_FILE"
            if [ -n "$TRACE_FINDINGS" ]; then
              echo "$TRACE_FINDINGS" >> "$REPORT_FILE"
            else
              echo "No traceability output" >> "$REPORT_FILE"
            fi
            echo "" >> "$REPORT_FILE"
            echo "</details>" >> "$REPORT_FILE"

            # Add completeness results
            cat >> "$REPORT_FILE" << 'SECTION_EOF'

          <details>
          <summary>‚úÖ Implementation Completeness Details</summary>

          SECTION_EOF
            echo "" >> "$REPORT_FILE"
            if [ -n "$COMPLETENESS_FINDINGS" ]; then
              echo "$COMPLETENESS_FINDINGS" >> "$REPORT_FILE"
            else
              echo "No completeness output" >> "$REPORT_FILE"
            fi
            echo "" >> "$REPORT_FILE"
            echo "</details>" >> "$REPORT_FILE"

            # Add footer
            cat >> "$REPORT_FILE" << EOF

          ---

          <details>
          <summary>‚ÑπÔ∏è Run Details</summary>

          | Property | Value |
          |:---------|:------|
          | **Run ID** | [$RUN_ID]($SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_ID) |
          | **Triggered by** | \`$EVENT_NAME\` on \`$REF_NAME\` |

          </details>

          <sub>ü§ñ Powered by [AI Spec Validator](https://github.com/$GITHUB_REPOSITORY) ¬∑ [View Workflow]($SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_ID)</sub>
          EOF
          fi

          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT

      - name: Post PR Comment
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPORT_FILE: ${{ steps.report.outputs.report_file }}
        run: |
          source .github/scripts/ai-review-common.sh
          post_pr_comment "$PR_NUMBER" "$REPORT_FILE" "AI-SPEC-VALIDATION"

      - name: Set Job Summary
        env:
          REPORT_FILE: ${{ steps.report.outputs.report_file }}
        run: |
          cat "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY

      - name: Check for Failures
        if: steps.spec-ref.outputs.has_specs == 'true'
        env:
          TRACE_VERDICT: ${{ steps.trace.outputs.verdict }}
          COMPLETENESS_VERDICT: ${{ steps.completeness.outputs.verdict }}
        run: |
          if [ "$TRACE_VERDICT" = "CRITICAL_FAIL" ] || [ "$TRACE_VERDICT" = "FAIL" ] || \
             [ "$COMPLETENESS_VERDICT" = "CRITICAL_FAIL" ] || [ "$COMPLETENESS_VERDICT" = "FAIL" ]; then
            echo "::error::Spec validation failed - implementation does not fully satisfy requirements"
            exit 1
          fi

          echo "Spec validation passed"
