# Test CodeQL Integration
#
# Functional tests for CodeQL scripts that serve as documentation for how
# to use the custom CLI tooling. Each job demonstrates a real usage pattern.
#
# Usage Patterns Documented:
#   1. Install CLI once, validate config
#   2. Run scan for specific language
#   3. Run scan with JSON/SARIF output
#
# Local developers and AI agents use the same commands:
#   pwsh .codeql/scripts/Install-CodeQL.ps1  # One-time CLI setup
#   pwsh .codeql/scripts/Test-CodeQLConfig.ps1
#   pwsh .codeql/scripts/Invoke-CodeQLScan.ps1 -Languages python
#   pwsh .codeql/scripts/Invoke-CodeQLScan.ps1 -Format json

name: Test CodeQL Integration

on:
  pull_request:
    paths:
      - '.codeql/**'
      - '.github/codeql/**'
      - '.github/workflows/codeql-*.yml'
      - '.github/workflows/test-codeql-integration.yml'
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

# Concurrency control
concurrency:
  group: test-codeql-integration-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Pattern 1: Install CLI and validate configuration
  test-install-and-config:
    name: Install CLI & Validate Config
    # CodeQL CLI does not provide ARM64 Linux binaries, must use x64
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install zstd (required for CodeQL bundle extraction)
        run: |
          sudo apt-get update
          sudo apt-get install -y zstd

      # Usage: Install CodeQL CLI (one-time setup)
      - name: Install CodeQL CLI
        shell: pwsh
        run: |
          ./.codeql/scripts/Install-CodeQL.ps1 -CI -Force

      - name: Verify CodeQL CLI version
        shell: pwsh
        run: |
          $codeql = ".codeql/cli/codeql"
          if (-not (Test-Path $codeql)) {
            Write-Error "CodeQL CLI not found at: $codeql"
            exit 1
          }

          $version = & $codeql version
          Write-Host "CodeQL CLI installed: $version"

      # Usage: Validate configuration before running scans
      - name: Validate CodeQL configuration
        shell: pwsh
        run: |
          ./.codeql/scripts/Test-CodeQLConfig.ps1 -CI

  # Pattern 2: Run scan for a specific language
  test-scan-language:
    name: Scan Language (${{ matrix.language }})
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        # Note: PowerShell is not a supported CodeQL language
        # PowerShell scripts are analyzed via PSScriptAnalyzer instead
        language: [actions, python]

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install zstd
        run: sudo apt-get update && sudo apt-get install -y zstd

      - name: Install CodeQL CLI
        shell: pwsh
        run: ./.codeql/scripts/Install-CodeQL.ps1 -CI -Force

      # Usage: Scan specific language with console output
      - name: Run CodeQL scan for ${{ matrix.language }}
        shell: pwsh
        run: |
          ./.codeql/scripts/Invoke-CodeQLScan.ps1 -Languages "${{ matrix.language }}" -CI -Format console

      - name: Verify scan artifacts
        shell: pwsh
        env:
          LANGUAGE: ${{ matrix.language }}
        run: |
          # Verify database was created
          $dbPath = ".codeql/db/$env:LANGUAGE"
          if (-not (Test-Path $dbPath)) {
            Write-Error "Database not created: $dbPath"
            exit 1
          }
          Write-Host "Database created: $dbPath"

          # Verify SARIF output
          $sarifPath = ".codeql/results/$env:LANGUAGE.sarif"
          if (-not (Test-Path $sarifPath)) {
            Write-Error "SARIF not created: $sarifPath"
            exit 1
          }

          $sarif = Get-Content $sarifPath -Raw | ConvertFrom-Json
          Write-Host "SARIF created: $($sarif.runs[0].results.Count) findings"

  # Pattern 3: Run scan with JSON output format
  test-scan-json-output:
    name: Scan with JSON Output
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install zstd
        run: sudo apt-get update && sudo apt-get install -y zstd

      - name: Install CodeQL CLI
        shell: pwsh
        run: ./.codeql/scripts/Install-CodeQL.ps1 -CI -Force

      # Usage: Run full scan with JSON output (for CI integration)
      - name: Run CodeQL scan with JSON output
        shell: pwsh
        run: |
          ./.codeql/scripts/Invoke-CodeQLScan.ps1 -CI -Format json

      - name: Verify SARIF structure
        shell: pwsh
        run: |
          $sarifFiles = Get-ChildItem -Path ".codeql/results" -Filter "*.sarif"

          if (-not $sarifFiles) {
            Write-Error "No SARIF files created"
            exit 1
          }

          foreach ($file in $sarifFiles) {
            Write-Host "Validating: $($file.Name)"
            $sarif = Get-Content $file.FullName -Raw | ConvertFrom-Json

            # Validate required SARIF fields
            if (-not $sarif.version -or -not $sarif.runs) {
              Write-Error "Invalid SARIF structure in $($file.Name)"
              exit 1
            }

            Write-Host "  Version: $($sarif.version)"
            Write-Host "  Runs: $($sarif.runs.Count)"
            Write-Host "  Results: $($sarif.runs[0].results.Count)"
          }

  aggregate-results:
    name: Aggregate Results
    needs: [test-install-and-config, test-scan-language, test-scan-json-output]
    if: always()
    # Aggregate job can use ARM since it doesn't run CodeQL CLI
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read

    steps:
      - name: Check job results
        shell: pwsh
        env:
          INSTALL_RESULT: ${{ needs.test-install-and-config.result }}
          LANGUAGE_RESULT: ${{ needs.test-scan-language.result }}
          JSON_RESULT: ${{ needs.test-scan-json-output.result }}
        run: |
          $results = @{
            'Install & Config' = $env:INSTALL_RESULT
            'Language Scans' = $env:LANGUAGE_RESULT
            'JSON Output' = $env:JSON_RESULT
          }

          $allPassed = $true
          $summary = @"
          ## CodeQL Integration Test Results

          These tests document how to use the CodeQL scripts locally:

          | Test | Status | Usage Pattern |
          |------|--------|---------------|
          "@

          $patterns = @{
            'Install & Config' = '``Install-CodeQL.ps1`` + ``Test-CodeQLConfig.ps1``'
            'Language Scans' = '``Invoke-CodeQLScan.ps1 -Languages <lang>``'
            'JSON Output' = '``Invoke-CodeQLScan.ps1 -Format json``'
          }

          foreach ($test in $results.Keys) {
            $status = $results[$test]
            $emoji = if ($status -eq 'success') { '✓' } elseif ($status -eq 'skipped') { '⏭' } else { '✗' }
            $pattern = $patterns[$test]
            $summary += "`n| $test | $emoji $status | $pattern |"

            if ($status -notin @('success', 'skipped')) {
              $allPassed = $false
            }
          }

          if ($allPassed) {
            $summary += "`n`n> [!TIP]`n> All integration tests passed! See CONTRIBUTING.md for usage details."
          } else {
            $summary += "`n`n> [!CAUTION]`n> Some tests failed. Review logs above."
          }

          $summary | Add-Content $env:GITHUB_STEP_SUMMARY

          if (-not $allPassed) {
            Write-Error "One or more integration tests failed"
            exit 1
          }

          Write-Host "All integration tests passed!"
