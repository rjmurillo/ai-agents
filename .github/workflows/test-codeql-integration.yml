# Test CodeQL Integration
#
# Functional tests for CodeQL scripts that serve as documentation for how
# to use the custom CLI tooling. Each job demonstrates a real usage pattern.
#
# Usage Patterns Documented:
#   1. Install CLI once, validate config
#   2. Run scan for specific language
#   3. Run scan with JSON/SARIF output
#
# Local developers and AI agents use the same commands:
#   python3 .codeql/scripts/install_codeql.py  # One-time CLI setup
#   python3 .codeql/scripts/test_codeql_config.py
#   python3 .codeql/scripts/invoke_codeql_scan.py --languages python
#   python3 .codeql/scripts/invoke_codeql_scan.py --format json

name: Test CodeQL Integration

on:
  pull_request:
    paths:
      - '.codeql/**'
      - '.github/codeql/**'
      - '.github/workflows/codeql-*.yml'
      - '.github/workflows/test-codeql-integration.yml'
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

# Concurrency control
concurrency:
  group: test-codeql-integration-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Pattern 1: Install CLI and validate configuration
  test-install-and-config:
    name: Install CLI & Validate Config
    # CodeQL CLI does not provide ARM64 Linux binaries, must use x64
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install zstd (required for CodeQL bundle extraction)
        run: |
          sudo apt-get update
          sudo apt-get install -y zstd

      # Usage: Install CodeQL CLI (one-time setup)
      - name: Install CodeQL CLI
        run: python3 .codeql/scripts/install_codeql.py --ci --force

      - name: Verify CodeQL CLI version
        run: |
          codeql=".codeql/cli/codeql"
          if [ ! -f "$codeql" ]; then
            echo "ERROR: CodeQL CLI not found at: $codeql"
            exit 1
          fi
          "$codeql" version

      # Usage: Validate configuration before running scans
      - name: Validate CodeQL configuration
        run: python3 .codeql/scripts/test_codeql_config.py --ci

  # Pattern 2: Run scan for a specific language
  test-scan-language:
    name: Scan Language (${{ matrix.language }})
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        # Note: PowerShell is not a supported CodeQL language
        # PowerShell scripts are analyzed via PSScriptAnalyzer instead
        language: [actions, python]

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install zstd
        run: sudo apt-get update && sudo apt-get install -y zstd

      - name: Install CodeQL CLI
        run: python3 .codeql/scripts/install_codeql.py --ci --force

      # Usage: Scan specific language with console output
      # Exit 0=no findings, 1=findings detected (both mean scan worked), 2+=error
      - name: Run CodeQL scan for ${{ matrix.language }}
        env:
          SCAN_LANGUAGE: ${{ matrix.language }}
        run: |
          set +e
          python3 .codeql/scripts/invoke_codeql_scan.py --languages "$SCAN_LANGUAGE" --ci --format console
          rc=$?
          set -e
          if [ $rc -le 1 ]; then
            echo "Scan completed successfully (exit code $rc)"
          else
            echo "Scan failed with error (exit code $rc)"
            exit $rc
          fi

      - name: Verify scan artifacts
        env:
          LANGUAGE: ${{ matrix.language }}
        run: |
          # Verify database was created
          db_path=".codeql/db/$LANGUAGE"
          if [ ! -d "$db_path" ]; then
            echo "ERROR: Database not created: $db_path"
            exit 1
          fi
          echo "Database created: $db_path"

          # Verify SARIF output
          sarif_path=".codeql/results/$LANGUAGE.sarif"
          if [ ! -f "$sarif_path" ]; then
            echo "ERROR: SARIF not created: $sarif_path"
            exit 1
          fi

          findings=$(python3 -c "import json; d=json.load(open('$sarif_path')); print(len(d['runs'][0]['results']))")
          echo "SARIF created: $findings findings"

  # Pattern 3: Run scan with JSON output format
  test-scan-json-output:
    name: Scan with JSON Output
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install zstd
        run: sudo apt-get update && sudo apt-get install -y zstd

      - name: Install CodeQL CLI
        run: python3 .codeql/scripts/install_codeql.py --ci --force

      # Usage: Run full scan with JSON output (for CI integration)
      # Exit 0=no findings, 1=findings detected (both mean scan worked), 2+=error
      - name: Run CodeQL scan with JSON output
        run: |
          set +e
          python3 .codeql/scripts/invoke_codeql_scan.py --ci --format json
          rc=$?
          set -e
          if [ $rc -le 1 ]; then
            echo "Scan completed successfully (exit code $rc)"
          else
            echo "Scan failed with error (exit code $rc)"
            exit $rc
          fi

      - name: Verify SARIF structure
        run: |
          sarif_count=$(find .codeql/results -name "*.sarif" 2>/dev/null | wc -l)

          if [ "$sarif_count" -eq 0 ]; then
            echo "ERROR: No SARIF files created"
            exit 1
          fi

          for sarif_file in .codeql/results/*.sarif; do
            echo "Validating: $(basename "$sarif_file")"
            python3 -c "
          import json, sys
          with open('$sarif_file') as f:
              sarif = json.load(f)
          if not sarif.get('version') or not sarif.get('runs'):
              print(f'Invalid SARIF structure in $sarif_file', file=sys.stderr)
              sys.exit(1)
          print(f'  Version: {sarif[\"version\"]}')
          print(f'  Runs: {len(sarif[\"runs\"])}')
          print(f'  Results: {len(sarif[\"runs\"][0][\"results\"])}')
          "
          done

  aggregate-results:
    name: Aggregate Results
    needs: [test-install-and-config, test-scan-language, test-scan-json-output]
    if: always()
    # Aggregate job can use ARM since it doesn't run CodeQL CLI
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read

    steps:
      - name: Check job results
        env:
          INSTALL_RESULT: ${{ needs.test-install-and-config.result }}
          LANGUAGE_RESULT: ${{ needs.test-scan-language.result }}
          JSON_RESULT: ${{ needs.test-scan-json-output.result }}
        run: |
          all_passed=true

          cat >> "$GITHUB_STEP_SUMMARY" << 'HEADER'
          ## CodeQL Integration Test Results

          These tests document how to use the CodeQL scripts locally:

          | Test | Status | Usage Pattern |
          |------|--------|---------------|
          HEADER

          declare -A results=(
            ["Install & Config"]="$INSTALL_RESULT"
            ["Language Scans"]="$LANGUAGE_RESULT"
            ["JSON Output"]="$JSON_RESULT"
          )

          declare -A patterns=(
            ["Install & Config"]="\`install_codeql.py\` + \`test_codeql_config.py\`"
            ["Language Scans"]="\`invoke_codeql_scan.py --languages <lang>\`"
            ["JSON Output"]="\`invoke_codeql_scan.py --format json\`"
          )

          for test in "Install & Config" "Language Scans" "JSON Output"; do
            status="${results[$test]}"
            pattern="${patterns[$test]}"

            if [ "$status" = "success" ]; then
              emoji="✓"
            elif [ "$status" = "skipped" ]; then
              emoji="⏭"
            else
              emoji="✗"
              all_passed=false
            fi

            echo "| $test | $emoji $status | $pattern |" >> "$GITHUB_STEP_SUMMARY"
          done

          echo "" >> "$GITHUB_STEP_SUMMARY"

          if $all_passed; then
            echo "> [!TIP]" >> "$GITHUB_STEP_SUMMARY"
            echo "> All integration tests passed! See CONTRIBUTING.md for usage details." >> "$GITHUB_STEP_SUMMARY"
            echo "All integration tests passed!"
          else
            echo "> [!CAUTION]" >> "$GITHUB_STEP_SUMMARY"
            echo "> Some tests failed. Review logs above." >> "$GITHUB_STEP_SUMMARY"
            echo "ERROR: One or more integration tests failed"
            exit 1
          fi
