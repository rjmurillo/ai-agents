# Test CodeQL Integration
#
# Validates CodeQL configuration and CLI availability in CI environment.
# Actual scan testing is done locally with Install-CodeQL.ps1 or via the
# main codeql-analysis.yml workflow which uses the official GitHub action.
#
# Purpose:
#   - Verify configuration YAML syntax and structure
#   - Verify CodeQL CLI is accessible via setup-codeql action
#   - Validate query pack references exist
#
# Local developers and AI agents can run full scans using:
#   pwsh .codeql/scripts/Install-CodeQL.ps1  # One-time CLI setup
#   pwsh .codeql/scripts/Invoke-CodeQLScan.ps1
#   pwsh .codeql/scripts/Test-CodeQLConfig.ps1

name: Test CodeQL Integration

on:
  pull_request:
    paths:
      - '.codeql/**'
      - '.github/codeql/**'
      - '.github/workflows/codeql-*.yml'
      - '.github/workflows/test-codeql-integration.yml'
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

# Concurrency control
concurrency:
  group: test-codeql-integration-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  test-config-validation:
    name: Test Config Validation
    # CodeQL CLI does not provide ARM64 Linux binaries, must use x64
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: read  # Required for setup-codeql action API access

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup CodeQL CLI
        id: setup-codeql
        uses: github/codeql-action/setup-codeql@a4fda0891d53e117609b7ddb3570638c2c6d7c89 # v3

      - name: Add CodeQL to PATH
        run: |
          echo "$(dirname ${{ steps.setup-codeql.outputs.codeql-path }})" >> $GITHUB_PATH
          echo "CodeQL path: ${{ steps.setup-codeql.outputs.codeql-path }}"
          echo "CodeQL version: ${{ steps.setup-codeql.outputs.codeql-version }}"

      - name: Verify CodeQL CLI is accessible
        run: |
          codeql version
          echo "CodeQL CLI setup successful"

      - name: Install powershell-yaml module
        shell: pwsh
        run: |
          Install-Module -Name powershell-yaml -Force -Scope CurrentUser -AllowClobber

      - name: Validate configuration YAML syntax
        shell: pwsh
        run: |
          $configPath = ".github/codeql/codeql-config.yml"

          if (-not (Test-Path $configPath)) {
            Write-Error "Config file not found: $configPath"
            exit 1
          }

          # Parse YAML
          Import-Module powershell-yaml
          $content = Get-Content $configPath -Raw
          $config = ConvertFrom-Yaml $content

          Write-Host "Configuration parsed successfully"
          Write-Host "Name: $($config.name)"

          # Verify required fields
          if (-not $config.packs -and -not $config.queries) {
            Write-Error "Config must have 'packs' or 'queries' field"
            exit 1
          }

          Write-Host "YAML syntax validation passed"

      - name: Verify query packs are resolvable
        run: |
          echo "Checking if query packs can be resolved..."

          # Test that the CLI can resolve the configured query packs
          # This validates the pack references without running a full scan
          codeql resolve queries codeql/python-queries:codeql-suites/python-security-extended.qls || echo "Note: Pack resolution may require download"
          codeql resolve queries codeql/actions-queries:codeql-suites/actions-security-extended.qls || echo "Note: Pack resolution may require download"

          echo "Query pack validation completed"

      - name: Verify expected packs in config
        shell: pwsh
        run: |
          $configPath = ".github/codeql/codeql-config.yml"
          Import-Module powershell-yaml
          $content = Get-Content $configPath -Raw
          $config = ConvertFrom-Yaml $content

          # Note: PowerShell is not a supported CodeQL language
          # PowerShell scripts are analyzed via PSScriptAnalyzer instead
          $expectedPacks = @(
            'codeql/actions-queries:codeql-suites/actions-security-extended.qls',
            'codeql/python-queries:codeql-suites/python-security-extended.qls'
          )

          $allFound = $true
          foreach ($pack in $expectedPacks) {
            if ($config.packs -notcontains $pack) {
              Write-Warning "Expected pack not found: $pack"
              $allFound = $false
            } else {
              Write-Host "Found pack: $pack"
            }
          }

          if (-not $allFound) {
            Write-Error "Some expected packs are missing from configuration"
            exit 1
          }

          Write-Host "All expected query packs found in configuration"

  validate-scripts-syntax:
    name: Validate Scripts Syntax
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Validate PowerShell script syntax
        shell: pwsh
        run: |
          $scripts = @(
            ".codeql/scripts/Install-CodeQL.ps1",
            ".codeql/scripts/Invoke-CodeQLScan.ps1",
            ".codeql/scripts/Test-CodeQLConfig.ps1"
          )

          $hasErrors = $false
          foreach ($script in $scripts) {
            Write-Host "Checking syntax: $script"

            if (-not (Test-Path $script)) {
              Write-Error "Script not found: $script"
              $hasErrors = $true
              continue
            }

            try {
              $null = [System.Management.Automation.Language.Parser]::ParseFile(
                (Resolve-Path $script).Path,
                [ref]$null,
                [ref]$errors
              )

              if ($errors.Count -gt 0) {
                Write-Error "Syntax errors in $script"
                $errors | ForEach-Object { Write-Error $_.Message }
                $hasErrors = $true
              } else {
                Write-Host "  Syntax OK"
              }
            }
            catch {
              Write-Error "Failed to parse $script : $_"
              $hasErrors = $true
            }
          }

          if ($hasErrors) {
            exit 1
          }

          Write-Host "All CodeQL scripts have valid syntax"

  aggregate-results:
    name: Aggregate Results
    needs: [test-config-validation, validate-scripts-syntax]
    if: always()
    # Aggregate job can use ARM since it doesn't run CodeQL CLI
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read

    steps:
      - name: Check job results
        shell: pwsh
        env:
          CONFIG_RESULT: ${{ needs.test-config-validation.result }}
          SYNTAX_RESULT: ${{ needs.validate-scripts-syntax.result }}
        run: |
          $results = @{
            'Config Validation' = $env:CONFIG_RESULT
            'Scripts Syntax' = $env:SYNTAX_RESULT
          }

          $allPassed = $true
          $summary = @"
          ## CodeQL Integration Test Results

          | Test | Status |
          |------|--------|
          "@

          foreach ($test in $results.Keys) {
            $status = $results[$test]
            $emoji = if ($status -eq 'success') { '✓' } elseif ($status -eq 'skipped') { '⏭' } else { '✗' }
            $summary += "`n| $test | $emoji $status |"

            if ($status -notin @('success', 'skipped')) {
              $allPassed = $false
            }
          }

          if ($allPassed) {
            $summary += "`n`n> [!TIP]`n> All CodeQL integration tests passed!"
            $summary += "`n`n**Note**: Full scan testing is done locally via \`Install-CodeQL.ps1\` + \`Invoke-CodeQLScan.ps1\`"
            $summary += "`nor via the main \`codeql-analysis.yml\` workflow which uses the official GitHub action."
          } else {
            $summary += "`n`n> [!CAUTION]`n> Some CodeQL integration tests failed. Review logs above."
          }

          $summary | Add-Content $env:GITHUB_STEP_SUMMARY

          if (-not $allPassed) {
            Write-Error "One or more integration tests failed"
            exit 1
          }

          Write-Host "All integration tests passed!"
