name: Claude Code Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned, labeled]
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write  # Required for OIDC authentication to get GitHub App token
  actions: write  # Required to approve and trigger workflow runs autonomously
  checks: write  # Required to create check runs

jobs:
  # ADR-006 Compliance: Authorization logic moved to PowerShell script for testability
  # See: tests/workflows/Test-ClaudeAuthorization.ps1
  check-authorization:
    runs-on: ubuntu-latest
    outputs:
      authorized: ${{ steps.auth-check.outputs.authorized }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 1

      - name: Check Claude authorization
        id: auth-check
        shell: pwsh
        env:
          # Safe: Using environment variables to prevent command injection
          # See: https://github.blog/security/vulnerability-research/how-to-catch-github-actions-workflow-injections-before-attackers-do/
          EVENT_NAME: ${{ github.event_name }}
          ACTOR: ${{ github.actor }}
          AUTHOR_ASSOCIATION: ${{ github.event.comment.author_association || github.event.review.author_association || github.event.issue.author_association }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          REVIEW_BODY: ${{ github.event.review.body }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          $authorized = & ./tests/workflows/Test-ClaudeAuthorization.ps1 `
            -EventName $env:EVENT_NAME `
            -Actor $env:ACTOR `
            -AuthorAssociation $env:AUTHOR_ASSOCIATION `
            -CommentBody $env:COMMENT_BODY `
            -ReviewBody $env:REVIEW_BODY `
            -IssueBody $env:ISSUE_BODY `
            -IssueTitle $env:ISSUE_TITLE

          if ($LASTEXITCODE -ne 0) {
            Write-Error "Authorization check script failed with exit code $LASTEXITCODE."
            Write-Error "This indicates a script error, not an authorization denial."
            Write-Error "Review the step output above for specific error messages (e.g., EventBodyTooLarge, AuditLogFailed, RegexMatchFailed)."
            Write-Error "Check the Actions summary 'Claude Authorization Check' section if available."
            Write-Error "If the error mentions audit log failure, verify GITHUB_STEP_SUMMARY permissions."
            exit 1
          }

          # Validate output format to prevent silent failures from unexpected values
          # Normalize to lowercase for case-sensitive comparison (script returns lowercase)
          $authorized = $authorized.Trim().ToLower()
          if ($authorized -cnotin @('true', 'false')) {
            Write-Error "Authorization check returned unexpected value: '$authorized'. Expected 'true' or 'false'."
            Write-Error "This may indicate the script exited without producing valid output."
            exit 1
          }

          "authorized=$authorized" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

  claude-response:
    needs: check-authorization
    runs-on: ubuntu-latest
    if: needs.check-authorization.outputs.authorized == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 1

      # Pin to v1.0.27 - https://github.com/anthropics/claude-code-action/releases/tag/v1.0.27
      - uses: anthropics/claude-code-action@7145c3e0510bcdbdd29f67cc4a8c1958f1acfa2f
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Trigger configuration
          trigger_phrase: "@claude"
          assignee_trigger: "@me"

          # Allow specific trusted bot users to trigger the action
          # Dependency management bots
          # GitHub automation bots
          # AI coding assistant bots (permitted to mention @claude for collaboration)
          allowed_bots: "dependabot[bot],renovate[bot],github-actions[bot],copilot[bot],coderabbitai[bot],cursor[bot],gemini-ai[bot],claude-ai[bot],amazonq[bot],tabnine[bot]"

          # Branch configuration
          base_branch: "main"
          branch_prefix: "claude/"

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read
