# =============================================================================
# Copilot Context Synthesis Workflow
# =============================================================================
#
# PURPOSE:
# Automatically synthesizes context from issue comments and assigns GitHub
# Copilot when the 'copilot-ready' label is added to an issue.
#
# TRIGGERS:
# 1. issues:labeled  - Immediate processing when label is added
# 2. schedule        - Hourly sweep to catch any missed issues
# 3. workflow_dispatch - Manual trigger for testing
#
# HOW IT WORKS:
# 1. Maintainer reviews issue and adds 'copilot-ready' label
# 2. This workflow triggers on the 'labeled' event
# 3. Fetches issue context (AI Triage, CodeRabbit, maintainer comments)
# 4. Generates synthesis comment with @copilot mention
# 5. Creates or updates synthesis comment (idempotent - ONE comment only)
# 6. Assigns copilot-swe-agent to the issue
# 7. Removes the copilot-ready label to indicate completion
# 8. Copilot creates PR with full context
#
# EVENTUAL CONSISTENCY:
# The scheduled sweep job runs hourly to process any issues that might have
# been missed due to workflow failures, race conditions, or API issues.
# This ensures all copilot-ready labeled issues are eventually processed.
#
# IDEMPOTENCY:
# Re-processing an issue updates the existing synthesis comment rather than
# creating duplicates. Detection uses HTML marker: <!-- COPILOT-CONTEXT-SYNTHESIS -->
#
# RELATED:
# - Issue #92: https://github.com/rjmurillo/ai-agents/issues/92
# - Script: .claude/skills/github/scripts/issue/Invoke-CopilotAssignment.ps1
# - Config: .claude/skills/github/copilot-synthesis.yml
#
# =============================================================================

name: Copilot Context Synthesis

on:
  issues:
    types: [labeled]

  # Scheduled sweep for eventual consistency - runs hourly
  schedule:
    - cron: "0 * * * *"

  # Manual trigger for testing or re-running synthesis
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to synthesize context for (leave empty for sweep mode)"
        required: false
        type: number

permissions:
  contents: read
  issues: write

jobs:
  # ===========================================================================
  # Job 1: Process Single Issue (label trigger or manual with issue number)
  # ===========================================================================
  synthesize-single:
    name: Synthesize Context and Assign Copilot
    runs-on: ubuntu-latest

    # Run for:
    # - Label trigger with copilot-ready label
    # - Manual trigger with issue_number provided
    if: |
      (github.event_name == 'issues' && github.event.label.name == 'copilot-ready') ||
      (github.event_name == 'workflow_dispatch' && inputs.issue_number != '')

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Determine issue number
        id: issue
        shell: pwsh
        run: |
          $issueNumber = if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            "${{ inputs.issue_number }}"
          } else {
            "${{ github.event.issue.number }}"
          }
          "number=$issueNumber" | Add-Content -Path $env:GITHUB_OUTPUT

      - name: Prepare context for AI synthesis
        id: prepare
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Preparing context for issue #${{ steps.issue.outputs.number }}" -ForegroundColor Cyan
          & "./.claude/skills/github/scripts/issue/Invoke-CopilotAssignment.ps1" `
            -IssueNumber ${{ steps.issue.outputs.number }} `
            -PrepareContextOnly

      - name: AI-powered synthesis
        id: synthesize
        uses: ./.github/actions/ai-review
        with:
          agent: explainer
          context-type: spec-file
          context-path: ${{ steps.prepare.outputs.context_file }}
          prompt-file: .github/prompts/copilot-synthesis.md
          bot-pat: ${{ secrets.BOT_PAT }}
          copilot-token: ${{ secrets.COPILOT_GITHUB_TOKEN }}
          copilot-model: claude-sonnet-4
          timeout-minutes: '3'

      - name: Post synthesis comment
        if: steps.synthesize.outputs.verdict == 'PASS'
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Import-Module "./.claude/skills/github/modules/GitHubHelpers.psm1" -Force

          $marker = "${{ steps.prepare.outputs.marker }}"
          $existingId = "${{ steps.prepare.outputs.existing_synthesis_id }}"
          $synthesis = @"
          ${{ steps.synthesize.outputs.findings }}
          "@

          # Prepare comment body with marker
          $body = "$marker`n`n$synthesis"

          $resolved = Resolve-RepoParams
          $owner = $resolved.Owner
          $repo = $resolved.Repo
          $issueNumber = ${{ steps.issue.outputs.number }}

          if ($existingId) {
            Write-Host "Updating existing synthesis comment (ID: $existingId)" -ForegroundColor Yellow
            $result = Update-IssueComment -Owner $owner -Repo $repo -CommentId $existingId -Body $body
            Write-Host "::notice::Updated synthesis comment: $($result.html_url)"
          } else {
            Write-Host "Creating new synthesis comment" -ForegroundColor Green
            $result = New-IssueComment -Owner $owner -Repo $repo -IssueNumber $issueNumber -Body $body
            Write-Host "::notice::Created synthesis comment: $($result.html_url)"
          }

      - name: Assign copilot-swe-agent
        if: success()
        shell: pwsh
        env:
          # COPILOT_GITHUB_TOKEN is a PAT from a Copilot-enabled user
          # Required for copilot-swe-agent assignment per GitHub API requirements
          # See: https://github.blog/changelog/2025-12-03-assign-issues-to-copilot-using-the-api/
          GH_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
        run: |
          $issueNumber = ${{ steps.issue.outputs.number }}
          Write-Host "Assigning copilot-swe-agent to issue #$issueNumber..." -ForegroundColor Cyan
          $result = gh issue edit $issueNumber --add-assignee "copilot-swe-agent" 2>&1
          if ($LASTEXITCODE -eq 0) {
            Write-Host "::notice::Assigned copilot-swe-agent to issue #$issueNumber"
          } else {
            Write-Host "::warning::Failed to assign copilot-swe-agent - $result"
          }

      - name: Remove copilot-ready label
        if: success()
        shell: pwsh
        run: |
          $issueNumber = ${{ steps.issue.outputs.number }}
          Write-Host "Removing copilot-ready label..." -ForegroundColor Cyan
          gh issue edit $issueNumber --remove-label "copilot-ready"
          Write-Host "::notice::Removed copilot-ready label from issue #$issueNumber"

      - name: Summary
        if: success()
        shell: pwsh
        run: |
          $issueNumber = ${{ steps.issue.outputs.number }}
          @"
          ## Copilot Context Synthesis Complete :robot:

          **Issue**: #$issueNumber

          ### Actions Taken
          - Synthesized context from trusted sources using AI
          - Posted/updated synthesis comment with @copilot mention
          - Assigned copilot-swe-agent to the issue
          - Removed copilot-ready label (processing complete)

          Copilot will now create a PR based on the synthesized context.
          "@ | Add-Content -Path $env:GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 2: Sweep for Missed Issues (scheduled or manual without issue number)
  # ===========================================================================
  sweep-missed:
    name: Sweep Missed Issues
    runs-on: ubuntu-latest

    # Run for:
    # - Scheduled trigger (cron)
    # - Manual trigger WITHOUT issue_number (sweep mode)
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.issue_number == '')

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Find issues with copilot-ready label
        id: find-issues
        shell: pwsh
        run: |
          Write-Host "Searching for issues with copilot-ready label..." -ForegroundColor Cyan
          $issuesJson = gh issue list --label "copilot-ready" --state open --json number 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Host "::error::Failed to list issues: $issuesJson"
            exit 1
          }
          $issues = ($issuesJson | ConvertFrom-Json).number
          if ($issues.Count -eq 0) {
            Write-Host "No issues found with copilot-ready label"
            "count=0" | Add-Content -Path $env:GITHUB_OUTPUT
            "issues=" | Add-Content -Path $env:GITHUB_OUTPUT
          } else {
            Write-Host "Found $($issues.Count) issue(s) to process: $($issues -join ', ')"
            "count=$($issues.Count)" | Add-Content -Path $env:GITHUB_OUTPUT
            "issues=$($issues -join ' ')" | Add-Content -Path $env:GITHUB_OUTPUT
          }

      # NOTE: Sweep uses regex-based synthesis as fallback for eventual consistency.
      # The primary synthesize-single job uses AI-based synthesis when triggered by label.
      - name: Synthesize context for each issue
        id: synthesize
        if: steps.find-issues.outputs.count != '0'
        shell: pwsh
        env:
          ISSUES: ${{ steps.find-issues.outputs.issues }}
        run: |
          $issues = $env:ISSUES.Trim() -split '\s+'
          $results = @()
          $failed = @()
          $synthesized = @()

          Write-Host "Processing $($issues.Count) issue(s)..." -ForegroundColor Cyan

          foreach ($issueNumber in $issues) {
            if ([string]::IsNullOrWhiteSpace($issueNumber)) { continue }

            Write-Host "`n=== Processing Issue #$issueNumber ===" -ForegroundColor Yellow

            try {
              # Run the synthesis script (assignment handled separately with COPILOT_GITHUB_TOKEN)
              $result = & "./.claude/skills/github/scripts/issue/Invoke-CopilotAssignment.ps1" `
                -IssueNumber $issueNumber `
                -SkipAssignment

              if ($result.Success) {
                Write-Host "::notice::Issue #$issueNumber - $($result.Action) synthesis comment"
                $synthesized += $issueNumber

                $results += [PSCustomObject]@{
                  Issue = $issueNumber
                  Status = "Success"
                  Action = $result.Action
                }
              } else {
                Write-Host "::warning::Issue #$issueNumber - Synthesis failed"
                $failed += $issueNumber
              }
            }
            catch {
              Write-Host "::error::Issue #$issueNumber - Error: $_"
              $failed += $issueNumber
            }
          }

          # Output synthesized issues for the assignment step
          "synthesized=$($synthesized -join ' ')" | Add-Content -Path $env:GITHUB_OUTPUT

          # Summary
          Write-Host "`n=== Synthesis Complete ===" -ForegroundColor Cyan
          Write-Host "Processed: $($results.Count) issue(s)"
          if ($failed.Count -gt 0) {
            Write-Host "Failed: $($failed.Count) issue(s): $($failed -join ', ')" -ForegroundColor Red
          }

      - name: Assign copilot-swe-agent to synthesized issues
        if: steps.find-issues.outputs.count != '0' && steps.synthesize.outputs.synthesized != ''
        shell: pwsh
        env:
          # COPILOT_GITHUB_TOKEN is a PAT from a Copilot-enabled user
          GH_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
        run: |
          $issues = "${{ steps.synthesize.outputs.synthesized }}".Trim() -split '\s+'
          foreach ($issue in $issues) {
            if ([string]::IsNullOrWhiteSpace($issue)) { continue }
            Write-Host "Assigning copilot-swe-agent to issue #$issue..." -ForegroundColor Cyan
            $result = gh issue edit $issue --add-assignee "copilot-swe-agent" 2>&1
            if ($LASTEXITCODE -eq 0) {
              Write-Host "::notice::Assigned copilot-swe-agent to issue #$issue"
            } else {
              Write-Host "::warning::Failed to assign copilot-swe-agent to issue #$issue - $result"
            }
          }

      - name: Remove copilot-ready labels
        if: steps.find-issues.outputs.count != '0' && steps.synthesize.outputs.synthesized != ''
        shell: pwsh
        run: |
          $issues = "${{ steps.synthesize.outputs.synthesized }}".Trim() -split '\s+'
          foreach ($issue in $issues) {
            if ([string]::IsNullOrWhiteSpace($issue)) { continue }
            Write-Host "Removing copilot-ready label from issue #$issue..." -ForegroundColor Cyan
            gh issue edit $issue --remove-label "copilot-ready"
            Write-Host "::notice::Removed copilot-ready label from issue #$issue"
          }

      - name: Summary
        if: always()
        shell: pwsh
        run: |
          $count = "${{ steps.find-issues.outputs.count }}"
          $issues = "${{ steps.find-issues.outputs.issues }}"
          if ($count -eq "0") {
            @"
          ## Copilot Context Synthesis Sweep :broom:

          **Trigger**: ${{ github.event_name }}
          **Issues Found**: 0

          No issues with ``copilot-ready`` label found. All caught up! :white_check_mark:
          "@ | Add-Content -Path $env:GITHUB_STEP_SUMMARY
          } else {
            @"
          ## Copilot Context Synthesis Sweep :broom:

          **Trigger**: ${{ github.event_name }}
          **Issues Found**: $count

          ### Issues Processed
          Issues: $issues

          Check the job logs for individual issue processing results.
          "@ | Add-Content -Path $env:GITHUB_STEP_SUMMARY
          }
