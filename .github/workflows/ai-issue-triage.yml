name: AI Issue Triage

# AI-powered issue categorization and labeling using GitHub Copilot CLI
# Invokes analyst and roadmap agents to classify issues
# Applies labels and assigns milestones automatically

on:
  issues:
    types: [opened, reopened]

permissions:
  contents: read
  issues: write

concurrency:
  group: issue-triage-${{ github.event.issue.number }}
  cancel-in-progress: false

env:
  GH_TOKEN: ${{ secrets.BOT_PAT }}

jobs:
  ai-issue-triage:
    name: AI Issue Triage
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Skip for issues from bots
    if: github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 'lts/*'

      - name: Cache npm packages
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-copilot-cli-v1

      - name: Install GitHub Copilot CLI
        run: npm install -g @github/copilot

      - name: Authenticate with GitHub
        run: |
          echo "${{ secrets.BOT_PAT }}" | gh auth login --with-token
          gh auth status

      - name: Load Roadmap Context
        id: roadmap
        run: |
          ROADMAP_FILE=".agents/roadmap/product-roadmap.md"
          if [ -f "$ROADMAP_FILE" ]; then
            # Get first 30000 lines to keep context manageable
            ROADMAP_CONTENT=$(head -30000 "$ROADMAP_FILE")
          else
            ROADMAP_CONTENT="No roadmap file found"
          fi

          # Save to file to handle multiline
          echo "$ROADMAP_CONTENT" > /tmp/roadmap-context.txt
          echo "roadmap_file=/tmp/roadmap-context.txt" >> $GITHUB_OUTPUT

      - name: Get Issue Details
        id: issue
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_AUTHOR="${{ github.event.issue.user.login }}"

          # Get current labels
          CURRENT_LABELS=$(gh issue view "$ISSUE_NUMBER" --json labels -q '[.labels[].name] | join(",")' || echo "")

          # Save issue details
          cat > /tmp/issue-details.txt << EOF
          Title: $ISSUE_TITLE
          Author: $ISSUE_AUTHOR
          Current Labels: $CURRENT_LABELS

          Body:
          $ISSUE_BODY
          EOF

          echo "issue_file=/tmp/issue-details.txt" >> $GITHUB_OUTPUT

      - name: Categorize Issue
        id: categorize
        run: |
          source .github/scripts/ai-review-common.sh

          # Load agent definition
          AGENT_DEF=""
          if [ -f "src/copilot-cli/analyst.agent.md" ]; then
            AGENT_DEF=$(cat "src/copilot-cli/analyst.agent.md")
          fi

          # Load prompt template
          PROMPT_TEMPLATE=$(cat ".github/prompts/issue-triage-categorize.md")

          # Build full prompt
          FULL_PROMPT="$AGENT_DEF"
          FULL_PROMPT="$FULL_PROMPT"$'\n\n---\n\n'
          FULL_PROMPT="$FULL_PROMPT$PROMPT_TEMPLATE"
          FULL_PROMPT="$FULL_PROMPT"$'\n\n## Issue Details\n\n'
          FULL_PROMPT="$FULL_PROMPT$(cat /tmp/issue-details.txt)"

          # Invoke Copilot CLI
          log "Categorizing issue..."
          OUTPUT=$(timeout 120 copilot --prompt "$FULL_PROMPT" 2>&1 || echo '{"labels": [], "category": "unknown"}')

          echo "$OUTPUT" > /tmp/categorize-output.txt
          log "Categorization complete"

          # Parse labels from output
          LABELS=$(echo "$OUTPUT" | grep -oP '"labels"\s*:\s*\[\K[^\]]+' | tr -d '"' | tr ',' '\n' | xargs || echo "")
          CATEGORY=$(echo "$OUTPUT" | grep -oP '"category"\s*:\s*"\K[^"]+' || echo "unknown")

          echo "labels=$LABELS" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT

      - name: Align to Roadmap
        id: align
        run: |
          source .github/scripts/ai-review-common.sh

          # Load agent definition
          AGENT_DEF=""
          if [ -f "src/copilot-cli/roadmap.agent.md" ]; then
            AGENT_DEF=$(cat "src/copilot-cli/roadmap.agent.md")
          fi

          # Load prompt template
          PROMPT_TEMPLATE=$(cat ".github/prompts/issue-triage-roadmap.md")

          # Build full prompt
          FULL_PROMPT="$AGENT_DEF"
          FULL_PROMPT="$FULL_PROMPT"$'\n\n---\n\n'
          FULL_PROMPT="$FULL_PROMPT$PROMPT_TEMPLATE"
          FULL_PROMPT="$FULL_PROMPT"$'\n\n## Roadmap Context\n\n'
          FULL_PROMPT="$FULL_PROMPT$(cat /tmp/roadmap-context.txt)"
          FULL_PROMPT="$FULL_PROMPT"$'\n\n## Issue Details\n\n'
          FULL_PROMPT="$FULL_PROMPT$(cat /tmp/issue-details.txt)"

          # Invoke Copilot CLI
          log "Aligning to roadmap..."
          OUTPUT=$(timeout 120 copilot --prompt "$FULL_PROMPT" 2>&1 || echo '{"milestone": "", "priority": "P2"}')

          echo "$OUTPUT" > /tmp/align-output.txt
          log "Alignment complete"

          # Parse results
          MILESTONE=$(echo "$OUTPUT" | grep -oP '"milestone"\s*:\s*"\K[^"]+' || echo "")
          PRIORITY=$(echo "$OUTPUT" | grep -oP '"priority"\s*:\s*"\K[^"]+' || echo "P2")

          echo "milestone=$MILESTONE" >> $GITHUB_OUTPUT
          echo "priority=$PRIORITY" >> $GITHUB_OUTPUT

      - name: Apply Labels
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          LABELS="${{ steps.categorize.outputs.labels }}"
          PRIORITY="${{ steps.align.outputs.priority }}"

          # Apply category labels
          if [ -n "$LABELS" ]; then
            for label in $LABELS; do
              # Check if label exists, create if not
              if ! gh label list --search "$label" --json name -q '.[].name' | grep -q "^${label}$"; then
                echo "Creating label: $label"
                gh label create "$label" --description "Auto-created by AI triage" || true
              fi
              echo "Adding label: $label"
              gh issue edit "$ISSUE_NUMBER" --add-label "$label" || true
            done
          fi

          # Apply priority label
          if [ -n "$PRIORITY" ]; then
            PRIORITY_LABEL="priority:$PRIORITY"
            if ! gh label list --search "$PRIORITY_LABEL" --json name -q '.[].name' | grep -q "^${PRIORITY_LABEL}$"; then
              echo "Creating label: $PRIORITY_LABEL"
              gh label create "$PRIORITY_LABEL" --description "Priority level" --color "FFA500" || true
            fi
            echo "Adding priority label: $PRIORITY_LABEL"
            gh issue edit "$ISSUE_NUMBER" --add-label "$PRIORITY_LABEL" || true
          fi

      - name: Assign Milestone
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          MILESTONE="${{ steps.align.outputs.milestone }}"

          if [ -n "$MILESTONE" ] && [ "$MILESTONE" != "null" ]; then
            # Check if milestone exists
            if gh api "repos/${{ github.repository }}/milestones" --jq '.[].title' | grep -q "^${MILESTONE}$"; then
              echo "Assigning milestone: $MILESTONE"
              gh issue edit "$ISSUE_NUMBER" --milestone "$MILESTONE" || true
            else
              echo "Milestone not found: $MILESTONE (skipping)"
            fi
          fi

      - name: Post Triage Summary
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          CATEGORY="${{ steps.categorize.outputs.category }}"
          LABELS="${{ steps.categorize.outputs.labels }}"
          PRIORITY="${{ steps.align.outputs.priority }}"
          MILESTONE="${{ steps.align.outputs.milestone }}"

          # Get priority emoji
          get_priority_emoji() {
            case "$1" in
              P0) echo "ğŸ”´" ;;
              P1) echo "ğŸŸ " ;;
              P2) echo "ğŸŸ¡" ;;
              P3) echo "ğŸŸ¢" ;;
              *) echo "âšª" ;;
            esac
          }
          PRIORITY_EMOJI=$(get_priority_emoji "$PRIORITY")

          cat > /tmp/triage-comment.md << EOF
          <!-- AI-ISSUE-TRIAGE -->

          ## ğŸ¤– AI Triage Summary

          > [!NOTE]
          > This issue has been automatically triaged by AI agents

          <details>
          <summary>ğŸ“‹ What is AI Triage?</summary>

          This issue was analyzed by two AI agents:

          - **ğŸ“Š Analyst Agent**: Categorizes the issue and suggests appropriate labels
          - **ğŸ—ºï¸ Roadmap Agent**: Aligns the issue with project milestones and priorities

          </details>

          ### ğŸ“Š Triage Results

          | Property | Value |
          |:---------|:------|
          | ğŸ“ **Category** | \`$CATEGORY\` |
          | ğŸ·ï¸ **Labels** | ${LABELS:-*None assigned*} |
          | $PRIORITY_EMOJI **Priority** | \`$PRIORITY\` |
          | ğŸ¯ **Milestone** | ${MILESTONE:-*Not assigned*} |

          <details>
          <summary>ğŸ” Categorization Analysis</summary>

          \`\`\`json
          $(cat /tmp/categorize-output.txt 2>/dev/null || echo "N/A")
          \`\`\`

          </details>

          <details>
          <summary>ğŸ—ºï¸ Roadmap Alignment</summary>

          \`\`\`json
          $(cat /tmp/align-output.txt 2>/dev/null || echo "N/A")
          \`\`\`

          </details>

          ---

          <sub>ğŸ¤– Powered by [AI Issue Triage](https://github.com/${{ github.repository }}) Â· [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>
          EOF

          source .github/scripts/ai-review-common.sh
          post_issue_comment "$ISSUE_NUMBER" "/tmp/triage-comment.md" "AI-ISSUE-TRIAGE"
