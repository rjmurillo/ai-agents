name: AI Issue Triage

# AI-powered issue categorization and labeling using GitHub Copilot CLI

# Invokes analyst and roadmap agents to classify issues

# Applies labels and assigns milestones automatically

on:
  issues:
    types: [opened, reopened, edited]

permissions:
  contents: read
  issues: write

concurrency:
  group: issue-triage-${{ github.event.issue.number }}
  cancel-in-progress: false

env:
  GH_TOKEN: ${{ secrets.BOT_PAT }}

jobs:
  ai-issue-triage:
    name: AI Issue Triage
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Skip for bots and non-substantive edits (title-only changes)
    # For 'edited' events, only run if the body changed (not just title)
    if: |
      github.actor != 'dependabot[bot]' &&
      github.actor != 'github-actions[bot]' &&
      (github.event.action != 'edited' || github.event.changes.body != null)

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: üìä Categorize Issue (Analyst Agent)
        id: categorize
        uses: ./.github/actions/ai-review
        with:
          agent: analyst
          context-type: issue
          issue-number: ${{ github.event.issue.number }}
          prompt-file: .github/prompts/issue-triage-categorize.md
          timeout-minutes: 2
          bot-pat: ${{ secrets.BOT_PAT }}
          copilot-token: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      # SEC-FIX: Replaced bash parsing with PowerShell to prevent CWE-20/CWE-78 (Issue #211)
      - name: Parse Categorization Results
        id: parse-categorize
        shell: pwsh
        env:
          RAW_OUTPUT: ${{ steps.categorize.outputs.findings }}
          FALLBACK_LABELS: ${{ steps.categorize.outputs.labels }}
        run: |
          Import-Module "$env:GITHUB_WORKSPACE/.github/scripts/AIReviewCommon.psm1" -Force

          # Save output for debugging
          $env:RAW_OUTPUT | Set-Content /tmp/categorize-output.txt -Encoding UTF8

          # Parse with hardened function (rejects shell metacharacters)
          $labels = Get-LabelsFromAIOutput -Output $env:RAW_OUTPUT

          # Fallback to composite action output if needed
          if ($labels.Count -eq 0 -and $env:FALLBACK_LABELS) {
              $fallbackLabels = $env:FALLBACK_LABELS -split ',' | ForEach-Object { $_.Trim() }
              # Validate fallback labels with same regex
              # Regex: length lookahead + alphanumeric start + optional (middle chars + alphanumeric end)
              # Prevents trailing special chars like "bug-" by requiring alphanumeric end when middle chars present
              $labels = $fallbackLabels | Where-Object {
                  $_ -match '^(?=.{1,50}$)[A-Za-z0-9](?:[A-Za-z0-9 _\.-]*[A-Za-z0-9])?$'
              }
          }

          # Parse category with validation (alphanumeric, underscore, hyphen only)
          $category = 'unknown'
          if ($env:RAW_OUTPUT -match '"category"\s*:\s*"([a-zA-Z0-9_-]+)"') {
              $category = $Matches[1]
          }

          # Output as JSON array for safe consumption
          $labelsJson = $labels | ConvertTo-Json -Compress
          if ($labels.Count -eq 0) { $labelsJson = '[]' }
          if ($labels.Count -eq 1) { $labelsJson = "[$labelsJson]" }

          "labels=$labelsJson" >> $env:GITHUB_OUTPUT
          "category=$category" >> $env:GITHUB_OUTPUT

      - name: üó∫Ô∏è Align to Roadmap (Roadmap Agent)
        id: align
        uses: ./.github/actions/ai-review
        with:
          agent: roadmap
          context-type: issue
          issue-number: ${{ github.event.issue.number }}
          prompt-file: .github/prompts/issue-triage-roadmap.md
          timeout-minutes: 2
          bot-pat: ${{ secrets.BOT_PAT }}
          copilot-token: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      # SEC-FIX: Replaced bash parsing with PowerShell to prevent CWE-20/CWE-78 (Issue #211)
      - name: Parse Roadmap Results
        id: parse-align
        shell: pwsh
        env:
          RAW_OUTPUT: ${{ steps.align.outputs.findings }}
          MILESTONE_FROM_ACTION: ${{ steps.align.outputs.milestone }}
        run: |
          Import-Module "$env:GITHUB_WORKSPACE/.github/scripts/AIReviewCommon.psm1" -Force

          # Save output for debugging
          $env:RAW_OUTPUT | Set-Content /tmp/align-output.txt -Encoding UTF8

          # Parse milestone with hardened function
          $milestone = Get-MilestoneFromAIOutput -Output $env:RAW_OUTPUT
          if (-not $milestone -and $env:MILESTONE_FROM_ACTION) {
              # Validate fallback milestone with same regex
              # Prevents trailing special chars like "v1.0-" by requiring alphanumeric end when middle chars present
              if ($env:MILESTONE_FROM_ACTION -match '^(?=.{1,50}$)[A-Za-z0-9](?:[A-Za-z0-9 _\.-]*[A-Za-z0-9])?$') {
                  $milestone = $env:MILESTONE_FROM_ACTION
              }
          }

          # Parse priority with strict validation (P0-P4 only)
          $priority = 'P2'
          if ($env:RAW_OUTPUT -match '"priority"\s*:\s*"(P[0-4])"') {
              $priority = $Matches[1]
          }

          # Parse escalation fields with validation
          $escalateToPrd = 'false'
          if ($env:RAW_OUTPUT -match '"escalate_to_prd"\s*:\s*(true|false)') {
              $escalateToPrd = $Matches[1]
          }

          $complexityScore = 0
          if ($env:RAW_OUTPUT -match '"complexity_score"\s*:\s*(\d{1,2})') {
              $complexityScore = [int]$Matches[1]
              if ($complexityScore -gt 12) { $complexityScore = 12 }
          }

          # Parse escalation criteria with hardened regex (reject shell metacharacters)
          $escalationCriteria = ''
          if ($env:RAW_OUTPUT -match '"escalation_criteria"\s*:\s*\[([^\]]*)\]') {
              $criteria = $Matches[1] -split ',' | ForEach-Object {
                  $_.Trim().Trim('"').Trim("'")
              } | Where-Object {
                  # Regex: length lookahead + alphanumeric start + optional (middle chars + alphanumeric end)
                  # Prevents trailing special chars like "criteria-" by requiring alphanumeric end
                  $_ -match '^(?=.{1,50}$)[A-Za-z0-9](?:[A-Za-z0-9 _\.-]*[A-Za-z0-9])?$'
              }
              $escalationCriteria = $criteria -join ','
          }

          "milestone=$milestone" >> $env:GITHUB_OUTPUT
          "priority=$priority" >> $env:GITHUB_OUTPUT
          "escalate_to_prd=$escalateToPrd" >> $env:GITHUB_OUTPUT
          "complexity_score=$complexityScore" >> $env:GITHUB_OUTPUT
          "escalation_criteria=$escalationCriteria" >> $env:GITHUB_OUTPUT

      # SEC-FIX: Replaced bash iteration with PowerShell to prevent CWE-78 (Issue #211)
      - name: Apply Labels
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          LABELS_JSON: ${{ steps.parse-categorize.outputs.labels }}
          PRIORITY: ${{ steps.parse-align.outputs.priority }}
        run: |
          $failedLabels = @()
          $failedCreates = @()

          # Parse labels from JSON array (already validated by Parse Categorization Results)
          $labels = @()
          if ($env:LABELS_JSON -and $env:LABELS_JSON -ne '[]') {
              try {
                  $labels = $env:LABELS_JSON | ConvertFrom-Json
              } catch {
                  Write-Warning "Failed to parse labels JSON: $_"
              }
          }

          # Apply category labels with proper quoting
          foreach ($label in $labels) {
              # Defense in depth: validate label one more time
              # Prevents trailing special chars like "bug-" by requiring alphanumeric end
              if ($label -notmatch '^(?=.{1,50}$)[A-Za-z0-9](?:[A-Za-z0-9 _\.-]*[A-Za-z0-9])?$') {
                  Write-Warning "Skipping invalid label: $label"
                  continue
              }

              # Check if label exists (case-insensitive)
              $existingRaw = gh label list --search $label --json name -q '.[].name' 2>$null
              $existing = @($existingRaw) | Where-Object { $_ }
              $existingLower = $existing | ForEach-Object { $_.ToLowerInvariant() }
              if ($existingLower -notcontains $label.ToLowerInvariant()) {
                  Write-Host "Creating label: $label"
                  $result = gh label create $label --description "Auto-created by AI triage" 2>&1
                  if ($LASTEXITCODE -ne 0) {
                      Write-Warning "Failed to create label: $label"
                      $failedCreates += $label
                  }
              }

              Write-Host "Adding label: $label"
              $result = gh issue edit $env:ISSUE_NUMBER --add-label $label 2>&1
              if ($LASTEXITCODE -ne 0) {
                  Write-Warning "Failed to add label '$label' to issue #$($env:ISSUE_NUMBER)"
                  $failedLabels += $label
              }
          }

          # Apply priority label with validation
          if ($env:PRIORITY -match '^P[0-4]$') {
              $priorityLabel = "priority:$($env:PRIORITY)"

              $existingRaw = gh label list --search $priorityLabel --json name -q '.[].name' 2>$null
              $existing = @($existingRaw) | Where-Object { $_ }
              $existingLower = $existing | ForEach-Object { $_.ToLowerInvariant() }
              if ($existingLower -notcontains $priorityLabel.ToLowerInvariant()) {
                  Write-Host "Creating label: $priorityLabel"
                  $result = gh label create $priorityLabel --description "Priority level" --color "FFA500" 2>&1
                  if ($LASTEXITCODE -ne 0) {
                      Write-Warning "Failed to create priority label: $priorityLabel"
                      $failedCreates += $priorityLabel
                  }
              }

              Write-Host "Adding priority label: $priorityLabel"
              $result = gh issue edit $env:ISSUE_NUMBER --add-label $priorityLabel 2>&1
              if ($LASTEXITCODE -ne 0) {
                  Write-Warning "Failed to add priority label '$priorityLabel'"
                  $failedLabels += $priorityLabel
              }
          }

          # Report summary
          if ($failedLabels.Count -gt 0 -or $failedCreates.Count -gt 0) {
              Write-Host ""
              Write-Host "=== LABEL OPERATIONS SUMMARY ==="
              if ($failedCreates.Count -gt 0) {
                  Write-Host "Failed to create labels: $($failedCreates -join ', ')"
              }
              if ($failedLabels.Count -gt 0) {
                  Write-Host "Failed to apply labels: $($failedLabels -join ', ')"
              }
              Write-Host "==============================="
          }

      # SEC-FIX: Replaced bash with PowerShell to prevent CWE-78 (Issue #211)
      - name: Assign Milestone
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          MILESTONE: ${{ steps.parse-align.outputs.milestone }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          if ($env:MILESTONE -and $env:MILESTONE -ne 'null') {
              # Defense in depth: validate milestone format
              # Prevents trailing special chars like "v1.0-" by requiring alphanumeric end
              if ($env:MILESTONE -notmatch '^(?=.{1,50}$)[A-Za-z0-9](?:[A-Za-z0-9 _\.-]*[A-Za-z0-9])?$') {
                  Write-Warning "Invalid milestone format: $($env:MILESTONE)"
                  exit 0
              }

              # Check if milestone exists
              # Ensure $milestones is always an array (fixes single-milestone edge case)
              $milestonesRaw = gh api "repos/$($env:GITHUB_REPOSITORY)/milestones" --jq '.[].title' 2>$null
              $milestones = @($milestonesRaw) | Where-Object { $_ }
              # Case-insensitive comparison for milestone matching
              $milestonesLower = $milestones | ForEach-Object { $_.ToLowerInvariant() }
              if ($milestonesLower -contains $env:MILESTONE.ToLowerInvariant()) {
                  Write-Host "Assigning milestone: $($env:MILESTONE)"
                  $result = gh issue edit $env:ISSUE_NUMBER --milestone $env:MILESTONE 2>&1
                  if ($LASTEXITCODE -ne 0) {
                      Write-Warning "Failed to assign milestone '$($env:MILESTONE)' to issue #$($env:ISSUE_NUMBER)"
                  }
              } else {
                  Write-Host "::notice::Milestone not found: $($env:MILESTONE) (skipping assignment)"
              }
          } else {
              Write-Host "No milestone to assign"
          }

      - name: üìù Generate PRD (Escalated Issues)
        id: generate-prd
        if: steps.parse-align.outputs.escalate_to_prd == 'true'
        uses: ./.github/actions/ai-review
        with:
          agent: explainer
          context-type: issue
          issue-number: ${{ github.event.issue.number }}
          prompt-file: .github/prompts/issue-prd-generation.md
          timeout-minutes: 5
          bot-pat: ${{ secrets.BOT_PAT }}
          copilot-token: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      # ADR-005 SECURITY: Single PowerShell step for PRD comment generation and posting
      # Eliminates bash shell usage to prevent command injection from AI-generated content
      - name: Post PRD Comment
        if: steps.parse-align.outputs.escalate_to_prd == 'true' && steps.generate-prd.outputs.findings != ''
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          PRD_CONTENT: ${{ steps.generate-prd.outputs.findings }}
          COMPLEXITY_SCORE: ${{ steps.parse-align.outputs.complexity_score }}
          ESCALATION_CRITERIA: ${{ steps.parse-align.outputs.escalation_criteria }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          SERVER_URL: ${{ github.server_url }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # Determine PRD depth based on complexity score
          $complexityScore = [int]$env:COMPLEXITY_SCORE
          $prdDepth = switch ($true) {
              ($complexityScore -ge 10) { "Comprehensive" }
              ($complexityScore -ge 7) { "Detailed" }
              default { "Standard" }
          }

          # Build PRD comment template using PowerShell here-string (safe from injection)
          $prdTemplate = @"
          <!-- AI-PRD-GENERATION -->

          ## Product Requirements Document

          > [!IMPORTANT]
          > This PRD was automatically generated based on issue triage escalation.
          > **Complexity Score**: $($env:COMPLEXITY_SCORE)/12 ($prdDepth)
          > **Escalation Criteria**: $($env:ESCALATION_CRITERIA)

          <details>
          <summary>About this PRD</summary>

          This PRD was generated by the **Explainer Agent** after the issue was flagged
          for detailed analysis. The document is designed to be self-contained - it can
          be passed to a separate AI agent instance for implementation without additional
          context.

          **PRD Depth Levels**:
          - **Standard** (4-6): Brief analysis, clear requirements
          - **Detailed** (7-9): Research section, blocking questions
          - **Comprehensive** (10-12): Phased implementation, risk analysis

          </details>

          ---

          "@

          # Append PRD content (PowerShell string handling prevents injection)
          $prdTemplate += $env:PRD_CONTENT

          # Add footer with replaced placeholders
          $prdTemplate += @"

          ---

          <sub>Generated by [AI PRD Generation](https://github.com/$($env:GITHUB_REPOSITORY)) | [View Workflow]($($env:SERVER_URL)/$($env:GITHUB_REPOSITORY)/actions/runs/$($env:RUN_ID))</sub>
          "@

          # Write to temp file
          $prdTemplate | Set-Content /tmp/prd-comment.md -Encoding UTF8

          # Use GitHub skill script for idempotent comment posting
          & .claude/skills/github/scripts/issue/Post-IssueComment.ps1 `
            -Issue $env:ISSUE_NUMBER `
            -BodyFile "/tmp/prd-comment.md" `
            -Marker "AI-PRD-GENERATION"

      - name: Post Triage Summary
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          CATEGORY: ${{ steps.parse-categorize.outputs.category }}
          LABELS: ${{ steps.parse-categorize.outputs.labels }}
          PRIORITY: ${{ steps.parse-align.outputs.priority }}
          MILESTONE: ${{ steps.parse-align.outputs.milestone }}
          ESCALATE_TO_PRD: ${{ steps.parse-align.outputs.escalate_to_prd }}
          COMPLEXITY_SCORE: ${{ steps.parse-align.outputs.complexity_score }}
          ESCALATION_CRITERIA: ${{ steps.parse-align.outputs.escalation_criteria }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          SERVER_URL: ${{ github.server_url }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # Get priority emoji
          $priorityEmoji = switch ($env:PRIORITY) {
            'P0' { '' }
            'P1' { '' }
            'P2' { '' }
            'P3' { '' }
            default { '' }
          }

          # Determine PRD status
          $prdRow = if ($env:ESCALATE_TO_PRD -eq 'true') {
            "| **PRD Escalation** | Generated (see below) |"
          } else {
            ""
          }

          # Get analysis outputs
          $categorizeOutput = if (Test-Path /tmp/categorize-output.txt) {
            Get-Content /tmp/categorize-output.txt -Raw
          } else { "N/A" }

          $alignOutput = if (Test-Path /tmp/align-output.txt) {
            Get-Content /tmp/align-output.txt -Raw
          } else { "N/A" }

          $labelsDisplay = if ($env:LABELS) { $env:LABELS } else { "*None assigned*" }
          $milestoneDisplay = if ($env:MILESTONE) { $env:MILESTONE } else { "*Not assigned*" }

          $triageComment = @"
          <!-- AI-ISSUE-TRIAGE -->

          ## AI Triage Summary

          > [!NOTE]
          > This issue has been automatically triaged by AI agents

          <details>
          <summary>What is AI Triage?</summary>

          This issue was analyzed by AI agents:

          - **Analyst Agent**: Categorizes the issue and suggests appropriate labels
          - **Roadmap Agent**: Aligns the issue with project milestones and priorities
          - **Explainer Agent** (if escalated): Generates comprehensive PRD

          </details>

          ### Triage Results

          | Property | Value |
          |:---------|:------|
          | **Category** | ``$($env:CATEGORY)`` |
          | **Labels** | $labelsDisplay |
          | $priorityEmoji **Priority** | ``$($env:PRIORITY)`` |
          | **Milestone** | $milestoneDisplay |
          $prdRow

          <details>
          <summary>Categorization Analysis</summary>

          ``````json
          $categorizeOutput
          ``````

          </details>

          <details>
          <summary>Roadmap Alignment</summary>

          ``````json
          $alignOutput
          ``````

          </details>

          ---

          <sub>Powered by [AI Issue Triage](https://github.com/$($env:GITHUB_REPOSITORY)) - [View Workflow]($($env:SERVER_URL)/$($env:GITHUB_REPOSITORY)/actions/runs/$($env:RUN_ID))</sub>
          "@

          $triageComment | Set-Content /tmp/triage-comment.md -Encoding UTF8

          # Use GitHub skill script for idempotent comment posting
          & .claude/skills/github/scripts/issue/Post-IssueComment.ps1 `
            -Issue $env:ISSUE_NUMBER `
            -BodyFile "/tmp/triage-comment.md" `
            -Marker "AI-ISSUE-TRIAGE"
