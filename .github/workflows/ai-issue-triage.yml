name: AI Issue Triage

# AI-powered issue categorization and labeling using GitHub Copilot CLI
# Invokes analyst and roadmap agents to classify issues
# Applies labels and assigns milestones automatically

on:
  issues:
    types: [opened, reopened]

permissions:
  contents: read
  issues: write

concurrency:
  group: issue-triage-${{ github.event.issue.number }}
  cancel-in-progress: false

env:
  GH_TOKEN: ${{ secrets.BOT_PAT }}

jobs:
  ai-issue-triage:
    name: AI Issue Triage
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Skip for issues from bots
    if: github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: ğŸ“Š Categorize Issue (Analyst Agent)
        id: categorize
        uses: ./.github/actions/ai-review
        with:
          agent: analyst
          context-type: issue
          issue-number: ${{ github.event.issue.number }}
          prompt-file: .github/prompts/issue-triage-categorize.md
          timeout-minutes: 2
          bot-pat: ${{ secrets.BOT_PAT }}
          copilot-token: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      - name: Parse Categorization Results
        id: parse-categorize
        env:
          RAW_OUTPUT: ${{ steps.categorize.outputs.findings }}
        run: |
          # Save output for debugging
          echo "$RAW_OUTPUT" > /tmp/categorize-output.txt

          # Parse labels from output (handles JSON or plain text)
          LABELS=$(echo "$RAW_OUTPUT" | grep -oP '"labels"\s*:\s*\[\K[^\]]+' | tr -d '"' | tr ',' '\n' | xargs || echo "")
          CATEGORY=$(echo "$RAW_OUTPUT" | grep -oP '"category"\s*:\s*"\K[^"]+' || echo "unknown")

          # Also check for LABEL: format from composite action
          if [ -z "$LABELS" ]; then
            LABELS="${{ steps.categorize.outputs.labels }}"
          fi

          echo "labels=$LABELS" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT

      - name: ğŸ—ºï¸ Align to Roadmap (Roadmap Agent)
        id: align
        uses: ./.github/actions/ai-review
        with:
          agent: roadmap
          context-type: issue
          issue-number: ${{ github.event.issue.number }}
          prompt-file: .github/prompts/issue-triage-roadmap.md
          timeout-minutes: 2
          bot-pat: ${{ secrets.BOT_PAT }}
          copilot-token: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      - name: Parse Roadmap Results
        id: parse-align
        env:
          RAW_OUTPUT: ${{ steps.align.outputs.findings }}
          MILESTONE_FROM_ACTION: ${{ steps.align.outputs.milestone }}
        run: |
          # Save output for debugging
          echo "$RAW_OUTPUT" > /tmp/align-output.txt

          # Parse milestone (from composite action output or raw parsing)
          MILESTONE="$MILESTONE_FROM_ACTION"
          if [ -z "$MILESTONE" ]; then
            MILESTONE=$(echo "$RAW_OUTPUT" | grep -oP '"milestone"\s*:\s*"\K[^"]+' || echo "")
          fi

          # Parse priority
          PRIORITY=$(echo "$RAW_OUTPUT" | grep -oP '"priority"\s*:\s*"\K[^"]+' || echo "P2")

          echo "milestone=$MILESTONE" >> $GITHUB_OUTPUT
          echo "priority=$PRIORITY" >> $GITHUB_OUTPUT

      - name: Apply Labels
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          LABELS: ${{ steps.parse-categorize.outputs.labels }}
          PRIORITY: ${{ steps.parse-align.outputs.priority }}
        run: |
          # Apply category labels
          if [ -n "$LABELS" ]; then
            for label in $LABELS; do
              # Check if label exists, create if not
              if ! gh label list --search "$label" --json name -q '.[].name' | grep -q "^${label}$"; then
                echo "Creating label: $label"
                gh label create "$label" --description "Auto-created by AI triage" || true
              fi
              echo "Adding label: $label"
              gh issue edit "$ISSUE_NUMBER" --add-label "$label" || true
            done
          fi

          # Apply priority label
          if [ -n "$PRIORITY" ]; then
            PRIORITY_LABEL="priority:$PRIORITY"
            if ! gh label list --search "$PRIORITY_LABEL" --json name -q '.[].name' | grep -q "^${PRIORITY_LABEL}$"; then
              echo "Creating label: $PRIORITY_LABEL"
              gh label create "$PRIORITY_LABEL" --description "Priority level" --color "FFA500" || true
            fi
            echo "Adding priority label: $PRIORITY_LABEL"
            gh issue edit "$ISSUE_NUMBER" --add-label "$PRIORITY_LABEL" || true
          fi

      - name: Assign Milestone
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          MILESTONE: ${{ steps.parse-align.outputs.milestone }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          if [ -n "$MILESTONE" ] && [ "$MILESTONE" != "null" ]; then
            # Check if milestone exists
            if gh api "repos/$GITHUB_REPOSITORY/milestones" --jq '.[].title' | grep -q "^${MILESTONE}$"; then
              echo "Assigning milestone: $MILESTONE"
              gh issue edit "$ISSUE_NUMBER" --milestone "$MILESTONE" || true
            else
              echo "Milestone not found: $MILESTONE (skipping)"
            fi
          fi

      - name: Post Triage Summary
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          CATEGORY: ${{ steps.parse-categorize.outputs.category }}
          LABELS: ${{ steps.parse-categorize.outputs.labels }}
          PRIORITY: ${{ steps.parse-align.outputs.priority }}
          MILESTONE: ${{ steps.parse-align.outputs.milestone }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          SERVER_URL: ${{ github.server_url }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # Get priority emoji
          get_priority_emoji() {
            case "$1" in
              P0) echo "ğŸ”´" ;;
              P1) echo "ğŸŸ " ;;
              P2) echo "ğŸŸ¡" ;;
              P3) echo "ğŸŸ¢" ;;
              *) echo "âšª" ;;
            esac
          }
          PRIORITY_EMOJI=$(get_priority_emoji "$PRIORITY")

          cat > /tmp/triage-comment.md << EOF
          <!-- AI-ISSUE-TRIAGE -->

          ## ğŸ¤– AI Triage Summary

          > [!NOTE]
          > This issue has been automatically triaged by AI agents

          <details>
          <summary>ğŸ“‹ What is AI Triage?</summary>

          This issue was analyzed by two AI agents:

          - **ğŸ“Š Analyst Agent**: Categorizes the issue and suggests appropriate labels
          - **ğŸ—ºï¸ Roadmap Agent**: Aligns the issue with project milestones and priorities

          </details>

          ### ğŸ“Š Triage Results

          | Property | Value |
          |:---------|:------|
          | ğŸ“ **Category** | \`$CATEGORY\` |
          | ğŸ·ï¸ **Labels** | ${LABELS:-*None assigned*} |
          | $PRIORITY_EMOJI **Priority** | \`$PRIORITY\` |
          | ğŸ¯ **Milestone** | ${MILESTONE:-*Not assigned*} |

          <details>
          <summary>ğŸ” Categorization Analysis</summary>

          \`\`\`json
          $(cat /tmp/categorize-output.txt 2>/dev/null || echo "N/A")
          \`\`\`

          </details>

          <details>
          <summary>ğŸ—ºï¸ Roadmap Alignment</summary>

          \`\`\`json
          $(cat /tmp/align-output.txt 2>/dev/null || echo "N/A")
          \`\`\`

          </details>

          ---

          <sub>ğŸ¤– Powered by [AI Issue Triage](https://github.com/$GITHUB_REPOSITORY) Â· [View Workflow]($SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_ID)</sub>
          EOF

          source .github/scripts/ai-review-common.sh
          post_issue_comment "$ISSUE_NUMBER" "/tmp/triage-comment.md" "AI-ISSUE-TRIAGE"
