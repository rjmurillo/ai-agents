name: Homework Scanner

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: read
  issues: write
  pull-requests: read

concurrency:
  group: homework-scanner-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  scan:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: "3.12"

      - name: Scan PR for homework items
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python scripts/homework_scanner.py \
            --pr "$PR_NUMBER" \
            --repo "$GITHUB_REPOSITORY" \
            --output homework-results.json

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: homework-scan-results
          path: homework-results.json
          retention-days: 30
          if-no-files-found: ignore
