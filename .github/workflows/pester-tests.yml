# Pester Tests for PowerShell Scripts
#
# Runs Pester unit tests for all PowerShell scripts in the repository.
# Uses dorny/paths-filter to determine if tests should run or be skipped.
#
# IMPORTANT: This workflow runs on ALL PRs to satisfy required status checks,
# but skips actual test execution when no testable files are changed.
#
# Testable paths:
# - Installation scripts (scripts/)
# - Build automation (build/)
# - GitHub Actions helpers (.github/scripts/)
# - Claude skills (.claude/skills/)
# - Root-level tests (tests/)
#
# Local developers and AI agents can run the same tests using:
#   pwsh ./build/scripts/Invoke-PesterTests.ps1

name: Pester Tests

on:
  push:
    branches:
      - main
      - 'feat/**'
      - 'fix/**'
  pull_request:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

jobs:
  check-paths:
    name: Check Changed Paths
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      # For workflow_dispatch, always run tests; otherwise use paths-filter result
      should-run-tests: ${{ github.event_name == 'workflow_dispatch' && 'true' || steps.filter.outputs.testable }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Check for testable file changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
        id: filter
        # Skip paths-filter for workflow_dispatch as it may not have proper context
        if: github.event_name != 'workflow_dispatch'
        with:
          filters: |
            testable:
              - 'scripts/**'
              - 'build/**'
              - '.github/scripts/**'
              - '.github/workflows/pester-tests.yml'
              - '.claude/skills/**'
              - 'tests/**'

      - name: Report path check result
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger - running all tests"
          else
            echo "Testable files changed: ${{ steps.filter.outputs.testable }}"
          fi

  test:
    name: Run Pester Tests
    needs: check-paths
    if: needs.check-paths.outputs.should-run-tests == 'true'
    runs-on: windows-latest
    permissions:
      contents: read
      checks: write  # Required for dorny/test-reporter to create check runs

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Run Pester Tests
        shell: pwsh
        run: ./build/scripts/Invoke-PesterTests.ps1 -CI

      - name: Upload Test Results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        if: always()
        with:
          name: pester-test-results
          path: ./artifacts/pester-results.xml
          retention-days: 30

      - name: Publish Test Report
        uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5
        if: always()
        with:
          name: Pester Test Report
          path: ./artifacts/pester-results.xml
          reporter: java-junit
          fail-on-error: true

  skip-tests:
    name: Run Pester Tests
    needs: check-paths
    if: needs.check-paths.outputs.should-run-tests != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Skip tests (no testable files changed)
        run: |
          echo "âœ… No testable PowerShell files changed - skipping Pester tests"
          echo ""
          echo "Testable paths that would trigger tests:"
          echo "  - scripts/**"
          echo "  - build/**"
          echo "  - .github/scripts/**"
          echo "  - .github/workflows/pester-tests.yml"
          echo "  - .claude/skills/**"
          echo "  - tests/**"

      - name: Create empty test result for required check
        run: |
          mkdir -p ./artifacts
          cat > ./artifacts/pester-results.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <testsuites tests="0" failures="0" errors="0" time="0">
            <testsuite name="Pester Tests (Skipped)" tests="0" failures="0" errors="0" time="0">
              <!-- No testable files changed - tests skipped -->
            </testsuite>
          </testsuites>
          EOF

      - name: Publish Test Report (skipped)
        uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5
        if: always()
        with:
          name: Pester Test Report
          path: ./artifacts/pester-results.xml
          reporter: java-junit
          fail-on-error: false
