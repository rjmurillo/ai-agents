# Pester Tests for PowerShell Scripts
#
# Runs Pester unit tests for all PowerShell scripts in the repository.
# Uses dorny/paths-filter to determine if tests should run or be skipped.
#
# IMPORTANT: This workflow runs on ALL PRs to satisfy required status checks,
# but skips actual test execution when no testable files are changed.
#
# Testable paths are defined ONCE in the check-paths job filters block.
# See the 'testable' filter for the authoritative list.
#
# Local developers and AI agents can run the same tests using:
#   pwsh ./build/scripts/Invoke-PesterTests.ps1
#
# Code coverage is enabled in CI and checked against baseline thresholds
# from .baseline/coverage-thresholds.json. The build will fail if coverage
# drops below the established baseline for any test file.

name: Pester Tests

on:
  push:
    branches:
      - main
      - 'feat/**'
      - 'fix/**'
  pull_request:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

jobs:
  check-paths:
    name: Check Changed Paths
    # ADR-025: ARM runner for cost optimization (37.5% savings vs x64)
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
    outputs:
      # For workflow_dispatch, always run tests; otherwise use paths-filter result
      should-run-tests: ${{ github.event_name == 'workflow_dispatch' && 'true' || steps.filter.outputs.testable }}
      # Export testable paths for skip-tests job to display (issue #144: single source of truth)
      testable-paths: ${{ steps.filter.outputs.testable_files }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Check for testable file changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
        id: filter
        # Skip paths-filter for workflow_dispatch as it may not have proper context
        if: github.event_name != 'workflow_dispatch'
        with:
          # SINGLE SOURCE OF TRUTH: All testable paths defined here only (issue #144)
          # Categories:
          #   - scripts/**              : Installation scripts
          #   - build/**                : Build automation
          #   - .github/scripts/**      : GitHub Actions helpers
          #   - .github/tests/**        : GitHub skill tests
          #   - .github/workflows/pester-tests.yml : This workflow
          #   - .claude/skills/**       : Claude skills
          #   - tests/**                : Root-level tests
          #   - .baseline/**            : Coverage thresholds
          list-files: json
          filters: |
            testable:
              - 'scripts/**'
              - 'build/**'
              - '.github/scripts/**'
              - '.github/tests/**'
              - '.github/workflows/pester-tests.yml'
              - '.claude/skills/**'
              - 'tests/**'
              - '.baseline/**'

      - name: Report path check result
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger - running all tests"
          else
            echo "Testable files changed: ${{ steps.filter.outputs.testable }}"
            if [ "${{ steps.filter.outputs.testable }}" = "true" ]; then
              echo "Changed files: ${{ steps.filter.outputs.testable_files }}"
            fi
          fi

  test:
    name: Run Pester Tests
    needs: check-paths
    if: needs.check-paths.outputs.should-run-tests == 'true'
    # Keep on Windows - many tests have Windows-specific assumptions
    # (file paths, hidden files, etc.) that don't work on Linux ARM
    runs-on: windows-latest
    permissions:
      contents: read
      checks: write  # Required for dorny/test-reporter to create check runs

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Run Pester Tests
        shell: pwsh
        run: ./build/scripts/Invoke-PesterTests.ps1 -CI -EnableCodeCoverage -CheckCoverageThreshold

      - name: Upload Test Results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        if: always()
        with:
          name: pester-test-results
          path: ./artifacts/pester-results.xml
          retention-days: 30

      - name: Upload Code Coverage Results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        if: always()
        with:
          name: code-coverage-results
          path: ./artifacts/TestResults/coverage.xml
          retention-days: 30

      - name: Publish Test Report
        uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5
        if: always()
        with:
          name: Pester Test Report
          path: ./artifacts/pester-results.xml
          reporter: java-junit
          fail-on-error: true

  skip-tests:
    name: Skip Pester Tests (No Changes)
    needs: check-paths
    if: needs.check-paths.outputs.should-run-tests != 'true'
    # ADR-025: ARM runner for cost optimization (37.5% savings vs x64)
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      checks: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Skip tests (no testable files changed)
        run: |
          echo "No testable PowerShell files changed - skipping Pester tests"
          echo ""
          echo "See the 'testable' filter in check-paths job for paths that trigger tests."
          echo "Reference: .github/workflows/pester-tests.yml"

      - name: Create empty test result for required check
        run: |
          mkdir -p ./artifacts
          cat > ./artifacts/pester-results.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <testsuites tests="0" failures="0" errors="0" time="0">
            <testsuite name="Pester Tests (Skipped)" tests="0" failures="0" errors="0" time="0">
              <!-- No testable files changed - tests skipped -->
            </testsuite>
          </testsuites>
          EOF

      - name: Publish Test Report (skipped)
        uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5
        if: always()
        with:
          name: Pester Test Report
          path: ./artifacts/pester-results.xml
          reporter: java-junit
          fail-on-error: false
