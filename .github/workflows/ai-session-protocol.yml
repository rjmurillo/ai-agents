name: Session Protocol Validation

# AI-powered session log validation using GitHub Copilot CLI
# Verifies session logs comply with RFC 2119 requirements in SESSION-PROTOCOL.md
# Blocks merge if MUST requirements are not met

on:
  pull_request:
    branches: [main]
    paths:
      - '.agents/sessions/*.md'

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: session-protocol-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  GH_TOKEN: ${{ secrets.BOT_PAT }}

jobs:
  # Identify changed session files and build matrix
  detect-changes:
    name: Detect Changed Sessions
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]'

    outputs:
      has_sessions: ${{ steps.changed.outputs.has_sessions }}
      session_files: ${{ steps.changed.outputs.session_files }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Identify Changed Session Files
        id: changed
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          CHANGED_FILES=$(gh pr diff "$PR_NUMBER" --name-only | grep -E '^\.agents/sessions/.*\.md$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No session files changed"
            echo "has_sessions=false" >> $GITHUB_OUTPUT
            echo "session_files=[]" >> $GITHUB_OUTPUT
          else
            echo "Found changed session files:"
            echo "$CHANGED_FILES"
            echo "has_sessions=true" >> $GITHUB_OUTPUT

            # Convert to JSON array for matrix
            JSON_ARRAY=$(echo "$CHANGED_FILES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "session_files=$JSON_ARRAY" >> $GITHUB_OUTPUT
          fi

  # Validate each session file in parallel using matrix strategy
  validate:
    name: Validate ${{ matrix.session_file }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_sessions == 'true'
    timeout-minutes: 10

    strategy:
      fail-fast: false # Don't cancel other validations if one fails
      matrix:
        session_file: ${{ fromJson(needs.detect-changes.outputs.session_files) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Load Protocol Context
        id: protocol
        run: |
          PROTOCOL_FILE=".agents/SESSION-PROTOCOL.md"
          if [ -f "$PROTOCOL_FILE" ]; then
            PROTOCOL_CONTENT=$(cat "$PROTOCOL_FILE")
          else
            PROTOCOL_CONTENT="No protocol file found"
          fi

          # Save protocol context for the action
          {
            echo "protocol_context<<EOF_PROTOCOL"
            echo "## Protocol Requirements"
            echo ""
            echo "$PROTOCOL_CONTENT"
            echo "EOF_PROTOCOL"
          } >> $GITHUB_OUTPUT

      - name: üìã Validate Session (QA Agent)
        id: review
        uses: ./.github/actions/ai-review
        with:
          agent: qa
          context-type: session-log
          context-path: ${{ matrix.session_file }}
          additional-context: ${{ steps.protocol.outputs.protocol_context }}
          prompt-file: .github/prompts/session-protocol-check.md
          timeout-minutes: 2
          bot-pat: ${{ secrets.BOT_PAT }}
          copilot-token: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      - name: Save validation results
        id: save-results
        env:
          SESSION_FILE: ${{ matrix.session_file }}
          VERDICT: ${{ steps.review.outputs.verdict }}
          FINDINGS: ${{ steps.review.outputs.findings }}
        run: |
          # Create output directory
          mkdir -p validation-results

          # Get safe filename
          FILE_NAME=$(basename "$SESSION_FILE" .md)

          # Write verdict and findings to files
          echo "$VERDICT" > "validation-results/${FILE_NAME}-verdict.txt"
          echo "$FINDINGS" > "validation-results/${FILE_NAME}-findings.txt"

          # Check for MUST failures in findings
          MUST_FAIL_COUNT=$(echo "$FINDINGS" | grep -c "MUST:.*FAIL" || echo "0")
          echo "$MUST_FAIL_COUNT" > "validation-results/${FILE_NAME}-must-failures.txt"

          echo "Saved validation results for $SESSION_FILE"
          echo "  Verdict: $VERDICT"
          echo "  MUST failures: $MUST_FAIL_COUNT"

      - name: Upload validation results
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4
        with:
          name: validation-${{ hashFiles(matrix.session_file) }}
          path: validation-results/
          retention-days: 1

  # Aggregate results and post comment
  aggregate:
    name: Aggregate Results
    runs-on: ubuntu-latest
    needs: [detect-changes, validate]
    if: needs.detect-changes.outputs.has_sessions == 'true'

    outputs:
      final-verdict: ${{ steps.aggregate.outputs.final_verdict }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Download all validation artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4
        with:
          pattern: validation-*
          path: validation-results
          merge-multiple: true

      - name: Aggregate Verdicts
        id: aggregate
        run: |
          source .github/scripts/ai-review-common.sh

          OVERALL_VERDICT="PASS"
          TOTAL_MUST_FAILURES=0

          # Process all verdict files
          for verdict_file in validation-results/*-verdict.txt; do
            if [ -f "$verdict_file" ]; then
              VERDICT=$(cat "$verdict_file")
              log "Found verdict: $VERDICT from $verdict_file"

              if [ "$VERDICT" = "CRITICAL_FAIL" ] || [ "$VERDICT" = "REJECTED" ]; then
                OVERALL_VERDICT="CRITICAL_FAIL"
              elif [ "$VERDICT" = "WARN" ] && [ "$OVERALL_VERDICT" = "PASS" ]; then
                OVERALL_VERDICT="WARN"
              fi
            fi
          done

          # Count MUST failures
          for must_file in validation-results/*-must-failures.txt; do
            if [ -f "$must_file" ]; then
              COUNT=$(cat "$must_file" || echo "0")
              TOTAL_MUST_FAILURES=$((TOTAL_MUST_FAILURES + COUNT))
            fi
          done

          if [ "$TOTAL_MUST_FAILURES" -gt 0 ]; then
            OVERALL_VERDICT="CRITICAL_FAIL"
          fi

          echo "final_verdict=$OVERALL_VERDICT" >> $GITHUB_OUTPUT
          echo "must_failures=$TOTAL_MUST_FAILURES" >> $GITHUB_OUTPUT

          log "Final verdict: $OVERALL_VERDICT (MUST failures: $TOTAL_MUST_FAILURES)"

      - name: Generate Compliance Report
        id: report
        env:
          OVERALL_VERDICT: ${{ steps.aggregate.outputs.final_verdict }}
          MUST_FAILURES: ${{ steps.aggregate.outputs.must_failures }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          SERVER_URL: ${{ github.server_url }}
          RUN_ID: ${{ github.run_id }}
        run: |
          source .github/scripts/ai-review-common.sh

          REPORT_FILE="$AI_REVIEW_DIR/session-compliance-report.md"
          ALERT_TYPE=$(get_verdict_alert_type "$OVERALL_VERDICT")

          # Helper function to get verdict emoji
          get_verdict_emoji() {
            case "$1" in
              PASS) echo "‚úÖ" ;;
              WARN) echo "‚ö†Ô∏è" ;;
              CRITICAL_FAIL|REJECTED|FAIL) echo "‚ùå" ;;
              *) echo "‚ùî" ;;
            esac
          }
          FINAL_EMOJI=$(get_verdict_emoji "$OVERALL_VERDICT")

          # Build verdict message
          if [ "$MUST_FAILURES" -gt 0 ]; then
            VERDICT_MSG="$MUST_FAILURES MUST requirement(s) not met. These must be addressed before merge."
          else
            VERDICT_MSG="All session protocol requirements satisfied."
          fi

          # Count files checked
          FILES_CHECKED=$(find validation-results -name "*-verdict.txt" | wc -l)

          cat > "$REPORT_FILE" << EOF
          <!-- AI-SESSION-PROTOCOL -->

          ## üìã Session Protocol Compliance Report

          > [!$ALERT_TYPE]
          > $FINAL_EMOJI **Overall Verdict: $OVERALL_VERDICT**
          >
          > $VERDICT_MSG

          <details>
          <summary>üìñ What is Session Protocol?</summary>

          Session logs document agent work sessions and must comply with RFC 2119 requirements:

          - **MUST**: Required for compliance (blocking failures)
          - **SHOULD**: Recommended practices (warnings)
          - **MAY**: Optional enhancements

          See [\`.agents/SESSION-PROTOCOL.md\`](.agents/SESSION-PROTOCOL.md) for full specification.

          </details>

          ### üìä Compliance Summary

          | Session File | Verdict | MUST Failures |
          |:-------------|:--------|:-------------:|
          EOF

          # Add summary row for each session file
          for verdict_file in validation-results/*-verdict.txt; do
            if [ -f "$verdict_file" ]; then
              FILE_NAME=$(basename "$verdict_file" -verdict.txt)
              VERDICT=$(cat "$verdict_file")
              MUST_FILE="validation-results/${FILE_NAME}-must-failures.txt"
              MUST_COUNT=$(cat "$MUST_FILE" 2>/dev/null || echo "0")
              EMOJI=$(get_verdict_emoji "$VERDICT")

              echo "| \`$FILE_NAME.md\` | $EMOJI $VERDICT | $MUST_COUNT |" >> "$REPORT_FILE"
            fi
          done

          # Add detailed findings
          echo "" >> "$REPORT_FILE"
          echo "### üîç Detailed Results" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"

          for findings_file in validation-results/*-findings.txt; do
            if [ -f "$findings_file" ]; then
              FILE_NAME=$(basename "$findings_file" -findings.txt)
              echo "<details>" >> "$REPORT_FILE"
              echo "<summary>üìÑ $FILE_NAME</summary>" >> "$REPORT_FILE"
              echo "" >> "$REPORT_FILE"
              cat "$findings_file" >> "$REPORT_FILE"
              echo "" >> "$REPORT_FILE"
              echo "</details>" >> "$REPORT_FILE"
              echo "" >> "$REPORT_FILE"
            fi
          done

          # Add footer
          cat >> "$REPORT_FILE" << EOF

          ---

          <details>
          <summary>‚ÑπÔ∏è Run Details</summary>

          | Property | Value |
          |:---------|:------|
          | **Run ID** | [$RUN_ID]($SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_ID) |
          | **Files Checked** | $FILES_CHECKED |

          </details>

          <sub>ü§ñ Powered by [AI Session Protocol Validator](https://github.com/$GITHUB_REPOSITORY) ¬∑ [View Workflow]($SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_ID)</sub>
          EOF

          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT

      - name: Post PR Comment
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPORT_FILE: ${{ steps.report.outputs.report_file }}
        run: |
          source .github/scripts/ai-review-common.sh
          post_pr_comment "$PR_NUMBER" "$REPORT_FILE" "AI-SESSION-PROTOCOL"

      - name: Set Job Summary
        env:
          REPORT_FILE: ${{ steps.report.outputs.report_file }}
        run: |
          cat "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY

      - name: Enforce MUST Requirements
        env:
          MUST_FAILURES: ${{ steps.aggregate.outputs.must_failures }}
          FINAL_VERDICT: ${{ steps.aggregate.outputs.final_verdict }}
        run: |
          if [ "$FINAL_VERDICT" = "CRITICAL_FAIL" ] || [ "$MUST_FAILURES" -gt 0 ]; then
            echo "::error::Session protocol validation failed: $MUST_FAILURES MUST requirement(s) not met"
            exit 1
          fi

          echo "Session protocol validation passed"
