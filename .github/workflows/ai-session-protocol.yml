name: Session Protocol Validation

# Deterministic session log validation using validate_session_json.py

# Verifies session logs comply with RFC 2119 requirements in SESSION-PROTOCOL.md

# Blocks merge if MUST requirements are not met

# Zero-token validation: outputs structured data directly to Job Summary

on:
  pull_request:
    branches: [main]
    paths:
      - '.agents/sessions/*.json'

permissions:
  contents: read
  pull-requests: write

# Concurrency control: Attempts to cancel in-progress runs when new runs start

# NOTE: GitHub Actions does NOT guarantee run coalescing - race conditions can occur

# where multiple runs start before cancellation takes effect. This is best-effort

# See ADR-026 (../.agents/architecture/ADR-026-pr-automation-concurrency-and-safety.md)

# for architectural decision on workflow-level concurrency control

# Mitigation: Path filtering, timeouts, and PR-specific temp files reduce impact

# Note: Matrix strategy with fail-fast: false allows independent validation

concurrency:
  group: session-protocol-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  GH_TOKEN: ${{ secrets.BOT_PAT }}

jobs:

# Identify changed session files and build matrix

  detect-changes:
    name: Detect Changed Sessions
    # ADR-025: ARM runner for cost optimization (37.5% savings vs x64)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 3
    if: github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]'

    outputs:
      has_sessions: ${{ steps.changed.outputs.has_sessions }}
      session_files: ${{ steps.changed.outputs.session_files }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Identify Changed Session Files
        id: changed
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_REPO: ${{ github.repository }}
          # Issue #215: Session End checklist requirement introduced 2025-12-21
          # Historical sessions before this date are exempt from validation
          CUTOFF_DATE: "2025-12-21"
        run: |
          # Use files API instead of gh pr diff (no line limit - fixes issue #468)
          # Include both .md (legacy) and .json (new format)
          ALL_CHANGED=$(gh api "repos/$GH_REPO/pulls/$PR_NUMBER/files" --paginate --jq '.[].filename' | grep -E '^\.agents/sessions/.*\.(md|json)$' || true)

          if [ -z "$ALL_CHANGED" ]; then
            echo "No session files changed"
            echo "has_sessions=false" >> $GITHUB_OUTPUT
            echo "session_files=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "All changed session files:"
          echo "$ALL_CHANGED"

          # Filter out historical sessions (issue #215)
          # Session filename pattern: YYYY-MM-DD-session-NN.md or YYYY-MM-DD-session-NN-description.md
          CHANGED_FILES=""
          SKIPPED_FILES=""
          while IFS= read -r file; do
            # Extract date from filename (first 10 characters after path)
            filename=$(basename "$file")
            file_date="${filename:0:10}"

            # Validate date format (YYYY-MM-DD)
            if [[ "$file_date" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              if [[ "$file_date" < "$CUTOFF_DATE" ]]; then
                SKIPPED_FILES="${SKIPPED_FILES}${file}"$'\n'
              else
                CHANGED_FILES="${CHANGED_FILES}${file}"$'\n'
              fi
            else
              # Non-standard filename, include for validation
              CHANGED_FILES="${CHANGED_FILES}${file}"$'\n'
            fi
          done <<< "$ALL_CHANGED"

          # Remove trailing newlines
          CHANGED_FILES=$(echo "$CHANGED_FILES" | sed '/^$/d')
          SKIPPED_FILES=$(echo "$SKIPPED_FILES" | sed '/^$/d')

          if [ -n "$SKIPPED_FILES" ]; then
            echo ""
            echo "Skipped historical sessions (before $CUTOFF_DATE):"
            echo "$SKIPPED_FILES"
          fi

          if [ -z "$CHANGED_FILES" ]; then
            echo ""
            echo "No validatable session files (all historical)"
            echo "has_sessions=false" >> $GITHUB_OUTPUT
            echo "session_files=[]" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "Session files to validate:"
            echo "$CHANGED_FILES"
            echo "has_sessions=true" >> $GITHUB_OUTPUT

            # Convert to JSON array for matrix
            JSON_ARRAY=$(echo "$CHANGED_FILES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "session_files=$JSON_ARRAY" >> $GITHUB_OUTPUT
          fi

# Validate each session file in parallel using matrix strategy

  validate:
    name: Validate ${{ matrix.session_file }}
    # ADR-025: ARM runner for cost optimization (37.5% savings vs x64)
    runs-on: ubuntu-24.04-arm
    needs: detect-changes
    if: needs.detect-changes.outputs.has_sessions == 'true'
    timeout-minutes: 5

    strategy:
      fail-fast: false # Don't cancel other validations if one fails
      matrix:
        session_file: ${{ fromJson(needs.detect-changes.outputs.session_files) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Fetch origin/main for HANDOFF validation
        run: |
          # Fetch origin/main with enough history for merge-base calculation
          # The three-dot diff syntax (origin/main...HEAD) needs merge-base
          git fetch origin main --unshallow || git fetch origin main

      - name: Validate Session Protocol
        id: validate
        shell: pwsh
        env:
          SESSION_FILE: ${{ matrix.session_file }}
        run: |
          $sessionFile = $env:SESSION_FILE

          # Check if file exists (may have been deleted in a later commit)
          if (-not (Test-Path $sessionFile)) {
            Write-Host "File $sessionFile was deleted - skipping validation"
            $mdResult = "# Session Validation: $sessionFile`n`nResult: SKIPPED (file deleted)`n"
            $mdResult | Out-File -FilePath "validation-result.md" -Encoding UTF8

            # Create verdict files for reporting
            New-Item -Path "validation-results" -ItemType Directory -Force | Out-Null
            $baseName = [System.IO.Path]::GetFileNameWithoutExtension($sessionFile)
            "SKIPPED" | Out-File -FilePath "validation-results/$baseName-verdict.txt" -Encoding UTF8
            "0" | Out-File -FilePath "validation-results/$baseName-must-failures.txt" -Encoding UTF8

            exit 0
          }

          $extension = [System.IO.Path]::GetExtension($sessionFile)

          # Use appropriate validator based on file type
          if ($extension -eq '.json') {
            # JSON format - simple schema validation
            $result = & python3 ./scripts/validate_session_json.py $sessionFile 2>&1
            $exitCode = $LASTEXITCODE
            $format = 'JSON'
          } else {
            # Legacy markdown format - migrate to JSON first, then validate
            Write-Host "Legacy markdown detected - migrating to JSON for validation"
            $jsonPath = $sessionFile -replace '\.md$', '.json'

            # Migrate
            & ./scripts/Convert-SessionToJson.ps1 -Path $sessionFile -Force 2>&1 | Out-Null

            if (Test-Path $jsonPath) {
              $result = & python3 ./scripts/validate_session_json.py $jsonPath 2>&1
              $exitCode = $LASTEXITCODE
            } else {
              $result = @("Migration failed - could not convert markdown to JSON")
              $exitCode = 1
            }
            $format = 'Markdown (legacy)'
          }
          
          # Build markdown output
          $fileName = Split-Path $sessionFile -Leaf
          $status = if ($exitCode -eq 0) { 'PASS' } else { 'FAIL' }
          $mdResult = "# Session Validation: $fileName`n`nFormat: $format`nResult: $status`n`n" + '```' + "`n$($result -join "`n")`n" + '```'
          $mdResult | Out-File -FilePath "validation-result.md" -Encoding UTF8

          # Save markdown output for artifact
          $result | Out-File -FilePath "validation-result.md" -Encoding UTF8
          
          # Create simplified results directory
          New-Item -ItemType Directory -Force -Path "validation-results" | Out-Null

          # Include parent directory to prevent collisions (e.g., sessions vs archive)
          $fileInfo = Get-Item $env:SESSION_FILE
          $parentDir = $fileInfo.Directory.Name
          $baseName = [System.IO.Path]::GetFileNameWithoutExtension($fileInfo.Name)
          $fileName = "${parentDir}-${baseName}"

          # Set output for artifact naming
          "artifact-name=$fileName" >> $env:GITHUB_OUTPUT
          
          # Determine verdict based on exit code
          $verdict = if ($exitCode -eq 0) { "COMPLIANT" } else { "NON_COMPLIANT" }
          $verdict | Out-File -FilePath "validation-results/${fileName}-verdict.txt" -Encoding UTF8
          
          # Save markdown output
          $result | Out-File -FilePath "validation-results/${fileName}-findings.txt" -Encoding UTF8
          
          # Count MUST failures (look for FAIL in MUST level checks)
          # Pattern matches markdown table rows: | CheckName | MUST | FAIL |
          $mustFailCount = 0
          if ($result -match '(?m)^\|\s*\w+\s*\|\s*MUST\s*\|\s*FAIL\s*\|') {
            $mustFailCount = ([regex]::Matches($result, '(?m)^\|\s*\w+\s*\|\s*MUST\s*\|\s*FAIL\s*\|')).Count
          }
          $mustFailCount | Out-File -FilePath "validation-results/${fileName}-must-failures.txt" -Encoding UTF8
          
          Write-Host "Validation complete for $env:SESSION_FILE"
          Write-Host "  Verdict: $verdict"
          Write-Host "  MUST failures: $mustFailCount"
          Write-Host "  Exit code: $exitCode"
          
          # Exit with same code as validation script
          exit $exitCode

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: validation-${{ steps.validate.outputs.artifact-name }}
          path: validation-results/
          retention-days: 1

# Validate investigation-only claims (advisory, non-blocking)
# ADR-034 defense-in-depth: re-checks allowlist compliance post-commit

  validate-investigation-claims:
    name: Validate Investigation Claims
    runs-on: ubuntu-24.04-arm
    needs: detect-changes
    if: needs.detect-changes.outputs.has_sessions == 'true'
    timeout-minutes: 3

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 2

      - name: Validate investigation-only claims
        id: validate-claims
        run: python3 .github/scripts/validate_investigation_claims.py

# Pass-through job: satisfies required "Aggregate Results" check when path
# filter skips the real aggregate job. GitHub branch protection requires
# SUCCESS (not SKIPPED) for required checks. See issue #1168.

  aggregate-skip:
    name: Aggregate Results
    runs-on: ubuntu-24.04-arm
    needs: [detect-changes]
    if: always() && needs.detect-changes.result == 'success' && needs.detect-changes.outputs.has_sessions != 'true'
    steps:
      - run: echo "Skipped - no session file changes detected"

# Aggregate results and post comment

  aggregate:
    name: Aggregate Results
    # ADR-025: ARM runner for cost optimization (37.5% savings vs x64)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 10
    needs: [detect-changes, validate]
    # Always run if sessions detected, even if validate fails (enforcement step must execute)
    if: always() && needs.detect-changes.outputs.has_sessions == 'true'

    outputs:
      final-verdict: ${{ steps.aggregate.outputs.final_verdict }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Download all validation artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          pattern: validation-*
          path: validation-results
          merge-multiple: true

      - name: Aggregate Verdicts
        id: aggregate
        run: python3 .github/scripts/aggregate_session_verdicts.py

      - name: Generate Compliance Report
        id: report
        env:
          OVERALL_VERDICT: ${{ steps.aggregate.outputs.final_verdict }}
          MUST_FAILURES: ${{ steps.aggregate.outputs.must_failures }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          SERVER_URL: ${{ github.server_url }}
          RUN_ID: ${{ github.run_id }}
        run: python3 .github/scripts/generate_session_report.py

      - name: Post PR Comment
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPORT_FILE: ${{ steps.report.outputs.report_file }}
        run: |
          python3 .github/scripts/post_issue_comment.py \
            --issue "$PR_NUMBER" \
            --body-file "$REPORT_FILE" \
            --marker "AI-SESSION-PROTOCOL"

      - name: Set Job Summary
        shell: pwsh -NoProfile -Command "& '{0}'"
        env:
          REPORT_FILE: ${{ steps.report.outputs.report_file }}
        run: |
          Get-Content $env:REPORT_FILE | Add-Content $env:GITHUB_STEP_SUMMARY

      - name: Enforce MUST Requirements
        shell: pwsh -NoProfile -Command "& '{0}'"
        env:
          MUST_FAILURES: ${{ steps.aggregate.outputs.must_failures }}
          FINAL_VERDICT: ${{ steps.aggregate.outputs.final_verdict }}
        run: |
          if ($env:FINAL_VERDICT -eq 'CRITICAL_FAIL' -or [int]$env:MUST_FAILURES -gt 0) {
            Write-Output "::error::Session protocol validation failed: $($env:MUST_FAILURES) MUST requirement(s) not met"
            exit 1
          }

          Write-Output "Session protocol validation passed"
