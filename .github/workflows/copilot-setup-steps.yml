name: Copilot Workspace Setup

# This workflow runs setup steps for GitHub Copilot Workspace environments
# to ensure git hooks and linting tools are properly configured.
#
# This workflow also provides GitHub CLI access for GitHub Copilot agents to monitor
# workflows, view logs, and interact with the repository programmatically.
#
# The GH_TOKEN environment variable enables gh CLI commands without authentication.
#
# Triggers:
# - workflow_dispatch: Manual trigger for testing or re-setup
# - workflow_call: Can be called from other workflows or Copilot Workspace creation scripts

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "Reason for running setup"
        required: false
        default: "Manual setup trigger"
  workflow_call:
    # Allow this workflow to be called by other workflows

permissions:
  contents: read
  actions: read
  pull-requests: read

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    name: Configure Git Hooks and Linting Tools
    # NOTE: Copilot agent runtime requires x86_64 architecture (ADR-032 exception)
    # ARM runners cannot be used here despite cost savings
    runs-on: ubuntu-latest

    env:
      # Enable GitHub CLI for GitHub agents or scripts
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0

      - name: Setup code environment
        uses: ./.github/actions/setup-code-env
        with:
          gh-token: ${{ github.token }}
          enable-pester: true
          enable-git-hooks: true
          enable-python: true
          python-version: '3.12'
          skip-autofix: 0
