name: Copilot Workspace Setup

# This workflow runs setup steps for GitHub Copilot Workspace environments
# to ensure git hooks and linting tools are properly configured.
#
# This workflow also provides GitHub CLI access for GitHub Copilot agents to monitor
# workflows, view logs, and interact with the repository programmatically.
#
# The GH_TOKEN environment variable enables gh CLI commands without authentication.
#
# Triggers:
# - workflow_dispatch: Manual trigger for testing or re-setup
# - workflow_call: Can be called from other workflows or Copilot Workspace creation scripts

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "Reason for running setup"
        required: false
        default: "Manual setup trigger"
  workflow_call:
    # Allow this workflow to be called by other workflows

permissions:
  contents: read
  actions: read
  pull-requests: read

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    name: Configure Git Hooks and Linting Tools
    # NOTE: Copilot agent runtime requires x86_64 architecture (ADR-032 exception)
    # ARM runners cannot be used here despite cost savings
    runs-on: ubuntu-latest

    env:
      # Enable GitHub CLI for GitHub agents or scripts
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: "lts/*"

      - name: Verify Node.js installation
        run: |
          echo "Verifying Node.js installation..."
          node --version
          npm --version
          echo ""
          echo "✓ Node.js and npm are ready"

      - name: Verify GitHub CLI availability
        run: |
          echo "Verifying GitHub CLI availability..."
          gh --version
          echo ""
          echo "✓ GitHub CLI is available"
          echo "✓ GH_TOKEN is configured for Copilot agents"

      - name: Enable git hooks
        run: |
          echo "Configuring git hooks..."
          git config core.hooksPath .githooks
          echo "✓ Git hooks enabled at .githooks/"

          # Verify hooks are configured
          HOOKS_PATH=$(git config --get core.hooksPath)
          echo "Current hooks path: $HOOKS_PATH"

      - name: Install markdownlint-cli2
        run: |
          echo "Installing markdownlint-cli2..."
          npm install --global markdownlint-cli2
          echo "✓ markdownlint-cli2 installed"

      - name: Install uv (Python package manager)
        run: |
          echo "Installing uv..."
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "✓ uv installed"

      - name: Start Forgetful MCP Server
        run: |
          echo "Starting Forgetful MCP server..."
          # Install and start forgetful in HTTP mode (stdio has FastMCP banner issue)
          # See: https://github.com/ScottRBK/forgetful/issues/19
          $HOME/.local/bin/uvx forgetful-ai --transport http --port 8020 &
          FORGETFUL_PID=$!
          echo "FORGETFUL_PID=$FORGETFUL_PID" >> $GITHUB_ENV

          # Wait for server to be ready
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8020/health > /dev/null 2>&1; then
              echo "✓ Forgetful MCP server running on http://localhost:8020/mcp"
              break
            fi
            sleep 1
          done

          # Verify health endpoint
          HEALTH=$(curl -s http://localhost:8020/health 2>&1 || echo '{"status":"error"}')
          echo "Health check: $HEALTH"

      - name: Install Pester
        shell: pwsh -NoProfile -Command "& '{0}'"
        run: |
          echo "Installing Pester testing framework..."
          Set-PSRepository -Name 'PSGallery' -InstallationPolicy Trusted
          # Pin to specific version for supply chain security (issue #304)
          Install-Module -Name Pester -RequiredVersion 5.7.1 -Force -Scope CurrentUser
          Import-Module Pester -RequiredVersion 5.7.1
          $pesterVersion = (Get-Module Pester).Version
          echo "✓ Pester $pesterVersion installed"

      - name: Set SKIP_AUTOFIX environment variable
        run: |
          echo "SKIP_AUTOFIX=0" >> $GITHUB_ENV
          echo "✓ SKIP_AUTOFIX set to 0 (auto-fix enabled)"

      - name: Verify setup
        shell: pwsh -NoProfile -Command "& '{0}'"
        run: |
          Write-Host ""
          Write-Host "=== Setup Verification ===" -ForegroundColor Cyan
          Write-Host "Git hooks path: $(git config --get core.hooksPath)"
          Write-Host "SKIP_AUTOFIX: $($env:SKIP_AUTOFIX ?? '0') (0=enabled, 1=disabled)"
          Write-Host ""

          # Test that tools are available
          if (Get-Command npx -ErrorAction SilentlyContinue) {
            Write-Host "✓ npx is available" -ForegroundColor Green
            # Check if markdownlint-cli2 is available (--help may return non-zero)
            $null = npx markdownlint-cli2 --help 2>&1
            Write-Host "✓ markdownlint-cli2 is installed" -ForegroundColor Green
          }

          if (Get-Command gh -ErrorAction SilentlyContinue) {
            Write-Host "✓ GitHub CLI is available for workflow monitoring" -ForegroundColor Green
          }

          # Test Forgetful MCP
          try {
            $health = Invoke-RestMethod -Uri "http://localhost:8020/health" -Method Get -ErrorAction Stop
            Write-Host "✓ Forgetful MCP server is running (v$($health.version))" -ForegroundColor Green
          } catch {
            Write-Host "⚠ Forgetful MCP server not responding (may still be starting)" -ForegroundColor Yellow
          }

          # Test Pester
          $pester = Get-Module -ListAvailable -Name Pester | Select-Object -First 1
          if ($pester) {
            Write-Host "✓ Pester $($pester.Version) is installed" -ForegroundColor Green
          }

          # Test powershell-yaml (optional)
          $yaml = Get-Module -ListAvailable -Name powershell-yaml | Select-Object -First 1
          if ($yaml) {
            Write-Host "✓ powershell-yaml $($yaml.Version) is installed" -ForegroundColor Green
          }

          Write-Host ""
          Write-Host "✓ Setup complete! Pre-commit hooks will auto-fix linting issues." -ForegroundColor Green

          # Explicitly exit with success (previous commands may have set $LASTEXITCODE)
          exit 0
