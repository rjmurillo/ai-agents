# Verify Install Script
#
# Runs install.ps1 across supported platforms/scopes and verifies expected files
# using scripts/tests/Verify-InstallOutput.ps1.

name: Verify Install Script

on:
  push:
    branches:
      - main
      - 'feat/**'
      - 'fix/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  check-paths:
    name: Check Changed Paths
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
    outputs:
      should-run-tests: ${{ github.event_name == 'workflow_dispatch' && 'true' || steps.filter.outputs.install }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2

      - name: Check for install-related changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        if: github.event_name != 'workflow_dispatch'
        with:
          filters: |
            install:
              - 'scripts/install.ps1'
              - 'scripts/lib/**'
              - 'scripts/tests/Verify-InstallOutput.ps1'
              - 'scripts/tests/Verify-InstallOutput.Tests.ps1'
              - 'src/**'
              - '.github/workflows/verify-install-script.yml'

      - name: Report path check result
        shell: pwsh
        run: |
          if ('${{ github.event_name }}' -eq 'workflow_dispatch') {
            Write-Host "Manual trigger - running install verification"
          } else {
            Write-Host "Install-related files changed: ${{ steps.filter.outputs.install }}"
          }

  verify-install:
    name: Verify Install (${{ matrix.os }}, ${{ matrix.environment }}, ${{ matrix.scope }})
    needs: check-paths
    if: needs.check-paths.outputs.should-run-tests == 'true'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        environment: [Claude, Copilot, VSCode]
        scope: [Global, Repo]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2

      - name: Set APPDATA for non-Windows runners
        if: runner.os != 'Windows'
        shell: pwsh
        run: |
          $env:APPDATA = if ('${{ runner.os }}' -eq 'macOS') {
            Join-Path $env:HOME 'Library/Application Support'
          } else {
            Join-Path $env:HOME '.config'
          }
          "APPDATA=$env:APPDATA" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Run install script
        shell: pwsh
        run: |
          if ('${{ matrix.scope }}' -eq 'Global') {
            ./scripts/install.ps1 -Environment ${{ matrix.environment }} -Global -Force
          } else {
            ./scripts/install.ps1 -Environment ${{ matrix.environment }} -RepoPath . -Force
          }

      - name: Verify installation output
        shell: pwsh
        run: |
          if ('${{ matrix.scope }}' -eq 'Global') {
            ./scripts/tests/Verify-InstallOutput.ps1 -Environment ${{ matrix.environment }} -Scope ${{ matrix.scope }} -CI
          } else {
            ./scripts/tests/Verify-InstallOutput.ps1 -Environment ${{ matrix.environment }} -Scope ${{ matrix.scope }} -RepoPath . -CI
          }

  skip-verify-install:
    name: Verify Install (Skipped)
    needs: check-paths
    if: needs.check-paths.outputs.should-run-tests != 'true'
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2

      - name: Skip install verification
        shell: pwsh
        run: Write-Host "No install-related files changed - skipping verification"
