name: AI PR Quality Gate

# AI-powered PR review using GitHub Copilot CLI

# Invokes security, qa, and analyst agents to review PRs IN PARALLEL

# Blocks merge if CRITICAL_FAIL detected

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**'
      - 'scripts/**'
      - 'build/**'
      - '.github/**'
      - '.agents/**'

  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ai-quality-${{ github.event.pull_request.number || inputs.pr_number }}
  cancel-in-progress: true

env:

# Compute PR number from either pull_request event or workflow_dispatch input

  PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}

jobs:

# Quick check to see if we should skip AI review (docs-only changes)

  check-changes:
    name: Check Changes
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]'

    outputs:
      skip_review: ${{ steps.check.outputs.skip_review }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Check for docs-only changes
        id: check
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        run: |
          CHANGED_FILES=$(gh pr diff ${{ env.PR_NUMBER }} --name-only)

          # Check if only documentation files changed
          NON_DOC_FILES=$(echo "$CHANGED_FILES" | grep -vE '\.(md|txt|rst)$' | grep -v '^docs/' || true)

          if [ -z "$NON_DOC_FILES" ]; then
            echo "Only documentation files changed, skipping AI review"
            echo "skip_review=true" >> $GITHUB_OUTPUT
          else
            echo "Code files changed, proceeding with AI review"
            echo "skip_review=false" >> $GITHUB_OUTPUT
          fi

# Run all three reviews in parallel using matrix strategy

  review:
    name: ${{ matrix.agent }} Review
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.skip_review != 'true'
    timeout-minutes: 10

    strategy:
      fail-fast: false  # Don't cancel other reviews if one fails
      matrix:
        include:
          - agent: security
            prompt-file: .github/prompts/pr-quality-gate-security.md
            emoji: "ğŸ”’"
          - agent: qa
            prompt-file: .github/prompts/pr-quality-gate-qa.md
            emoji: "ğŸ§ª"
          - agent: analyst
            prompt-file: .github/prompts/pr-quality-gate-analyst.md
            emoji: "ğŸ“Š"

    # NOTE: Matrix job outputs only expose ONE matrix leg's outputs to downstream jobs.
    # We use artifacts instead to reliably pass findings between jobs.
    # Verdicts use job outputs (small strings, safe for interpolation).

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 0

      - name: ${{ matrix.emoji }} ${{ matrix.agent }} Review
        id: review
        uses: ./.github/actions/ai-review
        with:
          agent: ${{ matrix.agent }}
          context-type: pr-diff
          pr-number: ${{ env.PR_NUMBER }}
          prompt-file: ${{ matrix.prompt-file }}
          timeout-minutes: 5
          bot-pat: ${{ secrets.BOT_PAT }}
          copilot-token: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      - name: Save review results
        id: save-results
        env:
          AGENT: ${{ matrix.agent }}
          VERDICT: ${{ steps.review.outputs.verdict }}
          FINDINGS: ${{ steps.review.outputs.findings }}
        run: |
          # Create output directory for this agent's results
          mkdir -p ai-review-results

          # Write verdict (safe for job outputs - small string)
          echo "$VERDICT" > "ai-review-results/${AGENT}-verdict.txt"

          # Write findings to file (avoids shell interpolation issues with special chars)
          echo "$FINDINGS" > "ai-review-results/${AGENT}-findings.txt"

          echo "Saved ${AGENT} results:"
          echo "  Verdict: $VERDICT"
          echo "  Findings: $(wc -c < ai-review-results/${AGENT}-findings.txt) bytes"

      - name: Upload review results
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4
        with:
          name: review-${{ matrix.agent }}
          path: ai-review-results/
          retention-days: 1

# Aggregate results from all parallel reviews

  aggregate:
    name: Aggregate Results
    runs-on: ubuntu-latest
    needs: [check-changes, review]
    if: needs.check-changes.outputs.skip_review != 'true'

    outputs:
      final-verdict: ${{ steps.aggregate.outputs.final_verdict }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Download all review artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4
        with:
          pattern: review-*
          path: ai-review-results
          merge-multiple: true

      - name: Load review results
        id: load-results
        run: |
          # Read verdicts from artifact files
          SECURITY_VERDICT=$(cat ai-review-results/security-verdict.txt 2>/dev/null || echo "UNKNOWN")
          QA_VERDICT=$(cat ai-review-results/qa-verdict.txt 2>/dev/null || echo "UNKNOWN")
          ANALYST_VERDICT=$(cat ai-review-results/analyst-verdict.txt 2>/dev/null || echo "UNKNOWN")

          echo "Loaded verdicts:"
          echo "  Security: $SECURITY_VERDICT"
          echo "  QA: $QA_VERDICT"
          echo "  Analyst: $ANALYST_VERDICT"

          # Export verdicts for subsequent steps
          echo "security_verdict=$SECURITY_VERDICT" >> $GITHUB_OUTPUT
          echo "qa_verdict=$QA_VERDICT" >> $GITHUB_OUTPUT
          echo "analyst_verdict=$ANALYST_VERDICT" >> $GITHUB_OUTPUT

      - name: Aggregate Verdicts
        id: aggregate
        run: |
          source .github/scripts/ai-review-common.sh

          # Get verdicts from loaded results
          SECURITY_VERDICT="${{ steps.load-results.outputs.security_verdict }}"
          QA_VERDICT="${{ steps.load-results.outputs.qa_verdict }}"
          ANALYST_VERDICT="${{ steps.load-results.outputs.analyst_verdict }}"

          log "Security verdict: $SECURITY_VERDICT"
          log "QA verdict: $QA_VERDICT"
          log "Analyst verdict: $ANALYST_VERDICT"

          FINAL=$(aggregate_verdicts "$SECURITY_VERDICT" "$QA_VERDICT" "$ANALYST_VERDICT")
          log "Final verdict: $FINAL"

          echo "final_verdict=$FINAL" >> $GITHUB_OUTPUT
          echo "security_verdict=$SECURITY_VERDICT" >> $GITHUB_OUTPUT
          echo "qa_verdict=$QA_VERDICT" >> $GITHUB_OUTPUT
          echo "analyst_verdict=$ANALYST_VERDICT" >> $GITHUB_OUTPUT

      - name: Generate Report
        id: report
        run: |
          source .github/scripts/ai-review-common.sh

          REPORT_FILE="$AI_REVIEW_DIR/pr-quality-report.md"
          FINAL_VERDICT="${{ steps.aggregate.outputs.final_verdict }}"
          ALERT_TYPE=$(get_verdict_alert_type "$FINAL_VERDICT")

          # Helper function to get verdict emoji
          get_verdict_emoji() {
            case "$1" in
              PASS) echo "âœ…" ;;
              WARN) echo "âš ï¸" ;;
              CRITICAL_FAIL|REJECTED|FAIL) echo "âŒ" ;;
              *) echo "â”" ;;
            esac
          }

          SECURITY_VERDICT="${{ steps.aggregate.outputs.security_verdict }}"
          QA_VERDICT="${{ steps.aggregate.outputs.qa_verdict }}"
          ANALYST_VERDICT="${{ steps.aggregate.outputs.analyst_verdict }}"

          SECURITY_EMOJI=$(get_verdict_emoji "$SECURITY_VERDICT")
          QA_EMOJI=$(get_verdict_emoji "$QA_VERDICT")
          ANALYST_EMOJI=$(get_verdict_emoji "$ANALYST_VERDICT")
          FINAL_EMOJI=$(get_verdict_emoji "$FINAL_VERDICT")

          cat > "$REPORT_FILE" << EOF
          <!-- AI-PR-QUALITY-GATE -->

          ## ğŸ¤– AI Quality Gate Review

          > [!$ALERT_TYPE]
          > $FINAL_EMOJI **Final Verdict: $FINAL_VERDICT**

          <details>
          <summary>ğŸ“‹ Walkthrough</summary>

          This PR was reviewed by three AI agents **in parallel**, analyzing different aspects of the changes:

          - **ğŸ”’ Security Agent**: Scans for vulnerabilities, secrets exposure, and security anti-patterns
          - **ğŸ§ª QA Agent**: Evaluates test coverage, error handling, and code quality
          - **ğŸ“Š Analyst Agent**: Assesses architecture impact, maintainability, and best practices

          </details>

          ### ğŸ“Š Review Summary

          | Agent | Verdict | Status |
          |:------|:--------|:------:|
          | ğŸ”’ Security | $SECURITY_VERDICT | $SECURITY_EMOJI |
          | ğŸ§ª QA | $QA_VERDICT | $QA_EMOJI |
          | ğŸ“Š Analyst | $ANALYST_VERDICT | $ANALYST_EMOJI |

          EOF

          # Read findings from artifact files (safe from shell interpolation issues)
          SECURITY_FINDINGS_FILE="ai-review-results/security-findings.txt"
          QA_FINDINGS_FILE="ai-review-results/qa-findings.txt"
          ANALYST_FINDINGS_FILE="ai-review-results/analyst-findings.txt"

          # Add security findings with better formatting
          if [ -s "$SECURITY_FINDINGS_FILE" ]; then
            cat >> "$REPORT_FILE" << 'SECTION_EOF'

          <details>
          <summary>ğŸ”’ Security Review Details</summary>

          SECTION_EOF
            echo "" >> "$REPORT_FILE"
            cat "$SECURITY_FINDINGS_FILE" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "</details>" >> "$REPORT_FILE"
          else
            echo "Warning: No security findings file found" >&2
          fi

          # Add QA findings with better formatting
          if [ -s "$QA_FINDINGS_FILE" ]; then
            cat >> "$REPORT_FILE" << 'SECTION_EOF'

          <details>
          <summary>ğŸ§ª QA Review Details</summary>

          SECTION_EOF
            echo "" >> "$REPORT_FILE"
            cat "$QA_FINDINGS_FILE" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "</details>" >> "$REPORT_FILE"
          else
            echo "Warning: No QA findings file found" >&2
          fi

          # Add analyst findings with better formatting
          if [ -s "$ANALYST_FINDINGS_FILE" ]; then
            cat >> "$REPORT_FILE" << 'SECTION_EOF'

          <details>
          <summary>ğŸ“Š Analyst Review Details</summary>

          SECTION_EOF
            echo "" >> "$REPORT_FILE"
            cat "$ANALYST_FINDINGS_FILE" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "</details>" >> "$REPORT_FILE"
          else
            echo "Warning: No analyst findings file found" >&2
          fi

          # Add footer with run info and branding
          cat >> "$REPORT_FILE" << EOF

          ---

          <details>
          <summary>â„¹ï¸ Run Details</summary>

          | Property | Value |
          |:---------|:------|
          | **Run ID** | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          | **Triggered by** | \`${{ github.event_name }}\` on \`${{ github.ref_name }}\` |
          | **Commit** | \`${{ github.sha }}\` |

          </details>

          <sub>ğŸ¤– Powered by [AI Quality Gate](https://github.com/${{ github.repository }}) Â· [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>
          EOF

          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT

      - name: Post PR Comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          source .github/scripts/ai-review-common.sh
          post_pr_comment "${{ env.PR_NUMBER }}" "${{ steps.report.outputs.report_file }}" "AI-PR-QUALITY-GATE"

      - name: Set Job Summary
        run: |
          cat "${{ steps.report.outputs.report_file }}" >> $GITHUB_STEP_SUMMARY

      - name: Check for Critical Failures
        run: |
          FINAL_VERDICT="${{ steps.aggregate.outputs.final_verdict }}"

          if [ "$FINAL_VERDICT" = "CRITICAL_FAIL" ] || [ "$FINAL_VERDICT" = "REJECTED" ]; then
            echo "::error::AI Quality Gate found critical issues that must be addressed before merge"
            exit 1
          fi

          echo "AI Quality Gate passed with verdict: $FINAL_VERDICT"
