name: AI PR Quality Gate

# AI-powered PR review using GitHub Copilot CLI
# Invokes security, qa, and analyst agents to review PRs
# Blocks merge if CRITICAL_FAIL detected

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**'
      - 'scripts/**'
      - 'build/**'
      - '.github/**'
      - '.agents/**'

  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ai-quality-${{ github.event.pull_request.number || inputs.pr_number }}
  cancel-in-progress: true

env:
  # GitHub CLI authentication (for gh commands)
  GH_TOKEN: ${{ secrets.BOT_PAT }}
  # Copilot CLI authentication (requires fine-grained PAT with "Copilot Requests" permission)
  # See: docs/copilot-cli-setup.md for token creation instructions
  COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
  # Compute PR number from either pull_request event or workflow_dispatch input
  PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}

jobs:
  ai-quality-review:
    name: AI Quality Review
    runs-on: ubuntu-latest
    timeout-minutes: 20

    # Skip for PRs from bots (avoid recursive reviews)
    if: github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]'

    outputs:
      final-verdict: ${{ steps.aggregate.outputs.final_verdict }}
      security-verdict: ${{ steps.security.outputs.verdict }}
      qa-verdict: ${{ steps.qa.outputs.verdict }}
      analyst-verdict: ${{ steps.analyst.outputs.verdict }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 0

      - name: Check for docs-only changes
        id: check-changes
        run: |
          CHANGED_FILES=$(gh pr diff ${{ env.PR_NUMBER }} --name-only)

          # Check if only documentation files changed
          NON_DOC_FILES=$(echo "$CHANGED_FILES" | grep -vE '\.(md|txt|rst)$' | grep -v '^docs/' || true)

          if [ -z "$NON_DOC_FILES" ]; then
            echo "Only documentation files changed, skipping AI review"
            echo "skip_review=true" >> $GITHUB_OUTPUT
          else
            echo "Code files changed, proceeding with AI review"
            echo "skip_review=false" >> $GITHUB_OUTPUT
          fi

      - name: Security Review
        id: security
        if: steps.check-changes.outputs.skip_review != 'true'
        uses: ./.github/actions/ai-review
        with:
          agent: security
          context-type: pr-diff
          pr-number: ${{ env.PR_NUMBER }}
          prompt-file: .github/prompts/pr-quality-gate-security.md
          timeout-minutes: 5
          bot-pat: ${{ secrets.BOT_PAT }}
          copilot-token: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      - name: QA Review
        id: qa
        if: steps.check-changes.outputs.skip_review != 'true'
        uses: ./.github/actions/ai-review
        with:
          agent: qa
          context-type: pr-diff
          pr-number: ${{ env.PR_NUMBER }}
          prompt-file: .github/prompts/pr-quality-gate-qa.md
          timeout-minutes: 5
          bot-pat: ${{ secrets.BOT_PAT }}
          copilot-token: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      - name: Analyst Review
        id: analyst
        if: steps.check-changes.outputs.skip_review != 'true'
        uses: ./.github/actions/ai-review
        with:
          agent: analyst
          context-type: pr-diff
          pr-number: ${{ env.PR_NUMBER }}
          prompt-file: .github/prompts/pr-quality-gate-analyst.md
          timeout-minutes: 5
          bot-pat: ${{ secrets.BOT_PAT }}
          copilot-token: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      - name: Aggregate Verdicts
        id: aggregate
        if: steps.check-changes.outputs.skip_review != 'true'
        run: |
          source .github/scripts/ai-review-common.sh

          SECURITY_VERDICT="${{ steps.security.outputs.verdict }}"
          QA_VERDICT="${{ steps.qa.outputs.verdict }}"
          ANALYST_VERDICT="${{ steps.analyst.outputs.verdict }}"

          log "Security verdict: $SECURITY_VERDICT"
          log "QA verdict: $QA_VERDICT"
          log "Analyst verdict: $ANALYST_VERDICT"

          FINAL=$(aggregate_verdicts "$SECURITY_VERDICT" "$QA_VERDICT" "$ANALYST_VERDICT")
          log "Final verdict: $FINAL"

          echo "final_verdict=$FINAL" >> $GITHUB_OUTPUT

      - name: Generate Report
        id: report
        if: steps.check-changes.outputs.skip_review != 'true'
        run: |
          source .github/scripts/ai-review-common.sh

          REPORT_FILE="$AI_REVIEW_DIR/pr-quality-report.md"
          FINAL_VERDICT="${{ steps.aggregate.outputs.final_verdict }}"
          ALERT_TYPE=$(get_verdict_alert_type "$FINAL_VERDICT")

          # Helper function to get verdict emoji
          get_verdict_emoji() {
            case "$1" in
              PASS) echo "âœ…" ;;
              WARN) echo "âš ï¸" ;;
              CRITICAL_FAIL|REJECTED|FAIL) echo "âŒ" ;;
              *) echo "â”" ;;
            esac
          }

          SECURITY_VERDICT="${{ steps.security.outputs.verdict }}"
          QA_VERDICT="${{ steps.qa.outputs.verdict }}"
          ANALYST_VERDICT="${{ steps.analyst.outputs.verdict }}"

          SECURITY_EMOJI=$(get_verdict_emoji "$SECURITY_VERDICT")
          QA_EMOJI=$(get_verdict_emoji "$QA_VERDICT")
          ANALYST_EMOJI=$(get_verdict_emoji "$ANALYST_VERDICT")
          FINAL_EMOJI=$(get_verdict_emoji "$FINAL_VERDICT")

          cat > "$REPORT_FILE" << EOF
          <!-- AI-PR-QUALITY-GATE -->

          ## ğŸ¤– AI Quality Gate Review

          > [!$ALERT_TYPE]
          > $FINAL_EMOJI **Final Verdict: $FINAL_VERDICT**

          <details>
          <summary>ğŸ“‹ Walkthrough</summary>

          This PR was reviewed by three AI agents analyzing different aspects of the changes:

          - **ğŸ”’ Security Agent**: Scans for vulnerabilities, secrets exposure, and security anti-patterns
          - **ğŸ§ª QA Agent**: Evaluates test coverage, error handling, and code quality
          - **ğŸ“Š Analyst Agent**: Assesses architecture impact, maintainability, and best practices

          </details>

          ### ğŸ“Š Review Summary

          | Agent | Verdict | Status |
          |:------|:--------|:------:|
          | ğŸ”’ Security | $SECURITY_VERDICT | $SECURITY_EMOJI |
          | ğŸ§ª QA | $QA_VERDICT | $QA_EMOJI |
          | ğŸ“Š Analyst | $ANALYST_VERDICT | $ANALYST_EMOJI |

          EOF

          # Add security findings with better formatting
          if [ -n "${{ steps.security.outputs.findings }}" ]; then
            cat >> "$REPORT_FILE" << 'SECTION_EOF'

          <details>
          <summary>ğŸ”’ Security Review Details</summary>

          SECTION_EOF
            echo "" >> "$REPORT_FILE"
            echo "${{ steps.security.outputs.findings }}" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "</details>" >> "$REPORT_FILE"
          fi

          # Add QA findings with better formatting
          if [ -n "${{ steps.qa.outputs.findings }}" ]; then
            cat >> "$REPORT_FILE" << 'SECTION_EOF'

          <details>
          <summary>ğŸ§ª QA Review Details</summary>

          SECTION_EOF
            echo "" >> "$REPORT_FILE"
            echo "${{ steps.qa.outputs.findings }}" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "</details>" >> "$REPORT_FILE"
          fi

          # Add analyst findings with better formatting
          if [ -n "${{ steps.analyst.outputs.findings }}" ]; then
            cat >> "$REPORT_FILE" << 'SECTION_EOF'

          <details>
          <summary>ğŸ“Š Analyst Review Details</summary>

          SECTION_EOF
            echo "" >> "$REPORT_FILE"
            echo "${{ steps.analyst.outputs.findings }}" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "</details>" >> "$REPORT_FILE"
          fi

          # Add footer with run info and branding
          cat >> "$REPORT_FILE" << EOF

          ---

          <details>
          <summary>â„¹ï¸ Run Details</summary>

          | Property | Value |
          |:---------|:------|
          | **Run ID** | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          | **Triggered by** | \`${{ github.event_name }}\` on \`${{ github.ref_name }}\` |
          | **Commit** | \`${{ github.sha }}\` |

          </details>

          <sub>ğŸ¤– Powered by [AI Quality Gate](https://github.com/${{ github.repository }}) Â· [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>
          EOF

          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT

      - name: Post PR Comment
        if: steps.check-changes.outputs.skip_review != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          source .github/scripts/ai-review-common.sh
          post_pr_comment "${{ env.PR_NUMBER }}" "${{ steps.report.outputs.report_file }}" "AI-PR-QUALITY-GATE"

      - name: Set Job Summary
        if: steps.check-changes.outputs.skip_review != 'true'
        run: |
          cat "${{ steps.report.outputs.report_file }}" >> $GITHUB_STEP_SUMMARY

      - name: Check for Critical Failures
        if: steps.check-changes.outputs.skip_review != 'true'
        run: |
          FINAL_VERDICT="${{ steps.aggregate.outputs.final_verdict }}"

          if [ "$FINAL_VERDICT" = "CRITICAL_FAIL" ] || [ "$FINAL_VERDICT" = "REJECTED" ]; then
            echo "::error::AI Quality Gate found critical issues that must be addressed before merge"
            exit 1
          fi

          echo "AI Quality Gate passed with verdict: $FINAL_VERDICT"
