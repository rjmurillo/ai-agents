name: Workflow Coalescing Metrics

on:
  schedule:
    - cron: '0 9 * * 1'  # Weekly on Monday 9 AM UTC
  workflow_dispatch:
    inputs:
      since:
        description: 'Days to analyze'
        required: false
        default: 30
        type: number

permissions:
  contents: write  # To commit report to repository
  actions: read    # To query workflow runs

jobs:
  collect-metrics:
    name: Collect Coalescing Metrics
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Collect metrics
        id: collect
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
          SINCE_DAYS: ${{ inputs.since || '30' }}
        run: |
          $since = [int]$env:SINCE_DAYS
          .github/scripts/Measure-WorkflowCoalescing.ps1 `
            -Since $since `
            -Output Markdown `
            -OutputPath .agents/metrics/workflow-coalescing.md

      - name: Commit report
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .agents/metrics/workflow-coalescing.md
          git commit -m "chore: update workflow coalescing metrics [skip ci]" || echo "No changes"
          git push

      - name: Upload artifact
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: coalescing-metrics
          path: .agents/metrics/workflow-coalescing.md
          retention-days: 90
