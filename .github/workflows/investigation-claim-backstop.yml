# CI backstop for investigation-only QA skip claims per ADR-034 Phase 3 (Issue #652)
#
# Validates that commits claiming "SKIPPED: investigation-only" only contain
# files from the investigation allowlist. Flags violations for manual review.

name: Investigation Claim Backstop

on:
  pull_request:
    branches: [main]
    paths:
      - '.agents/sessions/*.json'

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: investigation-backstop-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  validate-claims:
    name: Validate Investigation Claims
    # ADR-025: ARM runner for cost optimization
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 5
    if: github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout repository
        # SHA-pin with version comment per AGENTS.md
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.2.2
        with:
          fetch-depth: 0  # Need full history for commit analysis

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.12'

      - name: Validate Investigation Claims
        id: validate
        run: |
          python3 .github/scripts/validate_investigation_claims.py \
            --session-dir .agents/sessions \
            --output-format text

      - name: Post Warning on Violations
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          cat <<'EOF' > comment.md
          ## Investigation-Only Claim Violation

          This PR contains session logs claiming `SKIPPED: investigation-only` but the
          associated commits include files outside the investigation allowlist.

          **Per ADR-034**, investigation-only sessions may only commit:
          - `.agents/sessions/` (session logs)
          - `.agents/analysis/` (investigation outputs)
          - `.agents/retrospective/` (learnings)
          - `.serena/memories/` (cross-session context)
          - `.agents/security/` (security assessments)
          - `.agents/memory/` (memory infrastructure)

          **Action Required**: Either:
          1. Remove non-investigation files from the commit, or
          2. Remove the `SKIPPED: investigation-only` claim and obtain proper QA validation

          See [ADR-034](.agents/architecture/ADR-034-investigation-session-qa-exemption.md) for details.
          EOF

          python3 .github/scripts/post_issue_comment.py \
            --issue "$PR_NUMBER" \
            --body-file comment.md \
            --marker "INVESTIGATION-CLAIM-BACKSTOP"
