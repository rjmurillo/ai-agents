# Update Reviewer Signal Stats
#
# Automated daily workflow to gather PR review comment statistics and update
# the pr-comment-responder-skills Serena memory with accurate signal quality data.
#
# This workflow:
# - Runs daily at 06:00 UTC (scheduled)
# - Can be triggered manually with custom days_back parameter
# - Aggregates PR review comments by reviewer
# - Calculates actionability scores using heuristics
# - Updates the Serena memory file (source of truth)
# - Commits and pushes changes automatically
#
# Related: Issue #234 (Automated daily reviewer signal quality statistics)

name: Update Reviewer Signal Stats

on:
  schedule:
    # Run daily at 06:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Days of history to analyze'
        required: false
        default: '28'

permissions:
  contents: write
  pull-requests: read

jobs:
  update-stats:
    name: Update Reviewer Stats
    # ADR-025: ARM runner for cost optimization (37.5% savings vs x64)
    runs-on: ubuntu-24.04-arm
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          # Need full history for accurate PR analysis
          fetch-depth: 0

      - name: Run statistics aggregation
        env:
          # Use BOT_PAT to trigger downstream workflows when committing changes
          GH_TOKEN: ${{ secrets.BOT_PAT }}
          DAYS_BACK: ${{ github.event.inputs.days_back }}
        run: |
          days_back="${DAYS_BACK:-90}"
          python3 scripts/update_reviewer_signal_stats.py --days-back "$days_back"

      - name: Commit updated stats
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        run: |
          gh auth setup-git
          git config user.name "rjmurillo-bot"
          git config user.email "rjmurillo-bot@users.noreply.github.com"
          
          if [[ -n "$(git status --porcelain)" ]]; then
            git add .serena/memories/pr-comment-responder-skills.md
            git commit -m "chore(stats): update reviewer signal statistics" \
                       -m "Automated daily update of PR reviewer signal quality metrics." \
                       -m "Generated by update_reviewer_signal_stats.py"
            git push
            echo "Changes committed and pushed"
          else
            echo "No changes to commit"
          fi
