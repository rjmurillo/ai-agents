# Update Reviewer Signal Stats
#
# Automated daily workflow to gather PR review comment statistics and update
# the pr-comment-responder-skills Serena memory with accurate signal quality data.
#
# This workflow:
# - Runs daily at 06:00 UTC (scheduled)
# - Can be triggered manually with custom days_back parameter
# - Aggregates PR review comments by reviewer
# - Calculates actionability scores using heuristics
# - Updates the Serena memory file (source of truth)
# - Commits and pushes changes automatically
#
# Related: Issue #234 (Automated daily reviewer signal quality statistics)

name: Update Reviewer Signal Stats

on:
  schedule:
    # Run daily at 06:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Days of history to analyze'
        required: false
        default: '90'

permissions:
  contents: write
  pull-requests: read

jobs:
  update-stats:
    name: Update Reviewer Stats
    # ADR-025: ARM runner for cost optimization (37.5% savings vs x64)
    runs-on: ubuntu-24.04-arm
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          # Need full history for accurate PR analysis
          fetch-depth: 0

      - name: Setup PowerShell
        shell: pwsh
        run: |
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)"
          Write-Host "OS: $($PSVersionTable.OS)"

      - name: Run statistics aggregation
        shell: pwsh
        env:
          # Use BOT_PAT to trigger downstream workflows when committing changes
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        run: |
          $daysBack = '${{ github.event.inputs.days_back }}'
          if (-not $daysBack -or $daysBack -eq '') { $daysBack = '90' }
          
          Write-Host "Analyzing last $daysBack days of PR history..."
          
          ./scripts/Update-ReviewerSignalStats.ps1 -DaysBack ([int]$daysBack)

      - name: Commit updated stats
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        run: |
          gh auth setup-git
          
          if [[ -n "$(git status --porcelain)" ]]; then
            git add .serena/memories/pr-comment-responder-skills.md
            git commit -m "chore(stats): update reviewer signal statistics" \
                       -m "Automated daily update of PR reviewer signal quality metrics." \
                       -m "Generated by Update-ReviewerSignalStats.ps1"
            git push
            echo "Changes committed and pushed"
          else
            echo "No changes to commit"
          fi
