<?xml version="1.0" encoding="UTF-8"?>
<skill_specification>
  <metadata>
    <name>memory</name>
    <version>0.2.0</version>
    <analysis_iterations>7</analysis_iterations>
    <timelessness_score>8/10</timelessness_score>
    <justification>
      Memory retrieval is a fundamental agent capability that will remain relevant
      regardless of underlying storage technology. The four-tier model maps to
      cognitive science concepts (working/semantic/episodic/procedural). Extension
      points allow adding new tiers without restructuring.
    </justification>
  </metadata>

  <context>
    <problem_statement>
      AI agents lose context between sessions, repeat past mistakes, and cannot
      leverage institutional knowledge. They need unified access to past facts,
      session history, and learned patterns without understanding storage details.
    </problem_statement>
    <who>AI agents working in the ai-agents project ecosystem</who>
    <why>
      Enable memory-first decision making (ADR-007) by providing simple interface
      to complex four-tier memory architecture. Reduce cognitive load on agents.
    </why>
    <existing_landscape>
      - using-forgetful-memory: Forgetful-specific (Tier 1 partial)
      - curating-memories: Maintenance only
      - exploring-knowledge-graph: Exploration only
      - serena-code-architecture: Code analysis, not memory
      DISTINCTIVENESS: This skill unifies ALL tiers with automation scripts
    </existing_landscape>
  </context>

  <requirements>
    <explicit>
      <requirement id="E1">Wrap four-tier memory architecture</requirement>
      <requirement id="E2">Integrate 6 PowerShell scripts</requirement>
      <requirement id="E3">Support 5+ trigger phrases</requirement>
      <requirement id="E4">Reference ADR-037 and ADR-038</requirement>
      <requirement id="E5">Agent-friendly with decision trees</requirement>
      <requirement id="E6">Include verification steps</requirement>
      <requirement id="E7">Document anti-patterns</requirement>
    </explicit>
    <implicit>
      <requirement id="I1">Graceful degradation when Forgetful unavailable</requirement>
      <requirement id="I2">Integration with session protocol</requirement>
      <requirement id="I3">Follow PowerShell-only constraint (ADR-005)</requirement>
      <requirement id="I4">Align with memory-first architecture (ADR-007)</requirement>
    </implicit>
    <discovered>
      <requirement id="D1">Clear decision tree for tier selection</requirement>
      <requirement id="D2">Error recovery paths for each operation</requirement>
      <requirement id="D3">Feedback loop documentation (learning cycle)</requirement>
      <requirement id="D4">Extension points for future tiers</requirement>
      <requirement id="D5">Health check/validation capability</requirement>
    </discovered>
  </requirements>

  <architecture>
    <pattern name="Multi-Phase with Decision Tree">
      <rationale>
        Complex skill with multiple independent operations. Agent needs decision
        guidance BEFORE taking action, then clear execution paths.
      </rationale>
    </pattern>

    <phases>
      <phase number="1" name="Tier Selection">
        <description>Agent determines which tier(s) to query based on need</description>
        <decision_tree>
          need_current_facts → Tier 1 (Search-Memory.ps1)
          need_session_history → Tier 2 (Get-Episode)
          need_causal_patterns → Tier 3 (Get-Patterns)
          need_to_store_knowledge → Tier 2 (Extract) → Tier 3 (Update)
        </decision_tree>
        <verification>Tier explicitly identified before proceeding</verification>
      </phase>

      <phase number="2" name="Execution">
        <description>Run appropriate script with correct parameters</description>
        <verification>Script completes without error, output captured</verification>
      </phase>

      <phase number="3" name="Integration">
        <description>Integrate results into agent reasoning</description>
        <verification>Agent explicitly references memory results in response</verification>
      </phase>
    </phases>

    <decision_points>
      <decision id="DP1" question="What kind of knowledge is needed?">
        <option value="facts/patterns">Tier 1: Search-Memory</option>
        <option value="session history">Tier 2: Get-Episode(s)</option>
        <option value="causal relationships">Tier 3: Get-CausalPath/Patterns</option>
        <default>Start with Tier 1, escalate if insufficient</default>
      </decision>

      <decision id="DP2" question="Forgetful available?">
        <option value="yes">Use unified search (default)</option>
        <option value="no">Use -LexicalOnly (Serena fallback)</option>
      </decision>

      <decision id="DP3" question="Store or retrieve?">
        <option value="retrieve">Query appropriate tier</option>
        <option value="store">Extract episode → Update causal graph</option>
      </decision>
    </decision_points>
  </architecture>

  <scripts>
    <decision_summary>
      needs_scripts: true
      rationale: Existing PowerShell scripts provide automation. Need validation script.
    </decision_summary>

    <script_inventory>
      <script name="Search-Memory.ps1" category="query" exists="true">
        Unified search across Serena and Forgetful
      </script>
      <script name="MemoryRouter.psm1" category="module" exists="true">
        Core routing module implementing ADR-037
      </script>
      <script name="ReflexionMemory.psm1" category="module" exists="true">
        Episodic and causal memory functions
      </script>
      <script name="Extract-SessionEpisode.ps1" category="transformation" exists="true">
        Session log → episode JSON extraction
      </script>
      <script name="Update-CausalGraph.ps1" category="transformation" exists="true">
        Episode data → causal graph update
      </script>
      <script name="Measure-MemoryPerformance.ps1" category="validation" exists="true">
        Performance benchmarking
      </script>
      <script name="Test-MemoryHealth.ps1" category="validation" exists="true">
        Health check for all tiers
      </script>
    </script_inventory>

    <agentic_capabilities>
      <autonomous>All scripts can run without human intervention</autonomous>
      <self_verify>Search returns count, extraction returns JSON, graph returns stats</self_verify>
      <recovery>-LexicalOnly fallback when Forgetful unavailable</recovery>
    </agentic_capabilities>
  </scripts>

  <evolution_analysis>
    <timelessness_score>8/10</timelessness_score>
    <rationale>
      Memory retrieval is fundamental to intelligent agents. The four-tier model
      (working/semantic/episodic/causal) maps to cognitive science. Storage
      backends may change but the abstraction remains stable.
    </rationale>

    <extension_points>
      <extension id="EXT1">Additional tier types (spatial, relational, temporal)</extension>
      <extension id="EXT2">Alternative storage backends (new MCPs)</extension>
      <extension id="EXT3">Custom episode parsers for different log formats</extension>
      <extension id="EXT4">Pattern detection algorithms (ML-based)</extension>
      <extension id="EXT5">Visualization outputs for causal graphs</extension>
    </extension_points>

    <obsolescence_triggers>
      <trigger>Claude gains native persistent memory (reduces need)</trigger>
      <trigger>Serena/Forgetful deprecated without replacement</trigger>
      <trigger>Session protocol changes incompatibly</trigger>
    </obsolescence_triggers>
  </evolution_analysis>

  <anti_patterns>
    <pattern id="AP1">
      <name>Skipping Memory Search</name>
      <description>Making decisions without consulting memory</description>
      <why_bad>Ignores institutional knowledge, repeats past mistakes</why_bad>
      <alternative>Always search memory before multi-step reasoning</alternative>
    </pattern>

    <pattern id="AP2">
      <name>Tier Confusion</name>
      <description>Using wrong tier for the task</description>
      <why_bad>Returns irrelevant or empty results</why_bad>
      <alternative>Follow decision tree explicitly</alternative>
    </pattern>

    <pattern id="AP3">
      <name>Forgetful Dependency</name>
      <description>Assuming Forgetful is always available</description>
      <why_bad>Skill fails when MCP server is down</why_bad>
      <alternative>Use -LexicalOnly fallback, always works via Serena</alternative>
    </pattern>

    <pattern id="AP4">
      <name>Stale Causal Graph</name>
      <description>Not updating causal graph after sessions</description>
      <why_bad>Patterns become outdated, miss new learnings</why_bad>
      <alternative>Run Update-CausalGraph.ps1 after episode extraction</alternative>
    </pattern>

    <pattern id="AP5">
      <name>Silent Search Failures</name>
      <description>Not checking if search returned useful results</description>
      <why_bad>Agent proceeds as if no memory exists</why_bad>
      <alternative>Check result count, log "No relevant memories found"</alternative>
    </pattern>

    <pattern id="AP6">
      <name>Incomplete Episode Extraction</name>
      <description>Extracting from partial/unfinished sessions</description>
      <why_bad>Corrupts causal graph with incomplete data</why_bad>
      <alternative>Only extract from completed sessions with outcomes</alternative>
    </pattern>
  </anti_patterns>

  <success_criteria>
    <criterion id="SC1">
      <measure>Agent can search memory and integrate results</measure>
      <verification>Search returns results, agent references them in response</verification>
    </criterion>

    <criterion id="SC2">
      <measure>Agent can extract episode from session</measure>
      <verification>JSON file created in .agents/memory/episodes/</verification>
    </criterion>

    <criterion id="SC3">
      <measure>Agent can query causal patterns</measure>
      <verification>Patterns returned with success rates</verification>
    </criterion>

    <criterion id="SC4">
      <measure>Skill gracefully degrades without Forgetful</measure>
      <verification>-LexicalOnly returns Serena results</verification>
    </criterion>

    <criterion id="SC5">
      <measure>Health check reports system state</measure>
      <verification>Test-MemoryHealth.ps1 returns status for all tiers</verification>
    </criterion>
  </success_criteria>
</skill_specification>
