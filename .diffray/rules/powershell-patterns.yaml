rules:
  - id: ps_no_bash_python_scripts
    agent: quality
    title: "No bash or Python scripts allowed (ADR-005)"
    description: |
      This project uses PowerShell exclusively per ADR-005.
      All scripting must be done in .ps1 or .psm1 files for consistency,
      testability with Pester, and cross-platform compatibility.
    importance: 9

    match:
      file_glob:
        - "**/*.sh"
        - "**/*.py"
        - "!.githooks/**"      # Git hooks are pre-existing exception
        - "!.github/actions/**/*.sh"  # External actions may have shell

    checklist:
      - "Flag any new .sh or .py file creation"
      - "Verify this isn't a legitimate exception (git hook, external action)"
      - "Suggest PowerShell equivalent implementation"
      - "Reference ADR-005 for rationale"

    examples:
      bad: |
        #!/bin/bash
        # build.sh
        docker build -t myapp .
      good: |
        # build.ps1
        [CmdletBinding()]
        param()
        docker build -t myapp .

    tags:
      - architecture
      - powershell
      - compliance

    why_important: |
      Single language reduces context switching, enables unified testing
      with Pester, and ensures all scripts work cross-platform.

    link: .agents/architecture/ADR-005-powershell-only-scripting.md


  - id: ps_cmdletbinding_required
    agent: quality
    title: "PowerShell functions should use [CmdletBinding()]"
    description: |
      Functions without [CmdletBinding()] lack parameter validation,
      common parameter support, and proper error handling.
    importance: 7

    match:
      file_glob:
        - "**/*.ps1"
        - "**/*.psm1"
        - "!**/*.Tests.ps1"
      content_regex:
        - "function\\s+[A-Z]"

    checklist:
      - "Find functions that don't have [CmdletBinding()] attribute"
      - "Check if function accepts parameters"
      - "Verify parameter validation is present"
      - "Suggest adding [CmdletBinding()] for better error handling"

    examples:
      bad: |
        function Get-UserData {
            param([string]$UserId)
            # No parameter validation
            # No common parameters (-Verbose, -ErrorAction, etc.)
        }
      good: |
        function Get-UserData {
            [CmdletBinding()]
            param(
                [Parameter(Mandatory)]
                [ValidateNotNullOrEmpty()]
                [string]$UserId
            )
            # Supports common parameters
            # Has parameter validation
        }

    tags:
      - powershell
      - quality
      - error-handling


  - id: ps_error_handling_required
    agent: bugs
    title: "Complex PowerShell functions need error handling"
    description: |
      Functions with multiple operations or external calls should use
      try-catch blocks to handle errors gracefully.
    importance: 8

    match:
      file_glob:
        - "**/*.ps1"
        - "**/*.psm1"
        - "!**/*.Tests.ps1"
      content_regex:
        - "Invoke-RestMethod|Invoke-WebRequest|gh\\s|git\\s"

    checklist:
      - "Find functions making external calls (gh, git, API calls)"
      - "Check if try-catch block exists"
      - "Verify error messages are descriptive"
      - "Ensure errors are either handled or propagated with context"

    examples:
      bad: |
        function Get-PRData {
            [CmdletBinding()]
            param([int]$PRNumber)
            
            gh pr view $PRNumber --json title,body | ConvertFrom-Json
            # No error handling - fails silently or with unclear error
        }
      good: |
        function Get-PRData {
            [CmdletBinding()]
            param([int]$PRNumber)
            
            try {
                $result = gh pr view $PRNumber --json title,body 2>&1
                if ($LASTEXITCODE -ne 0) {
                    throw "Failed to fetch PR #$PRNumber: $result"
                }
                return $result | ConvertFrom-Json
            }
            catch {
                Write-Error "Error retrieving PR #$PRNumber: $_"
                throw
            }
        }

    tags:
      - powershell
      - error-handling
      - bugs


  - id: ps_avoid_write_host_in_modules
    agent: quality
    title: "Use Write-Output instead of Write-Host in modules"
    description: |
      Write-Host writes directly to console and cannot be captured or tested.
      Use Write-Output for testable output in modules and scripts.
    importance: 6

    match:
      file_glob:
        - "**/*.psm1"
        - "scripts/**/*.ps1"
      content_regex:
        - "Write-Host"

    checklist:
      - "Find Write-Host usage in modules or utility scripts"
      - "Check if output needs to be testable"
      - "Suggest Write-Output, Write-Verbose, or Write-Information"
      - "For progress updates, suggest Write-Progress"

    examples:
      bad: |
        function Get-Results {
            $data = Get-Data
            Write-Host "Found $($data.Count) items"
            return $data
        }
      good: |
        function Get-Results {
            [CmdletBinding()]
            param()
            
            $data = Get-Data
            Write-Verbose "Found $($data.Count) items"
            return $data
        }

    tags:
      - powershell
      - testability
      - quality


  - id: ps_proper_parameter_validation
    agent: quality
    title: "PowerShell parameters should have validation attributes"
    description: |
      Parameters accepting user input should have appropriate validation
      attributes to fail fast with clear error messages.
    importance: 7

    match:
      file_glob:
        - "**/*.ps1"
        - "**/*.psm1"
        - "!**/*.Tests.ps1"
      content_regex:
        - "\\[Parameter\\(Mandatory\\)\\]"

    checklist:
      - "Find mandatory parameters without validation attributes"
      - "Check for [ValidateNotNullOrEmpty()] on strings"
      - "Check for [ValidateRange()] on numeric parameters"
      - "Check for [ValidateSet()] for enum-like parameters"
      - "Verify file paths use [ValidateScript({ Test-Path $_ })]"

    examples:
      bad: |
        function Update-Config {
            [CmdletBinding()]
            param(
                [Parameter(Mandatory)]
                [string]$ConfigPath,
                [int]$RetryCount
            )
        }
      good: |
        function Update-Config {
            [CmdletBinding()]
            param(
                [Parameter(Mandatory)]
                [ValidateScript({ Test-Path $_ })]
                [string]$ConfigPath,
                
                [ValidateRange(1, 10)]
                [int]$RetryCount = 3
            )
        }

    tags:
      - powershell
      - validation
      - error-handling
