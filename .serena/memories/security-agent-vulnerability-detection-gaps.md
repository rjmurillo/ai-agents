# Security Agent Vulnerability Detection Gaps

## Root Cause Analysis Summary

On 2026-01-03, the security agent missed two CRITICAL vulnerabilities in PR #752 that were caught by Gemini Code Assist:

1. **CRITICAL-001**: Path traversal (CWE-22) in Export-ClaudeMemMemories.ps1:105-107 - uses `StartsWith` without path normalization
2. **CRITICAL-002**: Command injection (CWE-77) in Export-ClaudeMemMemories.ps1:115 - unquoted variables in `npx tsx` command

## Systematic Gap Identified

The security agent prompt (`src/claude/security.md`) has:

- **Incomplete CWE Coverage**: Only lists CWE-78, CWE-79, CWE-89. Missing CWE-22 (path traversal), CWE-77 (command injection).
- **Lack of PowerShell Patterns**: Only 1 PowerShell example in 520 lines (0.2% coverage) despite ADR-005 mandating PowerShell-only.
- **No Feedback Loop**: No process to update agent prompts based on missed vulnerabilities.

## What Security Agent DID Find

- MEDIUM-002: Flagged Export-ClaudeMemMemories.ps1:114 for "command injection" but recommended parameter validation, not variable quoting
- LOW-001: Found path traversal in Import script (symlinks) but missed Export script StartsWith issue

## Detection Patterns

Security agent detected vulnerable code but:

1. **Misclassified severity**: Rated both as MEDIUM, not CRITICAL
2. **Shallow analysis**: Focused on parameter validation, missed line-level vulnerabilities
3. **Wrong file**: Found path traversal in Import, not Export

## Required Improvements

### P0: Immediate Fixes (30 minutes)

- Fix CRITICAL-001: Add `[System.IO.Path]::GetFullPath()` normalization
- Fix CRITICAL-002: Quote variables in npx command
- Add Pester tests

### P1: Prompt Updates (5.5 hours)

- Add PowerShell Security Checklist to security.md
- Expand CWE coverage: CWE-22, CWE-77, CWE-88, CWE-95
- Add PowerShell-specific examples: quoting, GetFullPath, splatting
- Reference OWASP PowerShell Security Cheat Sheet

### P2: Process (7 hours)

- Create security agent retrospective workflow
- Track false negatives in Forgetful
- Add second-pass review for CRITICAL file paths
- Require PSScriptAnalyzer for PowerShell

## PowerShell Security Patterns to Add

**Command Injection Prevention**:

```powershell
# UNSAFE: Unquoted variables
npx tsx $PluginScript $Query $OutputFile

# SAFE: Quoted variables
npx tsx "$PluginScript" "$Query" "$OutputFile"

# SAFEST: Argument splatting
$Args = @($PluginScript, $Query, $OutputFile)
& npx tsx $Args
```

**Path Traversal Prevention**:

```powershell
# UNSAFE: StartsWith without normalization
if (-not $OutputFile.StartsWith($MemoriesDir)) { ... }

# SAFE: Normalize first
$NormalizedOutput = [System.IO.Path]::GetFullPath($OutputFile)
$NormalizedDir = [System.IO.Path]::GetFullPath($MemoriesDir)
if (-not $NormalizedOutput.StartsWith($NormalizedDir)) { ... }
```

## Key Learning

**Explicit CWE lists limit agent capability**. Security agent only reliably detects vulnerabilities in its explicit CWE list. Expanding coverage and adding language-specific patterns is required.

## References

- Full RCA: `.agents/analysis/security-agent-failure-rca.md`
- Security report: `.agents/security/SR-pr752-memory-system-foundation.md`
- Security agent prompt: `src/claude/security.md`

## Related

- [security-002-input-validation-first](security-002-input-validation-first.md)
- [security-003-secure-error-handling](security-003-secure-error-handling.md)
- [security-004-security-event-logging](security-004-security-event-logging.md)
- [security-007-defense-in-depth-for-cross-process-security-checks](security-007-defense-in-depth-for-cross-process-security-checks.md)
- [security-008-first-run-gap-analysis](security-008-first-run-gap-analysis.md)
