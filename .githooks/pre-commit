#!/usr/bin/env bash
#
# Pre-commit hook for vs-code-agents repository
# AUTOMATICALLY FIXES markdown linting issues and re-stages corrected files.
#
# Linter:
#   - markdownlint-cli2 for markdown files (auto-fix enabled)
#
# To enable: git config core.hooksPath .githooks
# To bypass: git commit --no-verify (use sparingly)
#
# Environment variables:
#   SKIP_AUTOFIX=1 - Check only, don't auto-fix (CI mode)
#

set -e

# Colors for output (if terminal supports it)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Check if we're in a terminal that supports colors
if [ ! -t 1 ]; then
    RED=''
    GREEN=''
    YELLOW=''
    CYAN=''
    NC=''
fi

echo_error() {
    echo -e "${RED}ERROR:${NC} $1"
}

echo_warning() {
    echo -e "${YELLOW}WARNING:${NC} $1"
}

echo_success() {
    echo -e "${GREEN}SUCCESS:${NC} $1"
}

echo_info() {
    echo "$1"
}

echo_action() {
    echo -e "${CYAN}FIXING:${NC} $1"
}

# Track overall exit status
EXIT_STATUS=0

# Track if any files were auto-fixed
FILES_FIXED=0

# Auto-fix mode (default: enabled)
AUTOFIX=1
if [ "${SKIP_AUTOFIX:-}" = "1" ]; then
    AUTOFIX=0
    echo_info "Auto-fix disabled (SKIP_AUTOFIX=1)"
fi

# Get repository root (LOW-001: Validate git output)
REPO_ROOT=$(git rev-parse --show-toplevel) || {
    echo_error "Failed to determine repository root"
    exit 1
}
# Validate path exists and is a directory
if [ ! -d "$REPO_ROOT" ]; then
    echo_error "Invalid repository root: $REPO_ROOT"
    exit 1
fi
cd "$REPO_ROOT"

# Get staged files (Added, Copied, Modified, Renamed - excluding Deleted)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$STAGED_FILES" ]; then
    echo_info "No staged files to check."
    exit 0
fi

# Filter for markdown files only
STAGED_MD_FILES=$(echo "$STAGED_FILES" | grep -E '\.md$' || true)

#
# Markdown Linting with markdownlint-cli2
#
# Security: Uses arrays and proper quoting to prevent command injection (CRITICAL-001)
# Security: Uses while/read loop to handle filenames with spaces (HIGH-001)
# Security: Checks for symlinks to prevent TOCTOU attacks (MEDIUM-002)
# Security: Prefers local installation over npx for dependency security (HIGH-002)
#

# Function to get the markdownlint command
# HIGH-002: Check for local installation first to prevent dependency confusion
get_markdownlint_cmd() {
    if [ -x "./node_modules/.bin/markdownlint-cli2" ]; then
        echo "./node_modules/.bin/markdownlint-cli2"
        return 0
    elif command -v npx &> /dev/null; then
        echo "npx markdownlint-cli2"
        return 0
    else
        return 1
    fi
}

if [ -n "$STAGED_MD_FILES" ]; then
    echo_info "Checking markdown files..."

    # Get the markdownlint command (local preferred, npx fallback)
    if ! MARKDOWNLINT_CMD=$(get_markdownlint_cmd); then
        echo_warning "markdownlint-cli2 not available. Skipping markdown linting."
        echo_warning "Install locally: npm install --save-dev markdownlint-cli2"
        echo_warning "Or install Node.js and npm to enable npx fallback."
    else
        # CRITICAL-001: Build array safely to prevent command injection
        # Use mapfile to read newline-separated file list into array
        mapfile -t MD_FILES <<< "$STAGED_MD_FILES"

        # Validate array is not empty
        if [ ${#MD_FILES[@]} -eq 0 ]; then
            echo_info "No markdown files to process."
        else
            # First, try to auto-fix
            if [ "$AUTOFIX" = "1" ]; then
                echo_action "Auto-fixing markdown files..."
                # CRITICAL-001: Use proper array expansion with quotes and -- separator
                # LOW-002: Capture stderr to temp file for review, but don't suppress completely
                LINT_ERRORS=$(mktemp)
                # shellcheck disable=SC2086
                $MARKDOWNLINT_CMD --fix --no-globs -- "${MD_FILES[@]}" 2>"$LINT_ERRORS" || true
                # Only show errors if file is non-empty (not just benign output)
                if [ -s "$LINT_ERRORS" ]; then
                    # MEDIUM-001: Show only first few lines of errors to avoid info disclosure
                    head -5 "$LINT_ERRORS" >&2 || true
                fi
                rm -f "$LINT_ERRORS"
            fi

            # MEDIUM-001: Capture verification output for structured display
            LINT_OUTPUT=$(mktemp)
            # CRITICAL-001: Use proper array expansion with quotes and -- separator
            # shellcheck disable=SC2086
            if ! $MARKDOWNLINT_CMD --no-globs -- "${MD_FILES[@]}" >"$LINT_OUTPUT" 2>&1; then
                echo_error "Markdown linting failed (some issues cannot be auto-fixed)."
                echo_info "  Review errors below and fix manually:"
                echo ""
                # MEDIUM-001: Show structured output, limiting to prevent info disclosure
                # Filter to show only the linting errors, not system paths
                grep -E '^[^/].*:.*MD[0-9]+' "$LINT_OUTPUT" 2>/dev/null | head -20 || cat "$LINT_OUTPUT" | head -20
                echo ""
                echo_info "  Common unfixable issues:"
                echo_info "    - MD040: Add language identifier to code blocks"
                echo_info "    - MD033: Wrap generic types like ArrayPool<T> in backticks"
                rm -f "$LINT_OUTPUT"
                EXIT_STATUS=1
            else
                rm -f "$LINT_OUTPUT"
                # HIGH-001: Use while/read loop with proper IFS to handle spaces in filenames
                # MEDIUM-002: Check for symlinks to prevent TOCTOU race conditions
                while IFS= read -r file; do
                    # Skip empty lines
                    [ -z "$file" ] && continue

                    # MEDIUM-002: Reject symlinks to prevent race condition attacks
                    if [ -L "$file" ]; then
                        echo_warning "Skipping symlink: $file"
                        continue
                    fi

                    # Process regular files only
                    if [ -f "$file" ] && ! git diff --quiet -- "$file" 2>/dev/null; then
                        echo_success "Fixed: $file"
                        # Use -- to prevent filenames starting with - being treated as options
                        git add -- "$file"
                        FILES_FIXED=1
                    fi
                done <<< "$STAGED_MD_FILES"
                echo_success "Markdown files OK."
            fi
        fi
    fi
else
    echo_info "No markdown files staged. Skipping markdown linting."
fi

#
# Final Summary
#
echo ""
if [ $EXIT_STATUS -ne 0 ]; then
    echo_error "Pre-commit checks failed. Please fix the issues above."
    echo_info "  To bypass (use sparingly): git commit --no-verify"
    exit 1
fi

if [ "$FILES_FIXED" = "1" ]; then
    echo_success "All checks passed. Some files were auto-fixed and re-staged."
else
    echo_success "All pre-commit checks passed."
fi
exit 0
