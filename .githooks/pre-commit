#!/usr/bin/env bash
#
# Pre-commit hook for vs-code-agents repository
# AUTOMATICALLY FIXES markdown linting issues and re-stages corrected files.
#
# Linter:
#   - markdownlint-cli2 for markdown files (auto-fix enabled)
#
# To enable: git config core.hooksPath .githooks
# To bypass: git commit --no-verify (use sparingly)
#
# Environment variables:
#   SKIP_AUTOFIX=1 - Check only, don't auto-fix (CI mode)
#

set -e

# Colors for output (if terminal supports it)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Check if we're in a terminal that supports colors
if [ ! -t 1 ]; then
    RED=''
    GREEN=''
    YELLOW=''
    CYAN=''
    NC=''
fi

echo_error() {
    echo -e "${RED}ERROR:${NC} $1"
}

echo_warning() {
    echo -e "${YELLOW}WARNING:${NC} $1"
}

echo_success() {
    echo -e "${GREEN}SUCCESS:${NC} $1"
}

echo_info() {
    echo "$1"
}

echo_action() {
    echo -e "${CYAN}FIXING:${NC} $1"
}

# Track overall exit status
EXIT_STATUS=0

# Track if any files were auto-fixed
FILES_FIXED=0

# Auto-fix mode (default: enabled)
AUTOFIX=1
if [ "${SKIP_AUTOFIX:-}" = "1" ]; then
    AUTOFIX=0
    echo_info "Auto-fix disabled (SKIP_AUTOFIX=1)"
fi

# Get repository root (LOW-001: Validate git output)
REPO_ROOT=$(git rev-parse --show-toplevel) || {
    echo_error "Failed to determine repository root"
    exit 1
}
# Validate path exists and is a directory
if [ ! -d "$REPO_ROOT" ]; then
    echo_error "Invalid repository root: $REPO_ROOT"
    exit 1
fi
cd "$REPO_ROOT"

# Get staged files (Added, Copied, Modified, Renamed - excluding Deleted)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$STAGED_FILES" ]; then
    echo_info "No staged files to check."
    exit 0
fi

# Filter for markdown files only
STAGED_MD_FILES=$(echo "$STAGED_FILES" | grep -E '\.md$' || true)

#
# Markdown Linting with markdownlint-cli2
#
# Security: Uses arrays and proper quoting to prevent command injection (CRITICAL-001)
# Security: Uses while/read loop to handle filenames with spaces (HIGH-001)
# Security: Checks for symlinks to prevent TOCTOU attacks (MEDIUM-002)
# Security: Prefers local installation over npx for dependency security (HIGH-002)
#

# Function to get the markdownlint command
# HIGH-002: Check for local installation first to prevent dependency confusion
get_markdownlint_cmd() {
    if [ -x "./node_modules/.bin/markdownlint-cli2" ]; then
        echo "./node_modules/.bin/markdownlint-cli2"
        return 0
    elif command -v npx &> /dev/null; then
        echo "npx markdownlint-cli2"
        return 0
    else
        return 1
    fi
}

if [ -n "$STAGED_MD_FILES" ]; then
    echo_info "Checking markdown files..."

    # Get the markdownlint command (local preferred, npx fallback)
    if ! MARKDOWNLINT_CMD=$(get_markdownlint_cmd); then
        echo_warning "markdownlint-cli2 not available. Skipping markdown linting."
        echo_warning "Install locally: npm install --save-dev markdownlint-cli2"
        echo_warning "Or install Node.js and npm to enable npx fallback."
    else
        # CRITICAL-001: Build array safely to prevent command injection
        # Use mapfile to read newline-separated file list into array
        mapfile -t MD_FILES <<< "$STAGED_MD_FILES"

        # Validate array is not empty
        if [ ${#MD_FILES[@]} -eq 0 ]; then
            echo_info "No markdown files to process."
        else
            # First, try to auto-fix
            if [ "$AUTOFIX" = "1" ]; then
                echo_action "Auto-fixing markdown files..."
                # CRITICAL-001: Use proper array expansion with quotes and -- separator
                # LOW-002: Capture stderr to temp file for review, but don't suppress completely
                LINT_ERRORS=$(mktemp)
                # shellcheck disable=SC2086
                $MARKDOWNLINT_CMD --fix --no-globs -- "${MD_FILES[@]}" 2>"$LINT_ERRORS" || true
                # Only show errors if file is non-empty (not just benign output)
                if [ -s "$LINT_ERRORS" ]; then
                    # MEDIUM-001: Show only first few lines of errors to avoid info disclosure
                    head -5 "$LINT_ERRORS" >&2 || true
                fi
                rm -f "$LINT_ERRORS"
            fi

            # MEDIUM-001: Capture verification output for structured display
            LINT_OUTPUT=$(mktemp)
            # CRITICAL-001: Use proper array expansion with quotes and -- separator
            # shellcheck disable=SC2086
            if ! $MARKDOWNLINT_CMD --no-globs -- "${MD_FILES[@]}" >"$LINT_OUTPUT" 2>&1; then
                echo_error "Markdown linting failed (some issues cannot be auto-fixed)."
                echo_info "  Review errors below and fix manually:"
                echo ""
                # MEDIUM-001: Show structured output, limiting to prevent info disclosure
                # Filter to show only the linting errors, not system paths
                grep -E '^[^/].*:.*MD[0-9]+' "$LINT_OUTPUT" 2>/dev/null | head -20 || cat "$LINT_OUTPUT" | head -20
                echo ""
                echo_info "  Common unfixable issues:"
                echo_info "    - MD040: Add language identifier to code blocks"
                echo_info "    - MD033: Wrap generic types like ArrayPool<T> in backticks"
                rm -f "$LINT_OUTPUT"
                EXIT_STATUS=1
            else
                rm -f "$LINT_OUTPUT"
                # HIGH-001: Use while/read loop with proper IFS to handle spaces in filenames
                # MEDIUM-002: Check for symlinks to prevent TOCTOU race conditions
                while IFS= read -r file; do
                    # Skip empty lines
                    [ -z "$file" ] && continue

                    # MEDIUM-002: Reject symlinks to prevent race condition attacks
                    if [ -L "$file" ]; then
                        echo_warning "Skipping symlink: $file"
                        continue
                    fi

                    # Process regular files only
                    if [ -f "$file" ] && ! git diff --quiet -- "$file" 2>/dev/null; then
                        echo_success "Fixed: $file"
                        # Use -- to prevent filenames starting with - being treated as options
                        git add -- "$file"
                        FILES_FIXED=1
                    fi
                done <<< "$STAGED_MD_FILES"
                echo_success "Markdown files OK."
            fi
        fi
    fi
else
    echo_info "No markdown files staged. Skipping markdown linting."
fi

#
# Planning Artifacts Validation
#
# Validates cross-document consistency in planning artifacts.
# Checks:
# - Effort estimate consistency (20% threshold)
# - Condition-to-task traceability (no orphan conditions)
#
# Related: Issue rjmurillo/ai-agents#I2, #I4 (Cross-Document Consistency)
#
PLANNING_VALIDATE_SCRIPT="$REPO_ROOT/build/scripts/Validate-PlanningArtifacts.ps1"

# Check if any planning files are staged
STAGED_PLANNING_FILES=$(echo "$STAGED_FILES" | grep -E '^\.agents/planning/.*\.md$' || true)

if [ -n "$STAGED_PLANNING_FILES" ]; then
    echo_info "Checking planning artifact consistency..."
    
    # MEDIUM-002: Reject symlinks for security
    if [ -L "$PLANNING_VALIDATE_SCRIPT" ]; then
        echo_warning "Skipping planning validation: script path is a symlink"
    elif [ -f "$PLANNING_VALIDATE_SCRIPT" ]; then
        if command -v pwsh &> /dev/null; then
            # Run validation in warning mode (don't block commits, but show issues)
            if ! pwsh -NoProfile -File "$PLANNING_VALIDATE_SCRIPT" -Path "$REPO_ROOT" 2>&1; then
                echo_warning "Planning artifact validation found issues (see above)."
                echo_info "  Consider running: pwsh build/scripts/Validate-PlanningArtifacts.ps1"
                # Non-blocking: just warn, don't fail the commit
            else
                echo_success "Planning artifacts OK."
            fi
        else
            echo_warning "PowerShell not available. Skipping planning artifact validation."
            echo_warning "Install: https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell"
        fi
    else
        echo_info "Planning validation script not found. Skipping."
    fi
else
    echo_info "No planning files staged. Skipping planning artifact validation."
fi

#
# Consistency Validation
#
# Validates cross-document consistency for agent-generated artifacts.
# Checks:
# - Scope alignment (epic vs PRD)
# - Requirement coverage (PRD to tasks)
# - Naming conventions (EPIC-NNN, ADR-NNN patterns)
# - Cross-reference validity (file existence)
#
# Related: Issue rjmurillo/ai-agents#44 (Phase 3 consistency)
#
CONSISTENCY_VALIDATE_SCRIPT="$REPO_ROOT/scripts/Validate-Consistency.ps1"

# Check if any planning files are staged that might need consistency validation
if [ -n "$STAGED_PLANNING_FILES" ]; then
    echo_info "Checking cross-document consistency..."

    # MEDIUM-002: Reject symlinks for security
    if [ -L "$CONSISTENCY_VALIDATE_SCRIPT" ]; then
        echo_warning "Skipping consistency validation: script path is a symlink"
    elif [ -f "$CONSISTENCY_VALIDATE_SCRIPT" ]; then
        if command -v pwsh &> /dev/null; then
            # Run validation - failures will be reported but won't block commits
            # Note: -CI flag ensures script returns non-zero exit code on failures
            if ! pwsh -NoProfile -File "$CONSISTENCY_VALIDATE_SCRIPT" -All -CI -Path "$REPO_ROOT" 2>&1; then
                echo_warning "Consistency validation found issues (see above)."
                echo_info "  Consider running: pwsh scripts/Validate-Consistency.ps1 -All"
                # Non-blocking: just warn, don't fail the commit
            else
                echo_success "Consistency validation OK."
            fi
        else
            echo_warning "PowerShell not available. Skipping consistency validation."
        fi
    else
        echo_info "Consistency validation script not found. Skipping."
    fi
fi

#
# MCP Configuration Sync
#
# Syncs Claude's .mcp.json to VS Code's mcp.json format when .mcp.json is staged.
# Claude uses "mcpServers" key, VS Code uses "servers" key.
# .mcp.json is the source of truth; mcp.json is auto-generated.
#
# Security: Checks for symlinks to prevent TOCTOU attacks (MEDIUM-002)
#
MCP_SYNC_SCRIPT="$REPO_ROOT/scripts/Sync-McpConfig.ps1"

# Check if .mcp.json is staged
STAGED_MCP_FILE=$(echo "$STAGED_FILES" | grep -E '^\.mcp\.json$' || true)

if [ -n "$STAGED_MCP_FILE" ]; then
    # Check if auto-fix is enabled (respects SKIP_AUTOFIX environment variable)
    if [ "$AUTOFIX" = "1" ]; then
        echo_info "Syncing MCP configuration..."

        # MEDIUM-002: Reject symlinks for security
        if [ -L "$MCP_SYNC_SCRIPT" ]; then
            echo_warning "Skipping MCP sync: script path is a symlink"
        elif [ -f "$MCP_SYNC_SCRIPT" ]; then
            if command -v pwsh &> /dev/null; then
            # Run sync script with PassThru to get sync status (returns True/False string)
            SYNC_OUTPUT=$(pwsh -NoProfile -File "$MCP_SYNC_SCRIPT" -PassThru 2>&1)
            SYNC_EXIT=$?

            if [ $SYNC_EXIT -eq 0 ]; then
                # Script succeeded - check if files were actually synced
                if echo "$SYNC_OUTPUT" | grep -q '^True$'; then
                    # MEDIUM-002: Defense-in-depth symlink check before staging
                    # (Mitigates TOCTOU race between PowerShell check and git add)
                    if [ -L "$REPO_ROOT/mcp.json" ]; then
                        echo_warning "Skipping MCP sync staging: mcp.json is a symlink"
                    else
                        # Files were synced - stage the generated file
                        git add -- "$REPO_ROOT/mcp.json"
                        echo_success "Synced: mcp.json"
                        FILES_FIXED=1
                    fi
                else
                    # Files already in sync (PassThru returned False)
                    echo_success "MCP config already in sync."
                fi
            else
                # Script failed
                echo_warning "MCP sync script failed (see above)."
                # Non-blocking: just warn, don't fail the commit
            fi
        else
            echo_warning "PowerShell not available. Skipping MCP config sync."
            echo_warning "Install: https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell"
        fi
    else
        echo_info "MCP sync script not found. Skipping."
    fi
    else
        echo_info "MCP config sync skipped (auto-fix disabled)."
    fi
fi

#
# Security Detection (Non-blocking warning)
#
# Detects infrastructure and security-critical file changes
# and recommends security agent review if matches found.
#
# Security: Checks for symlinks to prevent TOCTOU attacks (MEDIUM-002)
#
SECURITY_DETECTION_SCRIPT="$REPO_ROOT/.agents/utilities/security-detection/detect_infrastructure.py"

# MEDIUM-002: Reject symlinks for security detection script
if [ -L "$SECURITY_DETECTION_SCRIPT" ]; then
    echo_warning "Skipping security detection: script path is a symlink"
elif [ -f "$SECURITY_DETECTION_SCRIPT" ]; then
    if command -v python3 &> /dev/null; then
        echo_info "Checking for security-critical file changes..."
        python3 "$SECURITY_DETECTION_SCRIPT" --git-staged || true
    elif command -v python &> /dev/null; then
        echo_info "Checking for security-critical file changes..."
        python "$SECURITY_DETECTION_SCRIPT" --git-staged || true
    fi
fi

#
# Bash Detection (BLOCKING)
#
# Enforces ADR-005: PowerShell-Only Scripting Standard
# Rejects bash usage in GitHub workflow files and script files.
# Uses pwsh (PowerShell) as the approved alternative.
#
# Security: Prevents bash code from bypassing PowerShell hardening (CWE-20/CWE-78)
# Related: ADR-005, Skill-Security-010
#

# Check staged workflow files for shell: bash
STAGED_WORKFLOW_FILES=$(echo "$STAGED_FILES" | grep -E '^\.github/(workflows|scripts)/.*\.(yml|yaml)$' || true)

if [ -n "$STAGED_WORKFLOW_FILES" ]; then
    echo_info "Checking for bash usage in workflow files (ADR-005)..."

    # Check the staged diff for shell: bash declarations
    if git diff --cached -- $STAGED_WORKFLOW_FILES | grep -E '^\+.*shell:\s*bash' > /dev/null 2>&1; then
        echo_error "Bash not allowed in workflow files (ADR-005)."
        echo_info "  Use PowerShell instead: shell: pwsh"
        echo_info "  See: .agents/architecture/ADR-005-powershell-only-scripting.md"
        EXIT_STATUS=1
    else
        echo_success "No bash usage in workflow YAML files."
    fi
fi

# Check staged script files for bash shebangs
STAGED_SCRIPT_FILES=$(echo "$STAGED_FILES" | grep -E '^\.github/scripts/.*\.(sh|bash)$' || true)

if [ -n "$STAGED_SCRIPT_FILES" ]; then
    echo_error "Bash scripts (.sh, .bash) not allowed in .github/scripts/ (ADR-005)."
    echo_info "  Use PowerShell (.ps1, .psm1) instead."
    echo_info "  See: .agents/architecture/ADR-005-powershell-only-scripting.md"
    EXIT_STATUS=1
fi

# Check for bash shebangs in any staged files under .github/scripts/
STAGED_GITHUB_SCRIPT_FILES=$(echo "$STAGED_FILES" | grep -E '^\.github/scripts/' || true)

if [ -n "$STAGED_GITHUB_SCRIPT_FILES" ]; then
    # Check staged content for bash shebangs
    if git diff --cached -- $STAGED_GITHUB_SCRIPT_FILES | grep -E '^\+#!.*(bin/bash|env bash)' > /dev/null 2>&1; then
        echo_error "Bash shebang not allowed in .github/scripts/ files (ADR-005)."
        echo_info "  Use PowerShell instead. Scripts should be .ps1 files."
        echo_info "  See: .agents/architecture/ADR-005-powershell-only-scripting.md"
        EXIT_STATUS=1
    fi
fi

#
# Final Summary
#
echo ""
if [ $EXIT_STATUS -ne 0 ]; then
    echo_error "Pre-commit checks failed. Please fix the issues above."
    echo_info "  To bypass (use sparingly): git commit --no-verify"
    exit 1
fi

if [ "$FILES_FIXED" = "1" ]; then
    echo_success "All checks passed. Some files were auto-fixed and re-staged."
else
    echo_success "All pre-commit checks passed."
fi
exit 0
