---
number: 171
title: "feat: Add Consensus Mechanisms for Multi-Agent Decisions"
state: OPEN
created_at: 12/20/2025 11:08:57
author: rjmurillo-bot
labels: ["enhancement"]
assignees: []
milestone: null
url: https://github.com/rjmurillo/ai-agents/issues/171
---

# feat: Add Consensus Mechanisms for Multi-Agent Decisions

## Summary

Implement consensus mechanisms to handle disagreements between specialist agents during impact analysis and complex decisions.

## Background

Claude-flow supports multiple consensus algorithms: Majority, Weighted (expertise-based), Byzantine (2/3 majority), Quorum, and Unanimous. Decisions are recorded with confidence scores.

## Current State

- Orchestrator makes all routing decisions
- Critic escalates disagreements to high-level-advisor
- No formal voting or consensus mechanism
- Disagree-and-commit is manual

## Proposed Solution

1. **Consensus Algorithms**:
   - `majority`: Simple majority voting
   - `weighted`: Expertise-weighted (architect > implementer for design)
   - `quorum`: Require minimum participation before deciding
   - `unanimous`: All specialists must agree (for critical decisions)
   
2. **Decision Recording**:
   - Topic and context
   - Individual votes with rationale
   - Algorithm used
   - Confidence score
   - Final decision
   
3. **Integration Points**:
   - Impact analysis consultations
   - Architecture decision reviews
   - Security-sensitive changes
   - Breaking change approvals
   
4. **Escalation Path**:
   - If consensus fails, escalate to high-level-advisor
   - Document dissenting opinions
   - Apply disagree-and-commit once decided

## Benefits

- More robust multi-agent decisions
- Documented rationale for controversial choices
- Reduced orchestrator bottleneck
- Enable swarm-like coordination patterns

## Implementation Notes

- Store decisions in .agents/decisions/ or SQLite
- Weight table by agent type and decision domain
- Add consensus-reached event for metrics

## Reference

See claude-flow's Consensus and Decision Making (wiki page 8.4).

## Analysis Document

`.agents/analysis/claude-flow-architecture-analysis.md`

---

## Comments

### Comment by @coderabbitai on 12/20/2025 11:10:30

<!-- This is an auto-generated issue plan by CodeRabbit -->


### üìù CodeRabbit Plan Mode
Generate an implementation plan and prompts that you can use with your favorite coding agent.

- [ ] <!-- {"checkboxId": "8d4f2b9c-3e1a-4f7c-a9b2-d5e8f1c4a7b9"} --> Create Plan

<details>
<summary>Examples</summary>

- [Example 1](https://github.com/coderabbitai/git-worktree-runner/issues/29#issuecomment-3589134556)
- [Example 2](https://github.com/coderabbitai/git-worktree-runner/issues/12#issuecomment-3606665167)

</details>

---

<details>
<summary><b>üîó Similar Issues</b></summary>

**Related Issues**
- https://github.com/rjmurillo/ai-agents/issues/168
- https://github.com/rjmurillo/ai-agents/issues/169
- https://github.com/rjmurillo/ai-agents/issues/8
- https://github.com/rjmurillo/ai-agents/issues/5
</details>
<details>
<summary><b>üîó Related PRs</b></summary>

rjmurillo/vs-code-agents#11 - feat: achieve Claude agent parity with VS Code agents [merged]
</details>
<details>
<summary><b>üë§ Suggested Assignees</b></summary>

- [rjmurillo](https://github.com/rjmurillo)
- [rjmurillo-bot](https://github.com/rjmurillo-bot)
</details>


---
<details>
<summary> üß™ Issue enrichment is currently in open beta.</summary>


You can configure auto-planning by selecting labels in the issue_enrichment configuration.

To disable automatic issue enrichment, add the following to your `.coderabbit.yaml`:
```yaml
issue_enrichment:
  auto_enrich:
    enabled: false
```
</details>

üí¨ Have feedback or questions? Drop into our [discord](https://discord.gg/coderabbit) or [schedule a call](https://calendly.com/parth-coderabbit/issues-feedback)!

### Comment by @github-actions on 12/20/2025 11:13:49

<!-- AI-PRD-GENERATION -->

## üìã Product Requirements Document

> [!IMPORTANT]
> This PRD was automatically generated based on issue triage escalation.
> **Complexity Score**: 10/12 ()
> **Escalation Criteria**: feature_request, research_required, architectural_impact, multi_phase_work

<details>
<summary>üìñ About this PRD</summary>

This PRD was generated by the **Explainer Agent** after the issue was flagged
for detailed analysis. The document is designed to be self-contained - it can
be passed to a separate AI agent instance for implementation without additional
context.

**PRD Depth Levels**:
- **Standard** (4-6): Brief analysis, clear requirements
- **Detailed** (7-9): Research section, blocking questions
- **Comprehensive** (10-12): Phased implementation, risk analysis

</details>

---

Now let me read the referenced analysis document and explore the current state of the codebase:

Let me explore the existing disagree-and-commit protocol and architecture more thoroughly:

Now I have sufficient context. Let me create a comprehensive PRD for the Consensus Mechanisms feature.

The file creation was blocked by permissions. Let me output the PRD content directly for the user:

---

# PRD: Consensus Mechanisms for Multi-Agent Decisions

## Executive Summary

The ai-agents system lacks formal voting and consensus mechanisms for handling disagreements between specialist agents during impact analysis and complex decisions. The orchestrator currently makes all routing decisions unilaterally, and the critic escalates disagreements to high-level-advisor without structured voting. This creates bottlenecks and undocumented decision rationale.

| Scope | Status | Blocker |
|-------|--------|---------|
| Consensus algorithm framework | :green_circle: READY | None |
| Decision recording infrastructure | :green_circle: READY | None |
| Agent prompt integration | :green_circle: READY | None |
| Weight table definition | :yellow_circle: PARTIAL | Requires domain-agent mapping validation |
| SQLite storage option | :yellow_circle: PARTIAL | Architecture decision pending (file vs database) |

**Verdict**: READY with PARTIAL elements. Core implementation can proceed. Weight table calibration and storage architecture require additional research.

---

## Problem Statement

### Current State

| Component | Current Behavior | Limitation |
|-----------|------------------|------------|
| Orchestrator | Unilateral routing decisions | No specialist input on complex choices |
| Critic | Escalates disagreements to high-level-advisor | Binary escalation, no voting mechanism |
| Impact Analysis | Collects specialist opinions sequentially | No formal consensus protocol |
| Decision Recording | Manual documentation in critique files | No structured decision history |
| Disagree-and-Commit | Protocol documented but not formalized | No vote recording, no confidence scores |

### Gap Analysis

1. **No Voting Infrastructure**: When specialists disagree during impact analysis, there is no mechanism to aggregate votes or apply weighted expertise.

2. **Manual Escalation Path**: The current path (critic detects conflict, documents, recommends escalation) is ad-hoc. There is no algorithm selection based on decision type.

3. **Undocumented Rationale**: Decisions are made but rationale is scattered across critique files. No single source of truth for "why did we decide X?"

4. **Orchestrator Bottleneck**: All decisions flow through orchestrator. For routine decisions where specialists have clear expertise, direct consensus could reduce latency.

5. **No Confidence Scoring**: Decisions lack confidence indicators that could inform implementation priority or rollback triggers.

### User Impact

| User | Impact | Severity |
|------|--------|----------|
| Orchestrator Agent | Must manually synthesize conflicting recommendations | Medium |
| Critic Agent | Escalation protocol is ambiguous for edge cases | Medium |
| High-Level-Advisor | Receives unstructured conflict reports | High |
| Retrospective Agent | Cannot analyze decision patterns without structured data | High |
| Human Operators | No visibility into multi-agent decision quality | Medium |

---

## Research Findings

### Primary Sources

**Source**: Claude-flow Wiki (Referenced in Issue)

- Supports 5 consensus algorithms: Majority, Weighted, Byzantine, Quorum, Unanimous
- Decisions recorded with confidence scores
- Algorithm selection based on decision criticality

**Confidence**: CONFIRMED (direct documentation reference)

**Source**: Current AGENTS.md (Disagree and Commit Protocol)

```markdown
*Phase 1 - Decision (Dissent Encouraged)*:
- All specialists present their positions with data and rationale
- Disagreements are surfaced explicitly and documented

*Phase 2 - Resolution*:
- If consensus emerges ‚Üí proceed with agreed approach
- If conflict persists ‚Üí escalate to high-level-advisor for decision

*Phase 3 - Commitment*:
- Once decision is made, ALL specialists commit to execution
```

**Confidence**: CONFIRMED (existing codebase)

### Secondary Sources

**Source**: Distributed Systems Consensus Literature

- Byzantine fault tolerance requires 2/3 majority (n > 3f where f = faulty nodes)
- Quorum systems provide availability vs consistency tradeoffs
- Weighted voting systems common in multi-expert decision systems

**Confidence**: CONFIRMED (established computer science)

### Empirical Data

**Observation**: Current impact analysis in planner.md shows sequential specialist consultation without aggregation protocol.

**Observation**: orchestrator.md documents escalation to high-level-advisor but no intermediate voting step.

**Confidence**: CONFIRMED (code analysis)

---

## Proposed Solution

### Phase 1: Consensus Framework Core (Status: READY)

**Estimated Effort**: M (8-12 hours)
**Blockers**: None

| Task | Description |
|------|-------------|
| 1.1 | Define consensus algorithm specifications in `.agents/governance/consensus-protocol.md` |
| 1.2 | Create decision record schema for `.agents/decisions/` directory |
| 1.3 | Document algorithm selection criteria based on decision type |
| 1.4 | Define vote format and confidence score scale |

### Phase 2: Agent Prompt Integration (Status: READY)

**Estimated Effort**: M (6-10 hours)
**Blockers**: Depends on Phase 1 completion

| Task | Description |
|------|-------------|
| 2.1 | Update orchestrator.md with consensus invocation protocol |
| 2.2 | Update critic.md with voting aggregation responsibilities |
| 2.3 | Update planner.md with consensus triggers during impact analysis |
| 2.4 | Update high-level-advisor.md with tiebreaker role |
| 2.5 | Update specialist agents (architect, security, devops, qa, implementer) with vote submission format |

### Phase 3: Weight Table and Calibration (Status: PARTIAL)

**Estimated Effort**: S (4-6 hours)
**Blockers**: Requires domain-agent expertise mapping validation

| Task | Description |
|------|-------------|
| 3.1 | Define weight table by agent type and decision domain |
| 3.2 | Document weight adjustment protocol |
| 3.3 | Create calibration test cases |

### Phase 4: Storage and Metrics (Status: PARTIAL)

**Estimated Effort**: M (6-8 hours)
**Blockers**: Architecture decision: file-based vs SQLite

| Task | Description |
|------|-------------|
| 4.1 | Implement decision record storage (format TBD) |
| 4.2 | Add consensus-reached event logging for metrics |
| 4.3 | Create decision query utilities for retrospective analysis |

---

## Functional Requirements

### FR-1: Consensus Algorithms

**Priority**: P0

| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| FR-1.1 | System SHALL support majority voting | Decisions pass with >50% agent agreement |
| FR-1.2 | System SHALL support weighted voting | Votes weighted by agent expertise for decision domain |
| FR-1.3 | System SHALL support quorum voting | Decisions require minimum N agents to participate |
| FR-1.4 | System SHALL support unanimous voting | All participating agents must agree |
| FR-1.5 | System MAY support Byzantine voting | Decisions require 2/3 majority for fault tolerance |

### FR-2: Decision Recording

**Priority**: P0

| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| FR-2.1 | Each decision SHALL record topic and context | Decision file contains topic field and context summary |
| FR-2.2 | Each decision SHALL record individual votes | Vote table includes agent, position, rationale |
| FR-2.3 | Each decision SHALL record algorithm used | Algorithm field populated with one of: majority, weighted, quorum, unanimous, byzantine |
| FR-2.4 | Each decision SHALL record confidence score | Numeric score 0-100 based on vote distribution |
| FR-2.5 | Each decision SHALL record final outcome | Outcome field with decision and implementation path |

### FR-3: Integration Points

**Priority**: P1

| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| FR-3.1 | Consensus SHALL trigger during multi-specialist impact analysis | When 3+ specialists consulted, consensus protocol activates |
| FR-3.2 | Consensus SHALL trigger for architecture decision reviews | ADR creation or modification requires architect + 1 specialist agreement |
| FR-3.3 | Consensus SHALL trigger for security-sensitive changes | Security agent vote required for changes touching Auth, secrets, external APIs |
| FR-3.4 | Consensus SHALL trigger for breaking change approvals | Unanimous agreement required for API breaking changes |

### FR-4: Escalation Path

**Priority**: P1

| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| FR-4.1 | Failed consensus SHALL escalate to high-level-advisor | When algorithm cannot reach decision, automatic escalation |
| FR-4.2 | Dissenting opinions SHALL be documented | All non-majority votes recorded with rationale |
| FR-4.3 | Disagree-and-commit SHALL apply post-decision | Agents execute decided approach regardless of initial vote |

---

## Non-Functional Requirements

### Consistency

| Requirement | Target |
|-------------|--------|
| Match existing handoff protocol patterns | 100% alignment with AGENTS.md handoff syntax |
| Match existing memory protocol patterns | 100% alignment with cloudmcp-manager usage |
| Match existing artifact naming conventions | Follow `.agents/governance/naming-conventions.md` |

### Testability

| Requirement | Target |
|-------------|--------|
| Decision records are valid markdown | Linting passes on all decision files |
| Confidence score calculation is deterministic | Same inputs produce same confidence score |
| Algorithm selection is testable | Decision tree can be unit tested |

### Documentation

| Requirement | Target |
|-------------|--------|
| Consensus protocol documented in governance | Full protocol in `.agents/governance/consensus-protocol.md` |
| Agent prompt updates documented | Changelog in each modified agent file |
| Weight table documented | Rationale for each weight assignment |

---

## Technical Design

### Decision Record Schema

**Location**: `.agents/decisions/YYYY-MM-DD-NNN-[topic].md`

```markdown
# Decision: [Topic]

**Date**: YYYY-MM-DD
**Algorithm**: majority | weighted | quorum | unanimous | byzantine
**Status**: PENDING | DECIDED | ESCALATED
**Confidence**: [0-100]%

## Context

[Brief description of decision required]

## Votes

| Agent | Position | Rationale | Weight |
|-------|----------|-----------|--------|
| architect | approve | Aligns with ADR-005 | 2.0 |
| security | reject | Introduces SSRF risk | 1.5 |
| implementer | approve | Low implementation complexity | 1.0 |

## Algorithm Application

**Algorithm**: weighted
**Total Weight**: 4.5
**Approve Weight**: 3.0 (67%)
**Reject Weight**: 1.5 (33%)
**Threshold**: 50%
**Result**: APPROVED

## Confidence Score Calculation

Base confidence: 67% (weighted approval percentage)
Specialist alignment bonus: +10% (architect approved)
Dissent penalty: -5% (security rejected)
**Final Confidence**: 72%

## Final Decision

[Statement of decision with implementation guidance]

## Dissenting Opinions

### Security Agent

[Full rationale for rejection, preserved for retrospective]

## Disagree-and-Commit Acknowledgments

- [ ] Security agent acknowledges decision and commits to execution
```

### Weight Table Definition

**Location**: `.agents/governance/consensus-weights.md`

```markdown
# Consensus Weight Table

## Weight by Agent and Domain

| Agent | Architecture | Security | Operations | Code | Quality |
|-------|-------------|----------|------------|------|---------|
| architect | 2.0 | 1.0 | 1.0 | 1.0 | 1.0 |
| security | 1.0 | 2.0 | 1.5 | 1.0 | 1.0 |
| devops | 1.0 | 1.0 | 2.0 | 1.0 | 1.0 |
| implementer | 1.0 | 0.5 | 0.5 | 2.0 | 1.0 |
| qa | 0.5 | 1.0 | 1.0 | 1.0 | 2.0 |

## Weight Adjustment Protocol

Weights may be adjusted based on:
1. Demonstrated expertise (validated by retrospective)
2. Domain-specific track record
3. Steering committee decision

All adjustments require ADR documentation.
```

### Algorithm Selection Criteria

```text
Is this a breaking API change?
‚îú‚îÄ‚îÄ YES ‚Üí unanimous (all affected specialists must agree)
‚îî‚îÄ‚îÄ NO ‚Üí Is this security-sensitive?
         ‚îú‚îÄ‚îÄ YES ‚Üí weighted (security agent has elevated weight)
         ‚îî‚îÄ‚îÄ NO ‚Üí Is this multi-domain (3+ areas)?
                  ‚îú‚îÄ‚îÄ YES ‚Üí quorum (minimum 3 specialists must participate)
                  ‚îî‚îÄ‚îÄ NO ‚Üí majority (simple majority of consulted specialists)
```

### Confidence Score Formula

```text
Base Confidence = (Winning Vote Weight / Total Weight) * 100

Adjustments:
+10% if primary domain specialist voted with majority
-5% per dissenting specialist (capped at -20%)
+5% if unanimous within domain specialists
-10% if escalation was required

Final Confidence = Base + Adjustments (clamped to 0-100)
```

### Orchestrator Integration

Add to orchestrator.md:

```markdown
## Consensus Protocol

When routing to multiple specialists for impact analysis:

1. Collect votes from each specialist using vote submission format
2. Identify decision domain from task classification
3. Select algorithm per decision tree
4. Apply algorithm and calculate confidence
5. If algorithm fails (no decision): escalate to high-level-advisor
6. Record decision to `.agents/decisions/`
7. Announce decision to all specialists
8. Collect disagree-and-commit acknowledgments
9. Proceed with implementation
```

### Vote Submission Format

Add to specialist agent prompts:

```markdown
## Vote Submission

When participating in consensus decisions:

**Format**:
VOTE: [approve | reject | abstain]
CONFIDENCE: [0-100]%
RATIONALE: [1-3 sentence justification with evidence]
CONDITIONS: [optional conditions for approval]
```

---

## Implementation Plan

### Prerequisites

1. Read and understand current disagree-and-commit protocol in AGENTS.md
2. Review existing impact analysis framework in planner.md
3. Verify `.agents/decisions/` directory creation permissions
4. Confirm no conflicting governance documentation exists

### Decision Tree

```text
Is storage architecture decided?
‚îú‚îÄ‚îÄ YES ‚Üí Proceed to Phase 4 implementation
‚îî‚îÄ‚îÄ NO ‚Üí Execute Discovery Phase
         ‚îú‚îÄ‚îÄ Evaluate file-based vs SQLite tradeoffs
         ‚îú‚îÄ‚îÄ Consider query requirements for retrospective
         ‚îú‚îÄ‚îÄ Document decision in ADR
         ‚îî‚îÄ‚îÄ Return to decision tree
```

### Implementation Phases

**Phase 1 (Days 1-2)**: Foundation

1. Create `.agents/governance/consensus-protocol.md`
2. Create `.agents/governance/consensus-weights.md`
3. Create `.agents/decisions/` directory
4. Define decision record template

**Phase 2 (Days 3-4)**: Agent Integration

1. Update orchestrator.md with consensus invocation
2. Update critic.md with vote aggregation
3. Update planner.md with consensus triggers
4. Update specialist agents with vote format

**Phase 3 (Day 5)**: Validation

1. Create test scenarios for each algorithm
2. Validate weight table with domain experts
3. Run end-to-end consensus flow

**Phase 4 (Days 6-7)**: Metrics and Refinement

1. Implement decision storage (file-based initially)
2. Add consensus-reached event logging
3. Create retrospective query utilities

---

## Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Weight table creates unfair bias | Medium | High | Document all weights with rationale; allow steering committee override |
| Consensus adds latency to decisions | Medium | Medium | Set time limits per algorithm; auto-escalate on timeout |
| Agents game the voting system | Low | High | Retrospective analysis of vote patterns; anomaly detection |
| File-based storage insufficient for queries | Medium | Medium | Design for migration to SQLite if needed |
| Unanimous requirement blocks progress | Medium | High | Time-boxed unanimous attempts; fallback to weighted |

---

## Success Metrics

| Metric | Target |
|--------|--------|
| Decisions with recorded rationale | 100% of consensus-triggered decisions |
| Confidence score accuracy | Correlation with implementation success > 0.7 |
| Escalation rate | < 20% of consensus decisions require high-level-advisor |
| Time to decision | < 5 specialist turns for non-unanimous algorithms |
| Disagree-and-commit compliance | 100% (agents execute decided approach) |

---

## Blocking Questions

None. All questions are non-blocking and can be resolved during implementation.

---

## Open Questions (Non-Blocking)

1. **Q**: Should Byzantine fault tolerance be included in v1, or deferred?
   - **Hypothesis**: Defer to v2. Current agent system has no reliability concerns requiring BFT.
   - **Status**: Would be validated by production usage patterns.

2. **Q**: How should abstentions affect quorum calculations?
   - **Hypothesis**: Abstentions count toward participation but not toward decision threshold.
   - **Status**: Document in protocol; adjust based on usage.

3. **Q**: Should confidence scores affect implementation priority?
   - **Hypothesis**: Yes. Low-confidence decisions (< 60%) should be flagged for closer monitoring.
   - **Status**: Implement in Phase 4 metrics.

4. **Q**: Storage format: file-based markdown or SQLite?
   - **Hypothesis**: Start with file-based for consistency with existing `.agents/` artifacts.
   - **Status**: Migrate to SQLite if query patterns demand it.

---

## Appendices

### Appendix A: Research Sources

1. Claude-flow Wiki - Consensus and Decision Making (Section 8.4)
2. AGENTS.md - Disagree and Commit Protocol
3. orchestrator.md - Impact Analysis Orchestration
4. planner.md - Multi-Agent Impact Analysis Framework
5. critic.md - Disagreement Detection & Escalation

### Appendix B: Related Governance Documents

1. `.agents/governance/agent-design-principles.md` - Principle 4: Composability
2. `.agents/governance/consistency-protocol.md` - Cross-document validation
3. `.agents/governance/naming-conventions.md` - Artifact naming patterns

### Appendix C: Related Issues/PRs

1. Issue: feat: Add Consensus Mechanisms for Multi-Agent Decisions
2. PR #40: Multi-Agent Impact Analysis implementation
3. AGENTS.md: Existing disagree-and-commit documentation

---

**Revision History**

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-20 | explainer | Initial PRD creation |

---

<sub>üìã Generated by [AI PRD Generation](https://github.com/rjmurillo/ai-agents) ¬∑ [View Workflow](https://github.com/rjmurillo/ai-agents/actions/runs/20393503266)</sub>



### Comment by @github-actions on 12/20/2025 11:13:52

<!-- AI-ISSUE-TRIAGE -->

## AI Triage Summary

> [!NOTE]
> This issue has been automatically triaged by AI agents

<details>
<summary>What is AI Triage?</summary>

This issue was analyzed by AI agents:

- **Analyst Agent**: Categorizes the issue and suggests appropriate labels
- **Roadmap Agent**: Aligns the issue with project milestones and priorities
- **Explainer Agent** (if escalated): Generates comprehensive PRD

</details>

### Triage Results

| Property | Value |
|:---------|:------|
| **Category** | `enhancement` |
| **Labels** | enhancement agent-orchestrator |
|  **Priority** | `P2` |
| **Milestone** | v1.2 |
| **PRD Escalation** | Generated (see below) |

<details>
<summary>Categorization Analysis</summary>

```json
```json
{
  "labels": ["enhancement", "agent-orchestrator"],
  "category": "enhancement",
  "confidence": 0.92,
  "reasoning": "Feature request for adding consensus mechanisms to coordinate multi-agent decision-making, primarily affecting orchestrator routing and agent coordination"
}
```

```

</details>

<details>
<summary>Roadmap Alignment</summary>

```json
```json
{
  "milestone": "v1.2",
  "priority": "P2",
  "epic_alignment": "",
  "confidence": 0.70,
  "reasoning": "Feature request for multi-agent coordination patterns; not blocking v1.0/v1.1 work and requires architectural research on consensus algorithm integration points.",
  "escalate_to_prd": true,
  "escalation_criteria": ["feature_request", "research_required", "architectural_impact", "multi_phase_work"],
  "complexity_score": 10
}
```

```

</details>

---

<sub>Powered by [AI Issue Triage](https://github.com/rjmurillo/ai-agents) - [View Workflow](https://github.com/rjmurillo/ai-agents/actions/runs/20393503266)</sub>


