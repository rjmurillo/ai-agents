---
number: 170
title: "feat: Implement Lifecycle Hooks for Session Automation"
state: OPEN
created_at: 12/20/2025 11:08:27
author: rjmurillo-bot
labels: ["enhancement"]
assignees: []
milestone: null
url: https://github.com/rjmurillo/ai-agents/issues/170
---

# feat: Implement Lifecycle Hooks for Session Automation

## Summary

Implement a lifecycle hooks system to automate session protocol tasks and enable customizable workflow automation.

## Background

Claude-flow provides comprehensive hooks: pre-task, post-task, pre-edit, post-edit, session-start, session-end, and MCP integration hooks. These enable automated preparation, cleanup, and coordination without manual intervention.

## Current State

- Session protocol relies on manual compliance
- No automated checkpointing
- No pre/post operation hooks
- Agent coordination is manual

## Proposed Solution

1. **Session Hooks**:
   - `session-start`: Load context, verify handoff, create session log
   - `session-end`: Update handoff, run linting, commit changes
   - `session-restore`: Resume from checkpoint
   
2. **Task Hooks**:
   - `pre-task`: Load relevant memories, spawn helper agents
   - `post-task`: Store learnings, update metrics, trigger retrospective
   
3. **Edit Hooks**:
   - `pre-edit`: Validate syntax, create backup
   - `post-edit`: Store context, notify coordination
   
4. **MCP Integration Hooks**:
   - `agent-spawned`: Update agent roster
   - `task-orchestrated`: Monitor progress
   
5. **Modification Hooks** (advanced):
   - `modify-git-commit`: Add conventional commit prefix
   - `modify-file`: Format hints, root protection

## Benefits

- Enforce session protocol automatically
- Reduce manual overhead
- Enable consistent agent coordination
- Provide customization points for workflows

## Implementation Notes

- Define hooks in .claude/settings.json or equivalent
- Hooks can be scripts or inline logic
- Support async execution for non-blocking hooks
- Provide hook templates for common patterns

## Reference

See claude-flow's Hooks System and Agent Coordination Protocol (wiki page 8.2).

## Analysis Document

`.agents/analysis/claude-flow-architecture-analysis.md`

---

## Comments

### Comment by @coderabbitai on 12/20/2025 11:10:18

<!-- This is an auto-generated issue plan by CodeRabbit -->


### üìù CodeRabbit Plan Mode
Generate an implementation plan and prompts that you can use with your favorite coding agent.

- [ ] <!-- {"checkboxId": "8d4f2b9c-3e1a-4f7c-a9b2-d5e8f1c4a7b9"} --> Create Plan

<details>
<summary>Examples</summary>

- [Example 1](https://github.com/coderabbitai/git-worktree-runner/issues/29#issuecomment-3589134556)
- [Example 2](https://github.com/coderabbitai/git-worktree-runner/issues/12#issuecomment-3606665167)

</details>

---

<details>
<summary><b>üîó Similar Issues</b></summary>

**Related Issues**
- https://github.com/rjmurillo/ai-agents/issues/168
- https://github.com/rjmurillo/ai-agents/issues/169
- https://github.com/rjmurillo/ai-agents/issues/166
- https://github.com/rjmurillo/ai-agents/issues/57
- https://github.com/rjmurillo/ai-agents/issues/9
</details>
<details>
<summary><b>üîó Related PRs</b></summary>

rjmurillo/vs-code-agents#11 - feat: achieve Claude agent parity with VS Code agents [merged]
</details>
<details>
<summary><b>üë§ Suggested Assignees</b></summary>

- [rjmurillo-bot](https://github.com/rjmurillo-bot)
- [rjmurillo](https://github.com/rjmurillo)
</details>


---
<details>
<summary> üß™ Issue enrichment is currently in open beta.</summary>


You can configure auto-planning by selecting labels in the issue_enrichment configuration.

To disable automatic issue enrichment, add the following to your `.coderabbit.yaml`:
```yaml
issue_enrichment:
  auto_enrich:
    enabled: false
```
</details>

üí¨ Have feedback or questions? Drop into our [discord](https://discord.gg/coderabbit) or [schedule a call](https://calendly.com/parth-coderabbit/issues-feedback)!

### Comment by @github-actions on 12/20/2025 11:13:10

<!-- AI-PRD-GENERATION -->

## üìã Product Requirements Document

> [!IMPORTANT]
> This PRD was automatically generated based on issue triage escalation.
> **Complexity Score**: 10/12 ()
> **Escalation Criteria**: feature_request, multi_phase_work, architectural_impact, research_required

<details>
<summary>üìñ About this PRD</summary>

This PRD was generated by the **Explainer Agent** after the issue was flagged
for detailed analysis. The document is designed to be self-contained - it can
be passed to a separate AI agent instance for implementation without additional
context.

**PRD Depth Levels**:
- **Standard** (4-6): Brief analysis, clear requirements
- **Detailed** (7-9): Research section, blocking questions
- **Comprehensive** (10-12): Phased implementation, risk analysis

</details>

---

Let me continue gathering context by examining the existing architecture and related documentation.

Now let me look at the current session protocol more closely to understand the automation opportunity, and check if there are any existing hook-related implementations.

Now I have sufficient context. Let me create the PRD for the Lifecycle Hooks feature. Based on the issue complexity (extensive scope with 5 hook types, integration with session protocol, and claude-flow reference), this is a comprehensive PRD.

The directory exists. The permission denial may be transient. Let me output the PRD content directly since I cannot create the file:

---

# PRD: Lifecycle Hooks for Session Automation

## Introduction/Overview

Lifecycle hooks provide automation points throughout AI agent session execution, enabling automated preparation, cleanup, and coordination without manual intervention. This system addresses the friction between documented session protocol requirements and agent compliance by transforming trust-based guidance into automated enforcement.

## Executive Summary

| Scope | Status | Blocker |
|-------|--------|---------|
| Session hooks (start/end/restore) | :yellow_circle: PARTIAL | Hook execution engine design needed |
| Task hooks (pre/post) | :yellow_circle: PARTIAL | Task boundary detection undefined |
| Edit hooks (pre/post) | :red_circle: BLOCKED | No file operation interception capability in current architecture |
| MCP integration hooks | :yellow_circle: PARTIAL | MCP server coordination pattern undefined |
| Modification hooks | :red_circle: BLOCKED | Requires file system interception not available in agent runtime |

**Verdict**: PARTIAL. Session and task hooks are implementable with existing infrastructure. Edit and modification hooks require architectural discovery. Recommend phased implementation starting with session hooks.

---

## Problem Statement

### Current State

| Component | Description | Status |
|-----------|-------------|--------|
| Session Protocol | RFC 2119 requirements in `.agents/SESSION-PROTOCOL.md` | Manual compliance |
| HANDOFF.md | Cross-session context bridge | Manual updates |
| Session Logs | Per-session documentation at `.agents/sessions/` | Manual creation |
| Serena Initialization | BLOCKING gate requiring tool calls | Manual execution |
| Skill Validation | Phase 1.5 gate for skill availability | Manual verification |
| Markdown Linting | Required at session end | Manual execution |
| Git Operations | Commit requirements at session end | Manual execution |

### Gap Analysis

The current system relies on agents reading and following protocol documentation. Evidence from Session 15 retrospective shows this trust-based approach fails:

- 5+ skill usage violations in a single session
- Protocol requirements skipped despite documentation
- Verification-based gates (Serena init) achieve 100% compliance
- Trust-based guidance achieves less than 70% compliance

**Missing capability**: No mechanism to automatically execute protocol requirements without agent memory and discipline.

### User Impact

| User Type | Impact |
|-----------|--------|
| Developers using agents | Repeated context loss between sessions |
| Maintainers | Inconsistent documentation and commits |
| System operators | No telemetry on protocol compliance |

---

## Research Findings

### Primary Sources

**claude-flow Hooks System (wiki page 8.2)**

The issue references claude-flow as an exemplar. Research indicates claude-flow provides:

- Pre/post task hooks with async execution
- Session lifecycle hooks for preparation and cleanup
- MCP integration hooks for agent coordination
- File modification hooks with validation

**Confidence Level**: UNCERTAIN. No direct access to claude-flow documentation. Issue author references wiki page 8.2 without providing content.

### Secondary Sources

**Session Protocol Enforcement (Session 17 Implementation)**

Verification-based enforcement using technical controls achieves 100% compliance. Key patterns:

- BLOCKING gates that prevent progress until requirements met
- Observable checkpoints producing verifiable evidence
- Validation tooling detecting violations automatically

**Source**: `.agents/SESSION-PROTOCOL.md`, Session 17 session log

**Confidence Level**: CONFIRMED. Implemented and validated in production.

### Empirical Data

**Protocol Compliance Rates (from Session 15 retrospective)**

| Enforcement Type | Compliance Rate |
|------------------|-----------------|
| BLOCKING gate (Serena init) | 100% |
| Trust-based (skill usage) | Less than 70% |
| Documentation-only (commit atomicity) | Variable |

---

## Proposed Solution

### Phase 1: Session Hooks (Status: READY)

**Estimated Effort**: M (3-5 sessions)
**Blockers**: None

| Task | Description |
|------|-------------|
| 1.1 | Define hook configuration schema in `.claude/settings.json` or `.agents/hooks/` |
| 1.2 | Implement `session-start` hook executing: Serena init, HANDOFF read, session log creation |
| 1.3 | Implement `session-end` hook executing: HANDOFF update, markdown lint, git commit |
| 1.4 | Implement `session-restore` hook for checkpoint resumption |
| 1.5 | Create hook template library for common patterns |
| 1.6 | Add hook execution telemetry and logging |

### Phase 2: Task Hooks (Status: DEPENDS on Phase 1)

**Estimated Effort**: M (3-5 sessions)
**Blockers**: Task boundary detection mechanism

| Task | Description |
|------|-------------|
| 2.1 | Define task boundary detection (agent handoff, user prompt, explicit markers) |
| 2.2 | Implement `pre-task` hook for memory loading and helper agent spawning |
| 2.3 | Implement `post-task` hook for learning storage and metrics update |
| 2.4 | Integrate with existing orchestrator routing patterns |

### Phase 3: MCP Integration Hooks (Status: DEPENDS on Phase 2)

**Estimated Effort**: S (1-2 sessions)
**Blockers**: MCP server coordination pattern definition

| Task | Description |
|------|-------------|
| 3.1 | Define MCP event taxonomy (agent-spawned, task-orchestrated, etc.) |
| 3.2 | Implement agent roster tracking via `agent-spawned` hook |
| 3.3 | Implement progress monitoring via `task-orchestrated` hook |

### Phase 4: Edit Hooks (Status: BLOCKED)

**Estimated Effort**: L (5+ sessions)
**Blockers**: File operation interception capability

| Task | Description |
|------|-------------|
| 4.1 | DISCOVERY: Research file system interception options |
| 4.2 | Implement `pre-edit` hook for syntax validation and backup |
| 4.3 | Implement `post-edit` hook for context storage and coordination |

### Phase 5: Modification Hooks (Status: BLOCKED)

**Estimated Effort**: L (5+ sessions)
**Blockers**: Runtime modification capability

| Task | Description |
|------|-------------|
| 5.1 | DISCOVERY: Research output modification patterns |
| 5.2 | Implement `modify-git-commit` for conventional commit prefix |
| 5.3 | Implement `modify-file` for format hints and root protection |

---

## Functional Requirements

### FR-1: Hook Configuration

**Priority**: P0

| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| FR-1.1 | System MUST support hook configuration via JSON file | Configuration loads without error, hooks execute per config |
| FR-1.2 | System MUST support multiple hook types per lifecycle event | Multiple hooks execute in defined order |
| FR-1.3 | System MUST support both script and inline hook definitions | Both execution modes produce expected results |
| FR-1.4 | System SHOULD support hook enable/disable toggling | Disabled hooks do not execute |

### FR-2: Session Hooks

**Priority**: P0

| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| FR-2.1 | `session-start` hook MUST execute before any agent work | Serena init, HANDOFF read, session log creation occur before first user response |
| FR-2.2 | `session-end` hook MUST execute before session close | HANDOFF updated, lint passes, changes committed |
| FR-2.3 | `session-restore` hook MUST load checkpoint state | Previous session context restored from checkpoint |
| FR-2.4 | Session hooks MUST produce verifiable evidence | Hook execution logged with timestamps |

### FR-3: Task Hooks

**Priority**: P1

| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| FR-3.1 | `pre-task` hook MUST execute before task processing | Memory loaded, helper agents available |
| FR-3.2 | `post-task` hook MUST execute after task completion | Learnings stored, metrics updated |
| FR-3.3 | Task hooks MUST receive task context | Hook receives task type, agent, and scope |

### FR-4: Hook Execution

**Priority**: P0

| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| FR-4.1 | Hooks MUST support async execution for non-blocking operations | Async hooks do not block session progress |
| FR-4.2 | Hook failures MUST NOT crash session (graceful degradation) | Failed hook logged, session continues |
| FR-4.3 | Hooks MUST have timeout protection | Hung hook terminates after configurable timeout |
| FR-4.4 | Hook execution MUST be logged for debugging | Hook start, end, and result logged |

---

## Non-Functional Requirements

### Consistency

- Hook patterns MUST align with existing PowerShell-only constraint (ADR-005)
- Hook configuration MUST follow existing naming conventions
- Hook output directories MUST use established `.agents/` structure

### Testability

- All hook implementations MUST have Pester tests with 80%+ coverage
- Hook behavior MUST be testable in isolation (no live sessions required)
- Integration tests MUST validate hook execution order

### Documentation

- Hook configuration schema MUST be documented with examples
- Hook template library MUST include usage instructions
- Troubleshooting guide for common hook failures

---

## Technical Design

### Configuration Schema

Location: `.claude/hooks.json` or `.agents/hooks/config.json`

```json
{
  "hooks": {
    "session-start": [
      {
        "name": "Initialize Serena",
        "type": "script",
        "path": ".agents/hooks/scripts/Initialize-Serena.ps1",
        "async": false,
        "timeout": 30,
        "enabled": true
      },
      {
        "name": "Load HANDOFF context",
        "type": "script",
        "path": ".agents/hooks/scripts/Load-HandoffContext.ps1",
        "async": false,
        "timeout": 10,
        "enabled": true
      },
      {
        "name": "Create session log",
        "type": "script",
        "path": ".agents/hooks/scripts/New-SessionLog.ps1",
        "async": false,
        "timeout": 5,
        "enabled": true
      }
    ],
    "session-end": [
      {
        "name": "Update HANDOFF",
        "type": "script",
        "path": ".agents/hooks/scripts/Update-Handoff.ps1",
        "async": false,
        "timeout": 10,
        "enabled": true
      },
      {
        "name": "Run markdown lint",
        "type": "inline",
        "command": "npx markdownlint-cli2 --fix '**/*.md'",
        "async": false,
        "timeout": 60,
        "enabled": true
      },
      {
        "name": "Commit changes",
        "type": "script",
        "path": ".agents/hooks/scripts/Commit-SessionChanges.ps1",
        "async": false,
        "timeout": 30,
        "enabled": true
      }
    ],
    "pre-task": [
      {
        "name": "Load relevant memories",
        "type": "script",
        "path": ".agents/hooks/scripts/Load-TaskMemories.ps1",
        "async": true,
        "timeout": 15,
        "enabled": true
      }
    ],
    "post-task": [
      {
        "name": "Store learnings",
        "type": "script",
        "path": ".agents/hooks/scripts/Store-TaskLearnings.ps1",
        "async": true,
        "timeout": 15,
        "enabled": true
      }
    ]
  }
}
```

### Directory Structure

```text
.agents/
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ config.json           # Hook configuration
‚îÇ   ‚îú‚îÄ‚îÄ scripts/              # Hook script implementations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Initialize-Serena.ps1
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Load-HandoffContext.ps1
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ New-SessionLog.ps1
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Update-Handoff.ps1
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Commit-SessionChanges.ps1
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Load-TaskMemories.ps1
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Store-TaskLearnings.ps1
‚îÇ   ‚îî‚îÄ‚îÄ templates/            # Reusable hook templates
‚îÇ       ‚îú‚îÄ‚îÄ blocking-gate.ps1
‚îÇ       ‚îî‚îÄ‚îÄ async-operation.ps1
‚îî‚îÄ‚îÄ ...
```

---

## Implementation Plan

### Prerequisites

1. ADR-005 (PowerShell-only) applies to all hook scripts
2. ADR-006 (thin workflows) applies to hook configuration
3. SESSION-PROTOCOL.md requirements define what hooks must accomplish

### Phase 1: Foundation (READY)

**Duration**: 2-3 sessions
**Outcome**: Session hooks executing automatically

1. Create `.agents/hooks/` directory structure
2. Define hook configuration schema (JSON)
3. Implement hook execution engine (`Invoke-LifecycleHook`)
4. Create session-start hooks
5. Create session-end hooks
6. Create Pester tests for all hooks (80%+ coverage)
7. Integrate with agent runtime

### Decision Tree

```text
Is Phase 1 complete?
‚îú‚îÄ‚îÄ YES ‚Üí Proceed to Phase 2
‚îî‚îÄ‚îÄ NO ‚Üí Complete Phase 1 first

Is task boundary detection defined?
‚îú‚îÄ‚îÄ YES ‚Üí Implement task hooks
‚îî‚îÄ‚îÄ NO ‚Üí Execute Discovery: Task Boundary Analysis
         ‚îî‚îÄ‚îÄ Return to decision tree

Are edit hooks required for MVP?
‚îú‚îÄ‚îÄ YES ‚Üí Execute Discovery: File Interception
‚îî‚îÄ‚îÄ NO ‚Üí Mark Phase 4-5 as Future Work
```

---

## Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Hook execution slows session startup | Medium | Medium | Timeout protection, async execution for non-blocking hooks |
| Hook failures cascade to session failure | Medium | High | Graceful degradation with logging, no hard failures |
| Agent runtime lacks hook integration points | Medium | High | Design hooks as standalone scripts callable externally first |
| Edit hooks require unavailable capabilities | High | Medium | Defer Phase 4-5 to future work, focus on Phase 1-3 |

---

## Success Metrics

| Metric | Target |
|--------|--------|
| Session protocol compliance rate | Greater than 95% (up from less than 70% trust-based) |
| HANDOFF.md update frequency | 100% of sessions |
| Session log creation rate | 100% of sessions |
| Hook execution success rate | Greater than 99% |

---

## Blocking Questions

### Question 1: Agent Runtime Integration (CRITICAL)

**Question**: How does the hook execution engine integrate with Claude Code, VS Code, and GitHub Copilot CLI runtimes?

**Context**: Each platform has different execution models. Hook integration may require platform-specific adapters.

**Proposed Ask**: Research each platform's extension/customization points for pre/post session automation.

**Impact if unanswered**: Phase 1 implementation may produce hooks that only work in specific environments.

### Question 2: claude-flow Reference (CRITICAL)

**Question**: Can the issue author provide access to claude-flow wiki page 8.2 or summarize the hook implementation details?

**Context**: The issue references claude-flow as the exemplar but provides no implementation details.

**Proposed Ask**: Request issue author to share claude-flow hook documentation or implementation examples.

**Impact if unanswered**: Implementation will proceed without reference implementation, increasing design risk.

---

## Open Questions (Non-Blocking)

1. **Q**: Should hook configuration live in `.claude/` (platform-specific) or `.agents/` (cross-platform)?
   - **Hypothesis**: `.agents/hooks/` for cross-platform hooks with platform adapters
   - **Status**: Would be validated by Phase 1 implementation

2. **Q**: What is the appropriate timeout for session-end hooks that include git operations?
   - **Hypothesis**: 60-90 seconds to allow for large commits
   - **Status**: Would be validated by empirical testing

---

## Appendices

### Appendix A: Research Sources

| Source | Type | URL/Location |
|--------|------|--------------|
| SESSION-PROTOCOL.md | Primary | `.agents/SESSION-PROTOCOL.md` |
| Session 15 Retrospective | Primary | `.agents/retrospective/2025-12-18-session-15-retrospective.md` |
| ADR-005 | Primary | `.agents/architecture/ADR-005-powershell-only-scripting.md` |
| ADR-006 | Primary | `.agents/architecture/ADR-006-thin-workflows-testable-modules.md` |
| claude-flow Hooks | Reference | Issue mentions wiki page 8.2 (not accessed) |

### Appendix B: Hook Type Reference

| Hook Type | Trigger | Typical Actions |
|-----------|---------|-----------------|
| session-start | Session begins | Serena init, HANDOFF read, session log creation |
| session-end | Session closes | HANDOFF update, lint, commit |
| session-restore | Resume from checkpoint | Load checkpoint state |
| pre-task | Before task execution | Load memories, spawn helpers |
| post-task | After task completion | Store learnings, update metrics |
| agent-spawned | MCP agent created | Update roster |
| task-orchestrated | Task routed | Monitor progress |
| pre-edit | Before file modification | Syntax validation, backup |
| post-edit | After file modification | Context storage, notify |
| modify-git-commit | Git commit message | Add conventional prefix |
| modify-file | File content | Format hints, protection |

---

<sub>üìã Generated by [AI PRD Generation](https://github.com/rjmurillo/ai-agents) ¬∑ [View Workflow](https://github.com/rjmurillo/ai-agents/actions/runs/20393497848)</sub>



### Comment by @github-actions on 12/20/2025 11:13:12

<!-- AI-ISSUE-TRIAGE -->

## AI Triage Summary

> [!NOTE]
> This issue has been automatically triaged by AI agents

<details>
<summary>What is AI Triage?</summary>

This issue was analyzed by AI agents:

- **Analyst Agent**: Categorizes the issue and suggests appropriate labels
- **Roadmap Agent**: Aligns the issue with project milestones and priorities
- **Explainer Agent** (if escalated): Generates comprehensive PRD

</details>

### Triage Results

| Property | Value |
|:---------|:------|
| **Category** | `enhancement` |
| **Labels** | enhancement area-infrastructure |
|  **Priority** | `P2` |
| **Milestone** | v1.2 |
| **PRD Escalation** | Generated (see below) |

<details>
<summary>Categorization Analysis</summary>

```json
```json
{
  "labels": ["enhancement", "area-infrastructure"],
  "category": "enhancement",
  "confidence": 0.92,
  "reasoning": "Issue proposes a new lifecycle hooks system for session automation, which is a feature enhancement to the infrastructure/configuration layer"
}
```

```

</details>

<details>
<summary>Roadmap Alignment</summary>

```json
Based on the roadmap analysis, this issue proposes a lifecycle hooks system for session automation, which:

1. **Feature Request**: New capability, not a bug fix
2. **Multi-Phase Work**: 5 distinct hook categories (session, task, edit, MCP integration, modification)
3. **Architectural Impact**: Affects agent coordination patterns and session protocol enforcement
4. **Research Required**: References external claude-flow architecture (wiki page 8.2)

The issue aligns conceptually with improving agent coordination but no existing epic covers automation/hooks infrastructure.

```json
{
  "milestone": "v1.2",
  "priority": "P2",
  "epic_alignment": "",
  "confidence": 0.7,
  "reasoning": "Significant feature with architectural impact; not blocking v1.1 goals but valuable for maintainability",
  "escalate_to_prd": true,
  "escalation_criteria": ["feature_request", "multi_phase_work", "architectural_impact", "research_required"],
  "complexity_score": 10
}
```

```

</details>

---

<sub>Powered by [AI Issue Triage](https://github.com/rjmurillo/ai-agents) - [View Workflow](https://github.com/rjmurillo/ai-agents/actions/runs/20393497848)</sub>


