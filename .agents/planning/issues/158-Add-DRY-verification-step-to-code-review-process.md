---
number: 158
title: "Add DRY verification step to code review process"
state: OPEN
created_at: 12/20/2025 10:18:28
author: rjmurillo-bot
labels: ["documentation", "enhancement"]
assignees: []
milestone: null
url: https://github.com/rjmurillo/ai-agents/issues/158
---

# Add DRY verification step to code review process

## Problem

PR #147 introduced code that duplicated functionality already present in GitHubHelpers.psm1. Neither the AI review agents nor the manual review process caught these DRY violations before maintainer review.

## Current State

No agent is explicitly tasked with checking for code duplication against existing modules before approving new code.

## Proposed Solution

Add DRY verification as an explicit step in the review process. Options:

### Option A: Enhance Analyst Agent

Add to analyst.md:

```markdown
## DRY Verification Checklist

When reviewing new code:
- [ ] List all new functions/classes being added
- [ ] Search codebase for similar functionality
- [ ] Check shared modules: GitHubHelpers.psm1, AIReviewCommon.psm1
- [ ] Flag any duplication for resolution before approval
```

### Option B: Add to Implementer Agent (Pre-Implementation)

Add to implementer.md:

```markdown
## Before Writing New Functions

- [ ] Search for existing helpers that provide similar functionality
- [ ] Check relevant shared modules before writing new code
- [ ] Prefer extending existing helpers over creating new ones
```

### Option C: New Review Agent

Create a dedicated code-reviewer agent focused on code quality (DRY, cohesion, complexity).

## Evidence

PR #147 duplicated:
- Error handling patterns (lines 155, 176) that exist in GitHubHelpers.psm1
- API helper patterns (lines 476, 505) that should be in shared modules

## Related

- Skill-Review-002: Check for DRY violations
- PR #147 review failure retrospective

---

Generated with [Claude Code](https://claude.com/claude-code)

---

## Comments

### Comment by @coderabbitai on 12/20/2025 10:19:45

<!-- This is an auto-generated issue plan by CodeRabbit -->


### üìù CodeRabbit Plan Mode
Generate an implementation plan and prompts that you can use with your favorite coding agent.

- [ ] <!-- {"checkboxId": "8d4f2b9c-3e1a-4f7c-a9b2-d5e8f1c4a7b9"} --> Create Plan

<details>
<summary>Examples</summary>

- [Example 1](https://github.com/coderabbitai/git-worktree-runner/issues/29#issuecomment-3589134556)
- [Example 2](https://github.com/coderabbitai/git-worktree-runner/issues/12#issuecomment-3606665167)

</details>

---

<details>
<summary><b>üîó Similar Issues</b></summary>

**Related Issues**
- https://github.com/rjmurillo/ai-agents/issues/65
- https://github.com/rjmurillo/ai-agents/issues/124
- https://github.com/rjmurillo/ai-agents/issues/2
- https://github.com/rjmurillo/ai-agents/issues/77
</details>
<details>
<summary><b>üîó Related PRs</b></summary>

rjmurillo/vs-code-agents#1 - feat: Add customized multi-agent system for VS Code and Claude Code [merged]
rjmurillo/vs-code-agents#11 - feat: achieve Claude agent parity with VS Code agents [merged]
rjmurillo/ai-agents#20 - feat: Phase 2 CWE-78 Incident Remediation - Operational Capabilities [merged]
rjmurillo/ai-agents#76 - fix(workflows): strengthen AI review rigor and enable PR gating [merged]
rjmurillo/ai-agents#100 - fix(ci): ensure Pester Tests workflow satisfies required checks for all PRs [closed]
</details>
<details>
<summary><b>üë§ Suggested Assignees</b></summary>

- [rjmurillo-bot](https://github.com/rjmurillo-bot)
- [rjmurillo](https://github.com/rjmurillo)
- [coderabbitai](https://github.com/coderabbitai)
</details>


---
<details>
<summary> üß™ Issue enrichment is currently in open beta.</summary>


You can configure auto-planning by selecting labels in the issue_enrichment configuration.

To disable automatic issue enrichment, add the following to your `.coderabbit.yaml`:
```yaml
issue_enrichment:
  auto_enrich:
    enabled: false
```
</details>

üí¨ Have feedback or questions? Drop into our [discord](https://discord.gg/coderabbit) or [schedule a call](https://calendly.com/parth-coderabbit/issues-feedback)!

### Comment by @github-actions on 12/20/2025 10:22:22

<!-- AI-PRD-GENERATION -->

## üìã Product Requirements Document

> [!IMPORTANT]
> This PRD was automatically generated based on issue triage escalation.
> **Complexity Score**: 7/12 ()
> **Escalation Criteria**: feature_request, multi_phase_work, research_required

<details>
<summary>üìñ About this PRD</summary>

This PRD was generated by the **Explainer Agent** after the issue was flagged
for detailed analysis. The document is designed to be self-contained - it can
be passed to a separate AI agent instance for implementation without additional
context.

**PRD Depth Levels**:
- **Standard** (4-6): Brief analysis, clear requirements
- **Detailed** (7-9): Research section, blocking questions
- **Comprehensive** (10-12): Phased implementation, risk analysis

</details>

---

Let me view a skill file to understand the existing skill format, and check if there are any existing review-related patterns.

Now let me check for any existing skill related to reviews or DRY violations.

Based on my research, I have sufficient context to write the PRD. This issue has a complexity score around 5-6 (moderate enhancement with clear options). Let me create a comprehensive PRD.

The directory may not exist or have permissions issues. Let me output the PRD directly since I cannot write to the file system.

---

# PRD: Add DRY Verification Step to Code Review Process

## Executive Summary

PR #147 introduced duplicate code that existed in shared modules (GitHubHelpers.psm1, AIReviewCommon.psm1). No agent or manual review caught these DRY violations before maintainer review. This PRD evaluates three options to add explicit DRY verification to the review workflow.

| Scope | Status | Blocker |
|-------|--------|---------|
| DRY checklist for existing agent | :green_circle: READY | None |
| Agent prompt updates | :green_circle: READY | None |
| New reviewer agent (Option C) | :yellow_circle: PARTIAL | Requires architect input on agent proliferation |

**Verdict**: READY for Phase 1 (Options A and B). Option C requires architectural decision.

## Problem Statement

### Current State

| Agent | DRY Verification | Shared Module Awareness |
|-------|------------------|------------------------|
| analyst | None | None |
| implementer | "Follow DRY" principle stated | No explicit search step |
| critic | Reviews plans, not code | N/A |
| qa | Verifies tests, not duplication | N/A |

### Gap Analysis

1. **No pre-implementation search step**: Implementer agent instructions say "follow DRY" but provide no concrete checklist to search existing modules before writing new code.
2. **No post-implementation verification**: No agent explicitly reviews new code for duplication against shared modules.
3. **Shared module catalog missing**: No authoritative list of shared modules and their capabilities exists for agents to reference.

### User Impact

| User | Impact |
|------|--------|
| Maintainers | Increased review burden catching duplications manually |
| Contributors | Wasted effort writing code that already exists |
| Codebase | Technical debt accumulation from scattered implementations |

## Research Findings

### Primary Sources

**Source**: implementer.md (lines 258-259)

```markdown
**Non-Redundancy**: DRY applies to state, functions, relationships, designs, construction.
```

**Confidence**: CONFIRMED. Principle is stated but no actionable checklist exists.

**Source**: analyst.md

Analyst agent focuses on research and investigation but has no code duplication analysis capability defined.

**Confidence**: CONFIRMED. No DRY-related responsibilities in analyst agent.

**Source**: critic.md

Critic reviews plans and architecture alignment. Does not review implementation code.

**Confidence**: CONFIRMED. Critic scope excludes code review.

### Secondary Sources

**Source**: .agents/skills/documentation.md (Skill-Doc-009)

```markdown
Validate implementation plans with critic review before execution
```

**Confidence**: CONFIRMED. Existing pattern for pre-implementation validation exists.

**Source**: PR #147 review (issue body)

```text
PR #147 duplicated:
- Error handling patterns (lines 155, 176) that exist in GitHubHelpers.psm1
- API helper patterns (lines 476, 505) that should be in shared modules
```

**Confidence**: CONFIRMED. Specific evidence of duplication that passed review.

### Empirical Data

| Shared Module | Location | Purpose |
|---------------|----------|---------|
| GitHubHelpers.psm1 | scripts/lib/ | GitHub API operations, error handling |
| AIReviewCommon.psm1 | scripts/lib/ | AI review shared utilities |

## Proposed Solution

### Phase 1: Enhance Existing Agents (Status: READY)

**Estimated Effort**: S (2-4 hours)
**Blockers**: None

| Task | Description |
|------|-------------|
| 1.1 | Add DRY verification checklist to implementer.md |
| 1.2 | Add shared module awareness section to implementer.md |
| 1.3 | Add code duplication analysis capability to analyst.md |
| 1.4 | Create shared-modules.md catalog in .agents/steering/ |

### Phase 2: Create Review Skill (Status: READY)

**Estimated Effort**: S (1-2 hours)
**Blockers**: None

| Task | Description |
|------|-------------|
| 2.1 | Add Skill-Review-002 to skillbook for DRY verification |
| 2.2 | Document anti-pattern for duplication in skillbook |

### Phase 3: New Code Reviewer Agent (Status: DEPENDS)

**Estimated Effort**: M (4-8 hours)
**Blockers**: Architect decision on agent proliferation

| Task | Description |
|------|-------------|
| 3.1 | Create code-reviewer.md agent (if approved) |
| 3.2 | Define code quality scope: DRY, cohesion, complexity |
| 3.3 | Add to orchestrator routing table |

## Functional Requirements

### FR-1: Pre-Implementation DRY Check

**Priority**: P0

| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| FR-1.1 | Implementer must search for existing helpers before writing new functions | Checklist item exists in implementer.md |
| FR-1.2 | Implementer must check shared modules explicitly | List of shared modules provided in prompt |
| FR-1.3 | Implementer must document search results | Implementation notes include search findings |

### FR-2: Shared Module Catalog

**Priority**: P1

| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| FR-2.1 | Maintain catalog of shared modules | shared-modules.md exists in .agents/steering/ |
| FR-2.2 | Catalog includes module capabilities | Each module lists exported functions |
| FR-2.3 | Agents reference catalog before implementation | Implementer instructions reference catalog |

### FR-3: Post-Implementation Duplication Detection

**Priority**: P1

| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| FR-3.1 | Analyst can perform duplication analysis | Capability added to analyst.md |
| FR-3.2 | Analysis lists new functions being added | Analysis output includes function inventory |
| FR-3.3 | Analysis flags similarity to existing code | Grep/search commands documented |

## Non-Functional Requirements

### Consistency

- DRY checklist format follows existing checklist patterns in agent prompts
- Shared module catalog follows steering document format

### Testability

- Verify implementer.md contains DRY checklist section
- Verify shared-modules.md exists and lists modules
- Verify analyst.md includes duplication analysis capability

### Documentation

- Update AGENTS.md if new agent created (Phase 3)
- Add skill to .agents/skills/code-quality.md

## Technical Design

### implementer.md Changes

Add after Key Responsibilities section:

```markdown
## Before Writing New Functions

Execute this checklist before creating new code:

- [ ] Search codebase for similar functionality: `grep -r "function pattern" scripts/`
- [ ] Check shared modules explicitly:
  - scripts/lib/GitHubHelpers.psm1 (GitHub API, error handling)
  - scripts/lib/AIReviewCommon.psm1 (AI review utilities)
- [ ] Prefer extending existing helpers over creating new ones
- [ ] If duplication unavoidable, document justification

**Reference**: .agents/steering/shared-modules.md for full module catalog
```

### analyst.md Changes

Add to Analysis Types section:

```markdown
### Code Duplication Analysis

When reviewing new code submissions or investigating code quality:

- [ ] List all new functions/classes being added
- [ ] Search codebase for similar functionality
- [ ] Check shared modules: GitHubHelpers.psm1, AIReviewCommon.psm1
- [ ] Flag any duplication for resolution before approval

**Output Format**:

| New Function | Similar Existing | Location | Action |
|--------------|------------------|----------|--------|
| [Name] | [Existing name] | [Path] | [Refactor/Keep/Merge] |
```

### shared-modules.md (New File)

Create at `.agents/steering/shared-modules.md`:

```markdown
# Shared Modules Catalog

## Purpose

Authoritative list of shared modules for DRY verification during implementation.

## Modules

### GitHubHelpers.psm1

**Location**: scripts/lib/GitHubHelpers.psm1

**Capabilities**:

- GitHub API operations (issues, PRs, comments)
- Error handling patterns
- Rate limiting helpers
- Authentication utilities

**When to Use**: Any GitHub CLI or API interaction.

### AIReviewCommon.psm1

**Location**: scripts/lib/AIReviewCommon.psm1

**Capabilities**:

- AI review utilities
- Common review patterns
- Shared constants

**When to Use**: AI-powered review operations.

## Adding New Shared Code

Before creating new shared modules:

1. Check if functionality fits existing module
2. Prefer extending over creating
3. Document in this catalog when adding new modules
```

## Implementation Plan

### Prerequisites

- Access to src/claude/implementer.md
- Access to src/claude/analyst.md
- Access to .agents/steering/ directory

### Decision Tree

```text
Start
‚îú‚îÄ‚îÄ Phase 1: Update existing agents
‚îÇ   ‚îú‚îÄ‚îÄ 1.1 Add DRY checklist to implementer.md
‚îÇ   ‚îú‚îÄ‚îÄ 1.2 Add duplication analysis to analyst.md
‚îÇ   ‚îî‚îÄ‚îÄ 1.3 Create shared-modules.md
‚îÇ
‚îú‚îÄ‚îÄ Phase 2: Add skill documentation
‚îÇ   ‚îî‚îÄ‚îÄ 2.1 Create Skill-Review-002
‚îÇ
‚îî‚îÄ‚îÄ Phase 3: New agent decision?
    ‚îú‚îÄ‚îÄ YES (architect approves)
    ‚îÇ   ‚îî‚îÄ‚îÄ Create code-reviewer.md
    ‚îî‚îÄ‚îÄ NO
        ‚îî‚îÄ‚îÄ Complete
```

### Tasks

**Phase 1** (Immediate):

1. Edit src/claude/implementer.md to add DRY verification checklist
2. Edit src/claude/analyst.md to add duplication analysis capability
3. Create .agents/steering/shared-modules.md catalog
4. Run markdownlint on changed files

**Phase 2** (After Phase 1):

1. Add Skill-Review-002 to .agents/skills/code-quality.md
2. Document Anti-Review-001 (shipping duplicate code)

**Phase 3** (If approved):

1. Create src/claude/code-reviewer.md
2. Update orchestrator.md routing table
3. Update AGENTS.md with new agent

### Outcomes

| Phase | Outcome |
|-------|---------|
| Phase 1 | Implementer has explicit DRY checklist; analyst can detect duplication |
| Phase 2 | Skill documentation captures learned pattern |
| Phase 3 | Dedicated agent for code quality (optional) |

## Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Checklist ignored by agents | Medium | Medium | Add to handoff validation checklist |
| Shared module catalog becomes stale | Medium | Low | Add maintenance reminder in catalog |
| Agent proliferation (Option C) | Low | Medium | Get architect approval before Phase 3 |
| Checklist adds overhead without value | Low | Low | Monitor for PR #147-type failures |

## Success Metrics

| Metric | Target |
|--------|--------|
| DRY violations caught before maintainer review | 100% reduction |
| PRs with duplicate code | 0 per quarter |
| Shared module usage | Increase vs direct implementation |

## Blocking Questions

None. All three options can proceed without external input.

## Open Questions (Non-Blocking)

1. **Q**: Should Phase 3 (new code-reviewer agent) proceed?
   - **Hypothesis**: Enhancing existing agents (Phase 1) sufficient for most cases
   - **Status**: Defer to architect during plan review

2. **Q**: What shared modules exist beyond the two identified?
   - **Hypothesis**: scripts/lib/ contains the primary shared modules
   - **Status**: Validated by checking scripts/lib/ directory

3. **Q**: Should DRY verification be added to critic agent?
   - **Hypothesis**: No. Critic reviews plans, not code. Keep scope clean.
   - **Status**: Validated by critic.md scope definition

## Appendices

### Appendix A: Research Sources

- src/claude/implementer.md (lines 258-259)
- src/claude/analyst.md (full file)
- src/claude/critic.md (scope definition)
- .agents/skills/documentation.md (Skill-Doc-009)
- Issue body (PR #147 evidence)

### Appendix B: File Changes Summary

| File | Change Type | Lines Changed |
|------|-------------|---------------|
| src/claude/implementer.md | Modify | +15 lines |
| src/claude/analyst.md | Modify | +20 lines |
| .agents/steering/shared-modules.md | Create | ~50 lines |
| .agents/skills/code-quality.md | Create/Modify | +30 lines |

### Appendix C: Related Issues

- PR #147: Duplicate code review failure
- Skill-Review-002: Check for DRY violations (to be created)

---

**Note**: Could not save PRD to `.agents/planning/PRD-dry-verification-review-process.md` due to permission restrictions. Copy this document to that location when implementing.

---

<sub>üìã Generated by [AI PRD Generation](https://github.com/rjmurillo/ai-agents) ¬∑ [View Workflow](https://github.com/rjmurillo/ai-agents/actions/runs/20392962841)</sub>



### Comment by @github-actions on 12/20/2025 10:22:24

<!-- AI-ISSUE-TRIAGE -->

## AI Triage Summary

> [!NOTE]
> This issue has been automatically triaged by AI agents

<details>
<summary>What is AI Triage?</summary>

This issue was analyzed by AI agents:

- **Analyst Agent**: Categorizes the issue and suggests appropriate labels
- **Roadmap Agent**: Aligns the issue with project milestones and priorities
- **Explainer Agent** (if escalated): Generates comprehensive PRD

</details>

### Triage Results

| Property | Value |
|:---------|:------|
| **Category** | `enhancement` |
| **Labels** | enhancement agent-analyst agent-implementer area-prompts |
|  **Priority** | `P1` |
| **Milestone** | v1.1 |
| **PRD Escalation** | Generated (see below) |

<details>
<summary>Categorization Analysis</summary>

```json
```json
{
  "labels": ["enhancement", "agent-analyst", "agent-implementer", "area-prompts"],
  "category": "enhancement",
  "confidence": 0.9,
  "reasoning": "Issue proposes adding DRY verification steps to analyst and implementer agent prompts to prevent code duplication in reviews"
}
```

```

</details>

<details>
<summary>Roadmap Alignment</summary>

```json
```json
{
  "milestone": "v1.1",
  "priority": "P1",
  "epic_alignment": "",
  "confidence": 0.70,
  "reasoning": "Process improvement for code review quality aligns with v1.1 maintainability focus; not blocking core functionality but high value for preventing duplicate PRs",
  "escalate_to_prd": true,
  "escalation_criteria": ["feature_request", "multi_phase_work", "research_required"],
  "complexity_score": 7
}
```

```

</details>

---

<sub>Powered by [AI Issue Triage](https://github.com/rjmurillo/ai-agents) - [View Workflow](https://github.com/rjmurillo/ai-agents/actions/runs/20392962841)</sub>


