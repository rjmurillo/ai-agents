# Session 136: Security Fix for Claude Workflow Author Association

**Date**: 2026-01-04
**Branch**: `fix/claude-workflow-oidc-permission`
**Related Issue**: Security review comment
**Session Type**: Security Fix

## Objectives

Implement security fix for `.github/workflows/claude.yml` to restrict comment-triggered workflow runs to trusted author associations.

## Security Issue

**Finding**: Comment-triggered workflow runs with write scopes and secrets without restricting author association, enabling untrusted commenters to invoke it.

**Risk**: Malicious actors could trigger the workflow via comments on public issues/PRs, potentially:
- Exposing secrets
- Executing arbitrary code with write permissions
- Modifying repository contents

## Implementation

### Changes Required

1. Add `if` condition on job to restrict author association to trusted roles:
   - `MEMBER`
   - `OWNER`
   - `COLLABORATOR`

2. Replace `allowed_bots: "*"` with specific allowlist of trusted bots

### Current State

```yaml
permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  claude-response:
    runs-on: ubuntu-latest
    steps:
      - uses: anthropics/claude-code-action@7145c3e0510bcdbdd29f67cc4a8c1958f1acfa2f
        with:
          allowed_bots: "*"  # SECURITY ISSUE
```

### Target State

```yaml
jobs:
  claude-response:
    runs-on: ubuntu-latest
    if: |
      github.event.comment.author_association == 'MEMBER' ||
      github.event.comment.author_association == 'OWNER' ||
      github.event.comment.author_association == 'COLLABORATOR'
    steps:
      - uses: anthropics/claude-code-action@7145c3e0510bcdbdd29f67cc4a8c1958f1acfa2f
        with:
          allowed_bots: "dependabot[bot],renovate[bot]"
```

## Decisions

1. **Author Association Check**: Add at job level (not step level) to skip entire job for untrusted users
2. **Trusted Roles**: `MEMBER`, `OWNER`, `COLLABORATOR` (excludes `CONTRIBUTOR`, `FIRST_TIME_CONTRIBUTOR`, `NONE`)
3. **Bot Allowlist**: Replace wildcard with specific trusted bots (TBD based on repository needs)

## Outcomes

- [x] Workflow restricted to trusted author associations
- [x] Bot allowlist replaced with specific bots: `dependabot[bot]`, `renovate[bot]`, `github-actions[bot]`
- [x] Security review comment addressed

## Implementation Details

Added job-level conditional to `.github/workflows/claude.yml`:

```yaml
if: |
  github.event_name == 'issues' ||
  github.event_name == 'pull_request_review' ||
  github.event.comment.author_association == 'MEMBER' ||
  github.event.comment.author_association == 'OWNER' ||
  github.event.comment.author_association == 'COLLABORATOR'
```

This ensures:
1. `issues` and `pull_request_review` events always run (no comments involved)
2. `issue_comment` and `pull_request_review_comment` events only run for trusted author associations
3. Untrusted commenters (`CONTRIBUTOR`, `FIRST_TIME_CONTRIBUTOR`, `NONE`) cannot trigger the workflow
4. Bot allowlist restricted to specific trusted bots instead of wildcard

## Session Protocol Compliance

- [x] Serena initialized
- [x] HANDOFF.md read
- [x] usage-mandatory memory read
- [x] Branch verified: `fix/claude-workflow-oidc-permission`
- [x] Session log created
- [x] Session log completed
- [x] Linting run (0 errors)
- [ ] Serena memory updated
- [ ] Changes committed
- [ ] Session validation run

## References

- Memory: `security-011-workflow-least-privilege`
- Memory: `security-infrastructure-review`
- [GitHub Actions Security Best Practices](https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions)
